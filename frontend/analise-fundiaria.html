<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise Fundi√°ria - COGEP</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- styles.css REMOVIDO para evitar conflitos com fullscreen -->
    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            height: 100% !important;
            overflow: hidden !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .analise-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            width: 100vw !important;
            height: 100vh !important;
            gap: 0;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
        }

        .sidebar {
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #e0e0e0;
            height: 100%;
        }

        .sidebar h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
            color: #333;
        }

        .map-container {
            position: relative !important;
            height: 100% !important;
            width: 100% !important;
            min-height: 100vh !important;
        }

        #map {
            width: 100% !important;
            height: 100% !important;
            min-height: 100vh !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .score-badge {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 20px;
            text-align: center;
        }

        .score-badge.baixo {
            background: #d4edda;
            color: #155724;
        }

        .score-badge.medio, .score-badge.m√©dio {
            background: #fff3cd;
            color: #856404;
        }

        .score-badge.alto {
            background: #f8d7da;
            color: #721c24;
        }

        .score-badge.critico, .score-badge.cr√≠tico {
            background: #dc3545;
            color: white;
        }

        .resultado-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .resultado-section h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .confrontante-item {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-left: 4px solid #28a745;
            border-radius: 4px;
            font-size: 13px;
        }

        .sobreposicao-item {
            padding: 10px;
            margin: 8px 0;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
            font-size: 13px;
        }

        #resultados {
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .map-legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 2px solid #333;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="analise-container">
        <div class="sidebar">
            <h1>üî¨ An√°lise Fundi√°ria</h1>
            <p style="font-size: 13px; color: #666; margin-bottom: 20px;">
                Sistema de detec√ß√£o de sobreposi√ß√µes e an√°lise de viabilidade
            </p>

            <!-- Se√ß√£o de Importa√ß√£o R√°pida -->
            <div style="background: #f0f8ff; border: 2px solid #007bff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #007bff;">
                    üì• Importar Nova Propriedade
                </h3>
                <p style="font-size: 11px; color: #666; margin-bottom: 10px;">
                    Arraste ou clique para adicionar KML/SHP/DXF/GeoJSON
                </p>

                <div id="quickUploadArea" style="
                    border: 2px dashed #007bff;
                    border-radius: 8px;
                    padding: 20px;
                    text-align: center;
                    background: white;
                    cursor: pointer;
                    transition: all 0.3s;
                ">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2em; color: #007bff; margin-bottom: 8px;"></i>
                    <p style="margin: 0; font-size: 12px; color: #666;">Clique ou arraste arquivo aqui</p>
                    <small style="font-size: 10px; color: #999;">KML, KMZ, SHP, DXF, GeoJSON</small>
                </div>

                <input type="file" id="quickFileInput" accept=".kml,.kmz,.shp,.zip,.dxf,.geojson,.json" style="display: none;">

                <div id="quickFileInfo" style="display: none; margin-top: 10px; padding: 8px; background: #e8f5e9; border-radius: 5px; font-size: 11px;">
                    <strong>üìÑ <span id="quickFileName"></span></strong>
                    <button onclick="clearQuickFile()" style="float: right; background: #dc3545; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">‚úï</button>
                </div>

                <input type="text" id="quickNomePropriedade" placeholder="Nome da propriedade"
                    style="width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;">

                <button onclick="importarPropriedadeRapido()" id="quickImportBtn" class="btn btn-primary"
                    style="width: 100%; margin-top: 8px; padding: 8px; font-size: 12px;" disabled>
                    üì• Importar e Adicionar ao Mapa
                </button>
            </div>

            <div class="form-group">
                <label>Selecionar Propriedade:</label>
                <select id="propriedadeSelect" class="form-control">
                    <option value="">Carregando...</option>
                </select>
            </div>

            <button onclick="executarAnalise()" class="btn btn-primary btn-block">
                üîç Executar An√°lise Completa
            </button>

            <!-- Bot√£o Download Camadas CAR -->
            <div style="margin-top: 15px; padding: 15px; background: #f0fff4; border: 2px solid #28a745; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #28a745;">
                    üåæ Camadas CAR
                </h4>
                <button onclick="baixarCamadasCAR()" id="btnBaixarCAR" class="btn btn-primary" style="width: 100%; background: #28a745; border: none; margin-bottom: 10px;" disabled>
                    üì• Baixar Todas as Camadas
                </button>
                <div id="carDownloadStatus" style="display: none; font-size: 11px; color: #666; margin-top: 5px;">
                    ‚è≥ Aguardando download...
                </div>
            </div>

            <!-- Controles de Camadas do Mapa -->
            <div id="controlesCAR" style="display: none; margin-top: 15px; padding: 15px; background: #fff; border: 2px solid #ddd; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #333;">
                    üó∫Ô∏è Camadas do Mapa
                </h4>

                <div style="margin-bottom: 15px;">
                    <strong style="font-size: 12px; color: #666;">Camadas Principais:</strong>
                    <label style="display: block; margin: 8px 0; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="layer-propriedade" checked onchange="toggleLayer('propriedade')">
                        üîµ Propriedade Principal
                    </label>
                    <label style="display: block; margin: 8px 0; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="layer-confrontantes" checked onchange="toggleLayer('confrontantes')">
                        üü° Confrontantes
                    </label>
                    <label style="display: block; margin: 8px 0; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="layer-sigef" checked onchange="toggleLayer('sigef')">
                        üü¢ SIGEF
                    </label>
                    <label style="display: block; margin: 8px 0; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="layer-sobreposicoes" checked onchange="toggleLayer('sobreposicoes')">
                        üî¥ Sobreposi√ß√µes
                    </label>
                </div>

                <hr style="margin: 15px 0; border: 1px solid #eee;">

                <div>
                    <strong style="font-size: 12px; color: #666;">Camadas CAR:</strong>
                    <label style="display: block; margin: 8px 0; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="layer-uso-solo" onchange="toggleLayer('uso_solo')">
                        üü§ Uso do Solo
                        <span class="layer-count" style="color: #999;">(0)</span>
                    </label>
                    <label style="display: block; margin: 8px 0; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="layer-hidrografia" onchange="toggleLayer('hidrografia')">
                        üîµ Hidrografia
                        <span class="layer-count" style="color: #999;">(0)</span>
                    </label>
                    <label style="display: block; margin: 8px 0; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="layer-reserva-legal" onchange="toggleLayer('reserva_legal')">
                        üü¢ Reserva Legal
                        <span class="layer-count" style="color: #999;">(0)</span>
                    </label>
                    <label style="display: block; margin: 8px 0; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="layer-vegetacao" onchange="toggleLayer('vegetacao_nativa')">
                        üå≥ Vegeta√ß√£o Nativa
                        <span class="layer-count" style="color: #999;">(0)</span>
                    </label>
                    <label style="display: block; margin: 8px 0; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="layer-app" onchange="toggleLayer('app')">
                        üõ°Ô∏è APP
                        <span class="layer-count" style="color: #999;">(0)</span>
                    </label>
                </div>
            </div>

            <div id="resultados" style="display:none;">
                <div class="resultado-section">
                    <h3>üìä Score de Viabilidade</h3>
                    <div id="scoreDisplay"></div>
                    <p id="recomendacao" style="margin-top:10px; font-size:13px;"></p>
                </div>

                <div class="resultado-section">
                    <h3>‚ö†Ô∏è Sobreposi√ß√µes</h3>
                    <div id="sobreposicoesDisplay"></div>
                </div>

                <div class="resultado-section">
                    <h3>üë• Confrontantes</h3>
                    <div id="confrontantesDisplay"></div>
                </div>

                <div class="resultado-section" style="border-left-color: #6c757d;">
                    <h3>üìÑ Gerar Relat√≥rios</h3>
                    <div style="display: grid; gap: 10px; margin-top: 10px;">
                        <button onclick="gerarRelatorioPDF()" class="btn btn-primary">
                            üìÑ An√°lise Completa (PDF)
                        </button>
                        <button onclick="gerarRelatorioConfrontantesPDF()" class="btn btn-primary">
                            üë• Confrontantes (PDF)
                        </button>
                        <button onclick="gerarRelatorioViabilidadePDF()" class="btn btn-primary">
                            ‚úÖ Viabilidade (PDF)
                        </button>
                        <button onclick="gerarRelatorioConfrontantesExcel()" class="btn btn-primary">
                            üìä Confrontantes (Excel)
                        </button>
                        <button onclick="gerarRelatorioConfrontantesCSV()" class="btn btn-primary">
                            üìã Confrontantes (CSV)
                        </button>
                        <button onclick="gerarRelatorioSobreposicoesExcel()" class="btn btn-primary">
                            ‚ö†Ô∏è Sobreposi√ß√µes (Excel)
                        </button>
                    </div>
                </div>

                <div class="resultado-section" style="border-left-color: #28a745;">
                    <h3>üó∫Ô∏è Exportar Dados Georeferenciados</h3>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        Formatos compat√≠veis com GIS (QGIS, ArcGIS, AutoCAD)
                    </p>
                    <div style="display: grid; gap: 10px; margin-top: 10px;">
                        <button onclick="exportarConfrontantesGeoJSON()" class="btn btn-primary" style="background: #28a745;">
                            üìç Confrontantes (GeoJSON)
                        </button>
                        <button onclick="exportarConfrontantesKML()" class="btn btn-primary" style="background: #28a745;">
                            üó∫Ô∏è Confrontantes (KML)
                        </button>
                        <button onclick="exportarConfrontantesShapefile()" class="btn btn-primary" style="background: #28a745;">
                            üì¶ Confrontantes (Shapefile)
                        </button>
                        <button onclick="exportarConfrontantesDXF()" class="btn btn-primary" style="background: #28a745;">
                            üìê Confrontantes (DXF)
                        </button>
                        <button onclick="exportarSobreposicoesGeoJSON()" class="btn btn-primary" style="background: #dc3545;">
                            ‚ö†Ô∏è Sobreposi√ß√µes (GeoJSON)
                        </button>
                        <button onclick="exportarSobreposicoesKML()" class="btn btn-primary" style="background: #dc3545;">
                            ‚ö†Ô∏è Sobreposi√ß√µes (KML)
                        </button>
                        <button onclick="exportarSobreposicoesShapefile()" class="btn btn-primary" style="background: #dc3545;">
                            ‚ö†Ô∏è Sobreposi√ß√µes (Shapefile)
                        </button>
                        <button onclick="exportarSobreposicoesDXF()" class="btn btn-primary" style="background: #dc3545;">
                            ‚ö†Ô∏è Sobreposi√ß√µes (DXF)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>

            <div class="map-legend">
                <strong style="display:block; margin-bottom:10px;">üó∫Ô∏è Controle de Camadas</strong>

                <!-- Propriedade Local -->
                <div class="legend-item" style="padding: 5px 0; cursor: pointer;" onclick="toggleLayer('propriedade')">
                    <input type="checkbox" id="layer-propriedade" checked onchange="toggleLayer('propriedade')" style="margin-right: 5px;">
                    <div class="legend-color" style="background:#007bff;opacity:0.3;"></div>
                    <span>Propriedade Analisada</span>
                </div>

                <!-- Sobreposi√ß√µes -->
                <div class="legend-item" style="padding: 5px 0; cursor: pointer;" onclick="toggleLayer('sobreposicoes')">
                    <input type="checkbox" id="layer-sobreposicoes" checked onchange="toggleLayer('sobreposicoes')" style="margin-right: 5px;">
                    <div class="legend-color" style="background:#FF0000;opacity:0.4;"></div>
                    <span>Sobreposi√ß√µes (Vermelho)</span>
                </div>

                <!-- Confrontantes -->
                <div class="legend-item" style="padding: 5px 0; cursor: pointer;" onclick="toggleLayer('confrontantes')">
                    <input type="checkbox" id="layer-confrontantes" checked onchange="toggleLayer('confrontantes')" style="margin-right: 5px;">
                    <div class="legend-color" style="background:#FFD700;opacity:0.3;"></div>
                    <span>Confrontantes (Dourado)</span>
                </div>

                <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">

                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    <strong>Dica:</strong> Clique nas camadas para mostrar/ocultar
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, propriedadeLayer, sigefLayer, conflitosLayer;
        let layerGroupsCAR = {};
        const API_BASE = 'http://localhost:3001/api';

        // Paleta de cores para camadas CAR
        const coresCAR = {
            uso_solo: '#8B4513',         // Marrom
            hidrografia: '#00BCD4',      // Azul √Ågua
            reserva_legal: '#2E7D32',    // Verde Escuro
            vegetacao_nativa: '#66BB6A', // Verde Claro
            app: '#FFC107'               // Amarelo
        };

        function initMap() {
            map = L.map('map').setView([-25.4284, -49.2733], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // Inicializar layer groups (adicionados ao mapa baseado nos checkboxes)
            propriedadeLayer = L.layerGroup();
            sigefLayer = L.layerGroup();
            conflitosLayer = L.layerGroup();

            // Adicionar ao mapa as camadas que est√£o marcadas por padr√£o
            propriedadeLayer.addTo(map);
            sigefLayer.addTo(map);
            conflitosLayer.addTo(map);

            // Inicializar layer groups para CAR (n√£o adicionados ao mapa por padr√£o)
            layerGroupsCAR = {
                uso_solo: L.layerGroup(),
                hidrografia: L.layerGroup(),
                reserva_legal: L.layerGroup(),
                vegetacao_nativa: L.layerGroup(),
                app: L.layerGroup()
            };

            // For√ßar redimensionamento ap√≥s 100ms
            setTimeout(() => {
                map.invalidateSize();
                console.log('‚úÖ Mapa redimensionado para fullscreen');
            }, 100);
        }

        // =====================================================
        // CONTROLE DE CAMADAS
        // =====================================================

        function toggleLayer(layerName) {
            const checkbox = document.getElementById(`layer-${layerName.replace('_', '-')}`);

            if (!checkbox) {
                console.warn(`‚ö†Ô∏è  Checkbox n√£o encontrado para camada: ${layerName}`);
                return;
            }

            switch(layerName) {
                case 'propriedade':
                    if (!propriedadeLayer) {
                        console.warn('‚ö†Ô∏è  propriedadeLayer n√£o inicializada');
                        return;
                    }
                    if (checkbox.checked) {
                        if (!map.hasLayer(propriedadeLayer)) {
                            propriedadeLayer.addTo(map);
                            console.log('‚úÖ Camada "Propriedade" ativada');
                        }
                    } else {
                        if (map.hasLayer(propriedadeLayer)) {
                            map.removeLayer(propriedadeLayer);
                            console.log('‚ùå Camada "Propriedade" desativada');
                        }
                    }
                    break;

                case 'confrontantes':
                case 'sigef':
                    if (!sigefLayer) {
                        console.warn('‚ö†Ô∏è  sigefLayer n√£o inicializada');
                        return;
                    }
                    if (checkbox.checked) {
                        if (!map.hasLayer(sigefLayer)) {
                            sigefLayer.addTo(map);
                            console.log('‚úÖ Camada "Confrontantes/SIGEF" ativada');
                        }
                    } else {
                        if (map.hasLayer(sigefLayer)) {
                            map.removeLayer(sigefLayer);
                            console.log('‚ùå Camada "Confrontantes/SIGEF" desativada');
                        }
                    }
                    break;

                case 'sobreposicoes':
                    if (!conflitosLayer) {
                        console.warn('‚ö†Ô∏è  conflitosLayer n√£o inicializada');
                        return;
                    }
                    if (checkbox.checked) {
                        if (!map.hasLayer(conflitosLayer)) {
                            conflitosLayer.addTo(map);
                            console.log('‚úÖ Camada "Sobreposi√ß√µes" ativada');
                        }
                    } else {
                        if (map.hasLayer(conflitosLayer)) {
                            map.removeLayer(conflitosLayer);
                            console.log('‚ùå Camada "Sobreposi√ß√µes" desativada');
                        }
                    }
                    break;

                // Camadas CAR
                case 'uso_solo':
                case 'hidrografia':
                case 'reserva_legal':
                case 'vegetacao_nativa':
                case 'app':
                    if (layerGroupsCAR[layerName]) {
                        if (checkbox.checked) {
                            if (!map.hasLayer(layerGroupsCAR[layerName])) {
                                layerGroupsCAR[layerName].addTo(map);
                                console.log(`‚úÖ Camada CAR "${layerName}" ativada`);
                            }
                        } else {
                            if (map.hasLayer(layerGroupsCAR[layerName])) {
                                map.removeLayer(layerGroupsCAR[layerName]);
                                console.log(`‚ùå Camada CAR "${layerName}" desativada`);
                            }
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è  Camada CAR "${layerName}" n√£o inicializada`);
                    }
                    break;

                default:
                    console.warn(`‚ö†Ô∏è  Camada desconhecida: ${layerName}`);
            }
        }

        // =====================================================
        // CARREGAMENTO DE DADOS
        // =====================================================

        async function carregarPropriedades() {
            try {
                console.log('üîç Carregando propriedades...');

                const response = await fetch(`${API_BASE}/propriedades/com-score`);

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const propriedades = await response.json();

                console.log('‚úÖ Propriedades recebidas:', propriedades);

                // Verificar se √© array
                if (!Array.isArray(propriedades)) {
                    console.error('‚ùå Resposta n√£o √© array:', propriedades);
                    throw new Error('Formato de resposta inv√°lido');
                }

                const select = document.getElementById('propriedadeSelect');
                select.innerHTML = '<option value="">Selecione uma propriedade...</option>';

                if (propriedades.length === 0) {
                    select.innerHTML += '<option value="" disabled>Nenhuma propriedade cadastrada</option>';
                    return;
                }

                propriedades.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.nome_propriedade} - ${p.municipio}/${p.uf}`;
                    select.appendChild(option);
                });

                console.log(`‚úÖ ${propriedades.length} propriedades carregadas`);

            } catch (error) {
                console.error('‚ùå Erro ao carregar propriedades:', error);
                const select = document.getElementById('propriedadeSelect');
                select.innerHTML = '<option value="" disabled>Erro ao carregar propriedades</option>';
            }
        }

        async function executarAnalise() {
            const propriedadeId = document.getElementById('propriedadeSelect').value;

            if (!propriedadeId) {
                alert('Selecione uma propriedade!');
                return;
            }

            document.getElementById('resultados').style.display = 'block';

            // Mostrar loading
            document.getElementById('scoreDisplay').innerHTML = '‚è≥ Analisando...';
            document.getElementById('sobreposicoesDisplay').innerHTML = '‚è≥ Verificando...';
            document.getElementById('confrontantesDisplay').innerHTML = '‚è≥ Identificando...';

            try {
                console.log(`üî¨ Iniciando an√°lise completa: Propriedade #${propriedadeId}`);

                const response = await fetch(`${API_BASE}/analise/completa/${propriedadeId}`, {
                    method: 'POST'
                });

                const resultado = await response.json();

                console.log('Resultado da an√°lise:', resultado);

                // Exibir score
                exibirScore(resultado.score);

                // Exibir sobreposi√ß√µes
                exibirSobreposicoes(resultado.sobreposicoes);

                // Exibir confrontantes
                exibirConfrontantes(resultado.confrontantes);

                // Carregar geometrias no mapa
                await carregarNoMapa(propriedadeId, resultado);

            } catch (error) {
                console.error('Erro na an√°lise:', error);
                alert('Erro ao executar an√°lise: ' + error.message);
            }
        }

        function exibirScore(score) {
            if (!score || !score.sucesso) {
                document.getElementById('scoreDisplay').innerHTML =
                    '<p style="color:red;">Erro ao calcular score</p>';
                return;
            }

            const nivel = score.nivel_risco.toLowerCase();
            const badgeClass = nivel === 'cr√≠tico' ? 'critico' : nivel;

            document.getElementById('scoreDisplay').innerHTML = `
                <div class="score-badge ${badgeClass}">
                    ${score.score_total}/100 - ${score.nivel_risco}
                </div>
                <div style="margin-top: 15px;">
                    <strong>Detalhes:</strong>
                    <ul style="margin-top: 10px; padding-left: 20px; font-size:13px;">
                        <li>Sobreposi√ß√µes: ${score.tem_sobreposicao ? '‚ö†Ô∏è SIM' : '‚úÖ N√ÉO'}</li>
                        <li>Quantidade: ${score.qtd_sobreposicoes || 0}</li>
                        <li>√Årea sobreposta: ${parseFloat(score.area_sobreposta_m2 || 0).toFixed(2)} m¬≤</li>
                        <li>Confrontantes: ${score.qtd_confrontantes || 0}</li>
                    </ul>
                </div>
            `;

            document.getElementById('recomendacao').innerHTML = `
                <strong>üìã Recomenda√ß√£o:</strong><br>
                ${score.recomendacao}
            `;
        }

        function exibirSobreposicoes(sobreposicoes) {
            const container = document.getElementById('sobreposicoesDisplay');

            if (!sobreposicoes || !sobreposicoes.sucesso || sobreposicoes.total_sobreposicoes === 0) {
                container.innerHTML = '<p style="color:green;">‚úÖ Nenhuma sobreposi√ß√£o detectada!</p>';
                return;
            }

            let html = `<p><strong>‚ö†Ô∏è ${sobreposicoes.total_sobreposicoes} sobreposi√ß√£o(√µes) encontrada(s)</strong></p>`;

            sobreposicoes.sobreposicoes.forEach((s, idx) => {
                const percentual = parseFloat(s.percentual_propriedade || 0).toFixed(1);
                const areaSobrep = parseFloat(s.area_sobreposicao_m2 || 0).toFixed(2);
                const areaTotal = s.area_total_sigef_ha ? parseFloat(s.area_total_sigef_ha).toFixed(2) + ' ha' : 'N/A';
                const tipoTexto = s.tipo_sobreposicao ? s.tipo_sobreposicao.replace(/_/g, ' ').toUpperCase() : 'N/A';

                html += `
                    <div class="sobreposicao-item">
                        <strong>Sobreposi√ß√£o #${idx + 1}</strong><br>
                        <small><strong>Propriet√°rio SIGEF:</strong> ${s.proprietario_sigef || 'N/A'}</small><br>
                        <small><strong>Tipo:</strong> ${tipoTexto}</small><br>
                        <small><strong>Matr√≠cula:</strong> ${s.matricula_sigef || 'N/A'}</small><br>
                        <small><strong>Munic√≠pio:</strong> ${s.municipio_sigef || 'N/A'}</small><br>
                        <small><strong>√Årea Total Parcela:</strong> ${areaTotal}</small><br>
                        <small><strong>√Årea Sobreposi√ß√£o:</strong> ${areaSobrep} m¬≤ (${percentual}%)</small><br>
                        <small><strong>C√≥digo SIGEF:</strong> ${s.codigo_parcela ? s.codigo_parcela.substring(0, 13) + '...' : 'N/A'}</small>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function exibirConfrontantes(confrontantes) {
            const container = document.getElementById('confrontantesDisplay');

            if (!confrontantes || !confrontantes.sucesso || confrontantes.total_confrontantes === 0) {
                container.innerHTML = '<p>‚ÑπÔ∏è Nenhum confrontante identificado no raio de 500m</p>';
                return;
            }

            // Totais por fonte
            const totalSIGEF = confrontantes.total_sigef || 0;
            const totalCAR = confrontantes.total_car || 0;

            let html = `
                <p><strong>üë• ${confrontantes.total_confrontantes} confrontante(s) identificado(s)</strong></p>
                <p style="font-size: 12px; margin-top: -8px;">
                    <span style="color: #FFD700;">üè¢ SIGEF: ${totalSIGEF}</span> |
                    <span style="color: #00FF00;">üåæ CAR: ${totalCAR}</span>
                </p>
            `;

            confrontantes.confrontantes.slice(0, 10).forEach((c, idx) => {
                const isSIGEF = !c.fonte || c.fonte === 'SIGEF';
                const isCAR = c.fonte === 'CAR';

                const icon = isSIGEF ? (c.tipo_contato === 'limite_comum' ? 'üîó' : 'üìç') : 'üåæ';
                const iconColor = isSIGEF ? '#FFD700' : '#00FF00';
                const fonteLabel = isSIGEF ? 'SIGEF' : 'CAR';

                const tipoTexto = isSIGEF
                    ? (c.tipo_contato === 'limite_comum' ? 'Limite Comum' : 'Pr√≥ximo')
                    : c.tipo_confrontacao || 'Pr√≥ximo';

                const area = c.area_ha ? parseFloat(c.area_ha).toFixed(2) + ' ha' : 'N/A';
                const azimute = (c.azimute || c.azimute_graus) ? parseFloat(c.azimute || c.azimute_graus).toFixed(1) + '¬∞' : 'N/A';

                html += `
                    <div class="confrontante-item" style="border-left: 3px solid ${iconColor};">
                        ${icon} <strong style="color: ${iconColor};">Confrontante #${idx + 1} [${fonteLabel}]</strong><br>
                        <small><strong>Propriet√°rio:</strong> ${c.proprietario || c.nome_proprietario || 'N/A'}</small><br>
                        <small><strong>Tipo:</strong> ${tipoTexto}</small><br>
                        ${isSIGEF && c.matricula ? `<small><strong>Matr√≠cula:</strong> ${c.matricula}</small><br>` : ''}
                        ${isCAR && c.codigo_car ? `<small><strong>C√≥digo CAR:</strong> ${c.codigo_car.substring(0, 20)}...</small><br>` : ''}
                        <small><strong>Munic√≠pio:</strong> ${c.municipio || 'N/A'}</small><br>
                        <small><strong>√Årea:</strong> ${area}</small><br>
                        <small><strong>Dist√¢ncia:</strong> ${parseFloat(c.distancia_m || 0).toFixed(1)}m</small><br>
                        ${isSIGEF && parseFloat(c.comprimento_contato_m || 0) > 0 ? `<small><strong>Comprimento Contato:</strong> ${parseFloat(c.comprimento_contato_m).toFixed(1)}m</small><br>` : ''}
                        ${c.azimute || c.azimute_graus ? `<small><strong>Azimute:</strong> ${azimute}</small><br>` : ''}
                        ${isSIGEF && c.codigo_parcela ? `<small><strong>C√≥digo SIGEF:</strong> ${c.codigo_parcela.substring(0, 13)}...</small>` : ''}
                    </div>
                `;
            });

            if (confrontantes.total_confrontantes > 10) {
                html += `<p><small>+ ${confrontantes.total_confrontantes - 10} confrontantes n√£o exibidos</small></p>`;
            }

            container.innerHTML = html;
        }

        async function carregarNoMapa(propriedadeId, resultado) {
            try {
                console.log('üó∫Ô∏è Carregando geometrias no mapa...');

                // Limpar camadas
                propriedadeLayer.clearLayers();
                sigefLayer.clearLayers();
                conflitosLayer.clearLayers();

                // Carregar propriedade local
                const propResponse = await fetch(`${API_BASE}/propriedades/${propriedadeId}`);
                const propData = await propResponse.json();
                const propriedade = propData.data || propData; // Suportar ambos os formatos

                let propPolygon;
                if (propriedade.geojson) {
                    const geojson = JSON.parse(propriedade.geojson);

                    propPolygon = L.geoJSON(geojson, {
                        style: {
                            color: '#007bff',      // Azul para propriedade principal
                            weight: 4,
                            fillColor: '#007bff',
                            fillOpacity: 0.15
                        }
                    }).addTo(propriedadeLayer);

                    // Calcular per√≠metro da propriedade
                    let perimetro = 0;
                    if (geojson.type === 'Polygon' && geojson.coordinates && geojson.coordinates[0]) {
                        const coords = geojson.coordinates[0];
                        for (let i = 0; i < coords.length - 1; i++) {
                            const lat1 = coords[i][1];
                            const lng1 = coords[i][0];
                            const lat2 = coords[i + 1][1];
                            const lng2 = coords[i + 1][0];
                            perimetro += calcularDistanciaHaversine(lat1, lng1, lat2, lng2);
                        }
                    }

                    const areaHa = (propriedade.area_m2 || propriedade.area_calculada || 0) / 10000;

                    propPolygon.bindPopup(`
                        <div style="min-width: 250px;">
                            <strong style="font-size: 14px; color: #007bff;">üè† PROPRIEDADE ANALISADA</strong><br>
                            <hr style="margin: 8px 0;">
                            <strong>Nome:</strong> ${propriedade.nome_propriedade}<br>
                            <strong>Matr√≠cula:</strong> ${propriedade.matricula || 'N/A'}<br>
                            <strong>Munic√≠pio:</strong> ${propriedade.municipio}<br>
                            <strong>√Årea:</strong> ${areaHa.toFixed(4)} ha<br>
                            <strong>Per√≠metro:</strong> ${perimetro.toFixed(2)} m
                        </div>
                    `);
                }

                // Carregar √ÅREAS DE SOBREPOSI√á√ÉO (apenas a geometria da interse√ß√£o)
                if (resultado.sobreposicoes?.sobreposicoes && resultado.sobreposicoes.sobreposicoes.length > 0) {
                    console.log(`‚ö†Ô∏è  Carregando ${resultado.sobreposicoes.sobreposicoes.length} sobreposi√ß√£o(√µes)...`);
                    for (const s of resultado.sobreposicoes.sobreposicoes) {
                        // Renderizar apenas a geometria da interse√ß√£o (√°rea sobreposta)
                        renderizarSobreposicao(s);
                    }
                }

                // Carregar confrontantes com dados adicionais
                if (resultado.confrontantes?.confrontantes && resultado.confrontantes.confrontantes.length > 0) {
                    console.log(`üë• Carregando ${resultado.confrontantes.confrontantes.length} confrontante(s)...`);

                    // Separar confrontantes SIGEF e CAR
                    const confrontantesSIGEF = resultado.confrontantes.confrontantes.filter(c => !c.fonte || c.fonte === 'SIGEF');
                    const confrontantesCAR = resultado.confrontantes.confrontantes.filter(c => c.fonte === 'CAR');

                    console.log(`   üìä SIGEF: ${confrontantesSIGEF.length} | CAR: ${confrontantesCAR.length}`);

                    // Carregar confrontantes SIGEF (limite 20)
                    for (const c of confrontantesSIGEF.slice(0, 20)) {
                        await carregarParcelaSIGEF(c.parcela_sigef_id, 'confrontante', {
                            distancia_m: c.distancia_m,
                            tipo_contato: c.tipo_contato,
                            azimute: c.azimute,
                            comprimento_contato_m: c.comprimento_contato_m
                        });
                    }

                    // Carregar confrontantes CAR (limite 20)
                    for (const c of confrontantesCAR.slice(0, 20)) {
                        await carregarImovelCAR(c.codigo_car, {
                            distancia_m: c.distancia_m,
                            municipio: c.municipio,
                            area_ha: c.area_ha,
                            tipo_confrontacao: c.tipo_confrontacao
                        });
                    }
                }

                // ‚úÖ CENTRALIZAR AUTOMATICAMENTE NO MAPA
                if (propPolygon) {
                    console.log('üéØ Centralizando mapa na propriedade...');
                    map.fitBounds(propPolygon.getBounds(), {
                        padding: [100, 100],  // Padding maior para visualiza√ß√£o completa
                        maxZoom: 15           // Zoom m√°ximo para n√£o ficar muito pr√≥ximo
                    });
                }

                console.log('‚úÖ Mapa carregado com sucesso!');

            } catch (error) {
                console.error('‚ùå Erro ao carregar no mapa:', error);
            }
        }

        /**
         * Renderiza a √°rea de sobreposi√ß√£o (apenas a geometria da interse√ß√£o)
         * @param {Object} sobreposicao - Dados da sobreposi√ß√£o com geometria_intersecao
         */
        function renderizarSobreposicao(sobreposicao) {
            try {
                // Parse da geometria da interse√ß√£o (apenas √°rea sobreposta)
                const geojson = typeof sobreposicao.geometria_intersecao === 'string'
                    ? JSON.parse(sobreposicao.geometria_intersecao)
                    : sobreposicao.geometria_intersecao;

                // Estilo VERMELHO destacado para √°rea sobreposta
                const polygon = L.geoJSON(geojson, {
                    style: {
                        color: '#FF0000',        // Vermelho borda
                        weight: 4,               // Borda grossa
                        fillColor: '#FF0000',    // Vermelho preenchimento
                        fillOpacity: 0.5,        // Opacidade alta para destaque
                        dashArray: '10, 5'       // Tracejado para indicar conflito
                    }
                }).addTo(conflitosLayer);

                // Calcular per√≠metro da √°rea sobreposta
                let perimetro = 0;
                if (geojson.type === 'Polygon' && geojson.coordinates && geojson.coordinates[0]) {
                    const coords = geojson.coordinates[0];
                    for (let i = 0; i < coords.length - 1; i++) {
                        const lat1 = coords[i][1];
                        const lng1 = coords[i][0];
                        const lat2 = coords[i + 1][1];
                        const lng2 = coords[i + 1][0];
                        perimetro += calcularDistanciaHaversine(lat1, lng1, lat2, lng2);
                    }
                }

                // Popup detalhado da sobreposi√ß√£o
                const areaHa = (parseFloat(sobreposicao.area_sobreposicao_m2) / 10000).toFixed(4);
                const areaM2 = parseFloat(sobreposicao.area_sobreposicao_m2).toFixed(2);
                const areaParcela = parseFloat(sobreposicao.area_parcela_ha || 0).toFixed(2);

                const popupContent = `
                    <div style="min-width: 280px;">
                        <strong style="font-size: 14px; color: #FF0000;">‚ö†Ô∏è √ÅREA SOBREPOSTA</strong><br>
                        <hr style="margin: 8px 0;">
                        <strong>üìè Medidas da Sobreposi√ß√£o:</strong><br>
                        <strong>√Årea Sobreposta:</strong> ${areaHa} ha (${areaM2} m¬≤)<br>
                        <strong>Per√≠metro:</strong> ${perimetro.toFixed(2)} m<br>
                        <strong>Percentual da Prop.:</strong> ${parseFloat(sobreposicao.percentual_propriedade || 0).toFixed(1)}%<br>
                        <strong>Percentual SIGEF:</strong> ${parseFloat(sobreposicao.percentual_parcela || 0).toFixed(1)}%<br>
                        <strong>Tipo:</strong> ${sobreposicao.tipo_sobreposicao || 'N/A'}<br>
                        <hr style="margin: 8px 0;">
                        <strong>üìã Dados da Parcela SIGEF:</strong><br>
                        <strong>Propriet√°rio:</strong> ${sobreposicao.proprietario_sigef || 'N/A'}<br>
                        <strong>Munic√≠pio:</strong> ${sobreposicao.municipio_sigef || 'N/A'}<br>
                        <strong>√Årea Total SIGEF:</strong> ${areaParcela} ha<br>
                        <strong>Matr√≠cula:</strong> ${sobreposicao.matricula_sigef || 'N/A'}<br>
                        <strong>Situa√ß√£o:</strong> ${sobreposicao.situacao_parcela || 'N/A'}<br>
                        <strong>Certifica√ß√£o:</strong> ${sobreposicao.data_certificacao || 'N/A'}<br>
                        <strong>C√≥digo SIGEF:</strong> <small>${sobreposicao.codigo_parcela || 'N/A'}</small>
                    </div>
                `;

                polygon.bindPopup(popupContent);

            } catch (error) {
                console.error('Erro ao renderizar sobreposi√ß√£o:', error);
            }
        }

        async function carregarParcelaSIGEF(parcelaId, tipo, dadosAdicionais = {}) {
            try {
                const response = await fetch(`${API_BASE}/sigef/parcelas/${parcelaId}`);
                const parcela = await response.json();

                if (parcela.geometry) {
                    const geojson = typeof parcela.geometry === 'string'
                        ? JSON.parse(parcela.geometry)
                        : parcela.geometry;

                    // Cor DOURADA para confrontantes SIGEF
                    const cor = '#FFD700';
                    const fillOpacity = 0.2;
                    const weight = 3;

                    const polygon = L.geoJSON(geojson, {
                        style: {
                            color: cor,
                            weight: weight,
                            fillColor: cor,
                            fillOpacity: fillOpacity
                        }
                    }).addTo(sigefLayer);

                    // Calcular per√≠metro da geometria
                    let perimetro = 0;
                    if (geojson.type === 'Polygon' && geojson.coordinates && geojson.coordinates[0]) {
                        const coords = geojson.coordinates[0];
                        for (let i = 0; i < coords.length - 1; i++) {
                            const lat1 = coords[i][1];
                            const lng1 = coords[i][0];
                            const lat2 = coords[i + 1][1];
                            const lng2 = coords[i + 1][0];
                            perimetro += calcularDistanciaHaversine(lat1, lng1, lat2, lng2);
                        }
                    }

                    // Popup de confrontante SIGEF
                    const area = parseFloat(parcela.area_hectares || 0).toFixed(2);
                    const perimetroFormatado = perimetro > 0 ? perimetro.toFixed(2) : 'N/A';

                    let popupContent = `
                        <div style="min-width: 250px;">
                            <strong style="font-size: 14px; color: #FFD700;">üë• CONFRONTANTE SIGEF</strong><br>
                            <hr style="margin: 8px 0;">
                            <strong>Propriet√°rio:</strong> ${parcela.proprietario || 'N/A'}<br>
                            <strong>Munic√≠pio:</strong> ${parcela.municipio || 'N/A'}<br>
                            <strong>√Årea:</strong> ${area} ha<br>
                            <strong>Per√≠metro:</strong> ${perimetroFormatado} m<br>
                            <strong>Matr√≠cula:</strong> ${parcela.matricula || 'N/A'}<br>
                    `;

                    // Adicionar dados espec√≠ficos de confrontante
                    if (dadosAdicionais) {
                        if (dadosAdicionais.distancia_m !== undefined) {
                            popupContent += `<hr style="margin: 8px 0;">
                                <strong>Dist√¢ncia:</strong> ${parseFloat(dadosAdicionais.distancia_m).toFixed(2)} m<br>
                                <strong>Tipo Contato:</strong> ${dadosAdicionais.tipo_contato === 'limite_comum' ? 'üîó Limite Comum' : 'üìç Pr√≥ximo'}<br>
                            `;
                            if (dadosAdicionais.azimute) {
                                popupContent += `<strong>Azimute:</strong> ${parseFloat(dadosAdicionais.azimute).toFixed(1)}¬∞<br>`;
                            }
                        }
                    }

                    popupContent += `<strong>C√≥digo SIGEF:</strong> <small>${parcela.codigo_parcela || 'N/A'}</small>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                }

            } catch (error) {
                console.error(`Erro ao carregar parcela SIGEF ${parcelaId}:`, error);
            }
        }

        /**
         * Carrega im√≥vel CAR no mapa (confrontante)
         */
        async function carregarImovelCAR(codigoCAR, dadosAdicionais = {}) {
            try {
                const response = await fetch(`${API_BASE}/car/geometry/${encodeURIComponent(codigoCAR)}`);
                const imovel = await response.json();

                if (!imovel.success) {
                    console.warn(`CAR n√£o encontrado: ${codigoCAR}`);
                    return;
                }

                if (imovel.geometry) {
                    const geojson = typeof imovel.geometry === 'string'
                        ? JSON.parse(imovel.geometry)
                        : imovel.geometry;

                    // Cor VERDE para confrontantes CAR
                    const cor = '#00FF00';
                    const fillOpacity = 0.2;
                    const weight = 3;

                    const polygon = L.geoJSON(geojson, {
                        style: {
                            color: cor,
                            weight: weight,
                            fillColor: cor,
                            fillOpacity: fillOpacity
                        }
                    }).addTo(sigefLayer); // Adicionar √† mesma camada de confrontantes

                    // Calcular per√≠metro da geometria
                    let perimetro = 0;
                    if (geojson.type === 'Polygon' && geojson.coordinates && geojson.coordinates[0]) {
                        const coords = geojson.coordinates[0];
                        for (let i = 0; i < coords.length - 1; i++) {
                            const lat1 = coords[i][1];
                            const lng1 = coords[i][0];
                            const lat2 = coords[i + 1][1];
                            const lng2 = coords[i + 1][0];
                            perimetro += calcularDistanciaHaversine(lat1, lng1, lat2, lng2);
                        }
                    }

                    // Popup de confrontante CAR
                    const area = parseFloat(imovel.area_ha || dadosAdicionais.area_ha || 0).toFixed(2);
                    const perimetroFormatado = perimetro > 0 ? perimetro.toFixed(2) : 'N/A';

                    let popupContent = `
                        <div style="min-width: 250px;">
                            <strong style="font-size: 14px; color: #00FF00;">üåæ CONFRONTANTE CAR</strong><br>
                            <hr style="margin: 8px 0;">
                            <strong>C√≥digo CAR:</strong> ${imovel.codigo_car}<br>
                            <strong>Munic√≠pio:</strong> ${imovel.municipio || dadosAdicionais.municipio || 'N/A'}<br>
                            <strong>√Årea:</strong> ${area} ha<br>
                            <strong>Per√≠metro:</strong> ${perimetroFormatado} m<br>
                            <strong>Situa√ß√£o:</strong> ${imovel.situacao || 'Ativo'}<br>
                    `;

                    // Adicionar dados espec√≠ficos de confrontante
                    if (dadosAdicionais) {
                        if (dadosAdicionais.distancia_m !== undefined) {
                            popupContent += `<hr style="margin: 8px 0;">
                                <strong>Dist√¢ncia:</strong> ${parseFloat(dadosAdicionais.distancia_m).toFixed(2)} m<br>
                                <strong>Tipo:</strong> ${dadosAdicionais.tipo_confrontacao || 'Pr√≥ximo'}<br>
                            `;
                        }
                    }

                    popupContent += `</div>`;

                    polygon.bindPopup(popupContent);
                }

            } catch (error) {
                console.error(`Erro ao carregar im√≥vel CAR ${codigoCAR}:`, error);
            }
        }

        // Fun√ß√£o auxiliar para calcular dist√¢ncia Haversine
        function calcularDistanciaHaversine(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Raio da Terra em metros
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // =====================================================
        // FUN√á√ïES DE GERA√á√ÉO DE RELAT√ìRIOS
        // =====================================================

        function obterPropriedadeIdAtual() {
            const propriedadeId = document.getElementById('propriedadeSelect').value;
            if (!propriedadeId) {
                alert('Selecione uma propriedade primeiro!');
                return null;
            }
            return propriedadeId;
        }

        function mostrarLoadingOverlay(mensagem) {
            const overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                color: white;
                font-size: 18px;
                font-weight: bold;
            `;
            overlay.innerHTML = `
                <div style="text-align: center;">
                    <div>‚è≥ ${mensagem}</div>
                    <div style="margin-top: 10px; font-size: 14px; font-weight: normal;">Aguarde...</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function removerLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function mostrarToast(mensagem, tipo = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                padding: 15px 25px;
                background: ${tipo === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = mensagem;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function downloadRelatorio(url, nomeArquivo, mensagemLoading) {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            mostrarLoadingOverlay(mensagemLoading);

            try {
                const response = await fetch(url, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = nomeArquivo.replace('{id}', propriedadeId);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);

                removerLoadingOverlay();
                mostrarToast('‚úÖ Relat√≥rio gerado com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao gerar relat√≥rio:', error);
                removerLoadingOverlay();
                mostrarToast('‚ùå Erro ao gerar relat√≥rio: ' + error.message, 'error');
            }
        }

        // Fun√ß√µes espec√≠ficas para cada tipo de relat√≥rio

        function gerarRelatorioPDF() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadRelatorio(
                `${API_BASE}/relatorios/analise-completa/${propriedadeId}`,
                `analise_completa_{id}.pdf`,
                'Gerando Relat√≥rio de An√°lise Completa...'
            );
        }

        function gerarRelatorioConfrontantesPDF() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadRelatorio(
                `${API_BASE}/relatorios/confrontantes/${propriedadeId}`,
                `confrontantes_{id}.pdf`,
                'Gerando Relat√≥rio de Confrontantes (PDF)...'
            );
        }

        function gerarRelatorioViabilidadePDF() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadRelatorio(
                `${API_BASE}/relatorios/viabilidade/${propriedadeId}`,
                `viabilidade_{id}.pdf`,
                'Gerando Relat√≥rio de Viabilidade...'
            );
        }

        function gerarRelatorioConfrontantesExcel() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadRelatorio(
                `${API_BASE}/relatorios/confrontantes-excel/${propriedadeId}`,
                `confrontantes_{id}.xlsx`,
                'Exportando Confrontantes para Excel...'
            );
        }

        function gerarRelatorioConfrontantesCSV() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadRelatorio(
                `${API_BASE}/relatorios/confrontantes-csv/${propriedadeId}`,
                `confrontantes_{id}.csv`,
                'Exportando Confrontantes para CSV...'
            );
        }

        function gerarRelatorioSobreposicoesExcel() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadRelatorio(
                `${API_BASE}/relatorios/sobreposicoes-excel/${propriedadeId}`,
                `sobreposicoes_{id}.xlsx`,
                'Exportando Sobreposi√ß√µes para Excel...'
            );
        }

        // =====================================================
        // FUN√á√ïES DE EXPORTA√á√ÉO GEOREFERENCIADA
        // =====================================================

        async function downloadGeoExport(url, nomeArquivo, mensagemLoading) {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            mostrarLoadingOverlay(mensagemLoading);

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Erro ${response.status}`);
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = nomeArquivo.replace('{id}', propriedadeId);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);

                removerLoadingOverlay();
                mostrarToast('‚úÖ Arquivo exportado com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao exportar:', error);
                removerLoadingOverlay();
                mostrarToast('‚ùå ' + error.message, 'error');
            }
        }

        // Confrontantes - GeoJSON
        function exportarConfrontantesGeoJSON() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadGeoExport(
                `${API_BASE}/export-geo/confrontantes/${propriedadeId}/geojson`,
                `confrontantes_{id}.geojson`,
                'Exportando Confrontantes (GeoJSON)...'
            );
        }

        // Confrontantes - KML
        function exportarConfrontantesKML() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadGeoExport(
                `${API_BASE}/export-geo/confrontantes/${propriedadeId}/kml`,
                `confrontantes_{id}.kml`,
                'Exportando Confrontantes (KML)...'
            );
        }

        // Confrontantes - Shapefile
        function exportarConfrontantesShapefile() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadGeoExport(
                `${API_BASE}/export-geo/confrontantes/${propriedadeId}/shapefile`,
                `confrontantes_{id}.zip`,
                'Exportando Confrontantes (Shapefile)...'
            );
        }

        // Confrontantes - DXF
        function exportarConfrontantesDXF() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadGeoExport(
                `${API_BASE}/export-geo/confrontantes/${propriedadeId}/dxf`,
                `confrontantes_{id}.dxf`,
                'Exportando Confrontantes (DXF)...'
            );
        }

        // Sobreposi√ß√µes - GeoJSON
        function exportarSobreposicoesGeoJSON() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadGeoExport(
                `${API_BASE}/export-geo/sobreposicoes/${propriedadeId}/geojson`,
                `sobreposicoes_{id}.geojson`,
                'Exportando Sobreposi√ß√µes (GeoJSON)...'
            );
        }

        // Sobreposi√ß√µes - KML
        function exportarSobreposicoesKML() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadGeoExport(
                `${API_BASE}/export-geo/sobreposicoes/${propriedadeId}/kml`,
                `sobreposicoes_{id}.kml`,
                'Exportando Sobreposi√ß√µes (KML)...'
            );
        }

        // Sobreposi√ß√µes - Shapefile
        function exportarSobreposicoesShapefile() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadGeoExport(
                `${API_BASE}/export-geo/sobreposicoes/${propriedadeId}/shapefile`,
                `sobreposicoes_{id}.zip`,
                'Exportando Sobreposi√ß√µes (Shapefile)...'
            );
        }

        // Sobreposi√ß√µes - DXF
        function exportarSobreposicoesDXF() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadGeoExport(
                `${API_BASE}/export-geo/sobreposicoes/${propriedadeId}/dxf`,
                `sobreposicoes_{id}.dxf`,
                'Exportando Sobreposi√ß√µes (DXF)...'
            );
        }

        // =====================================================
        // IMPORTA√á√ÉO R√ÅPIDA DE PROPRIEDADES
        // =====================================================

        let quickSelectedFile = null;

        // Setup da √°rea de upload r√°pido
        const quickUploadArea = document.getElementById('quickUploadArea');
        const quickFileInput = document.getElementById('quickFileInput');
        const quickFileInfo = document.getElementById('quickFileInfo');
        const quickFileName = document.getElementById('quickFileName');
        const quickNomePropriedade = document.getElementById('quickNomePropriedade');
        const quickImportBtn = document.getElementById('quickImportBtn');

        // Click na √°rea de upload
        quickUploadArea.addEventListener('click', () => {
            quickFileInput.click();
        });

        // Drag and drop
        quickUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            quickUploadArea.style.borderColor = '#0056b3';
            quickUploadArea.style.background = '#e8f4ff';
        });

        quickUploadArea.addEventListener('dragleave', () => {
            quickUploadArea.style.borderColor = '#007bff';
            quickUploadArea.style.background = 'white';
        });

        quickUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            quickUploadArea.style.borderColor = '#007bff';
            quickUploadArea.style.background = 'white';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleQuickFileSelect(files[0]);
            }
        });

        // Sele√ß√£o de arquivo
        quickFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleQuickFileSelect(e.target.files[0]);
            }
        });

        function handleQuickFileSelect(file) {
            quickSelectedFile = file;
            quickFileName.textContent = file.name;
            quickFileInfo.style.display = 'block';
            quickImportBtn.disabled = false;

            // Sugerir nome baseado no arquivo
            if (!quickNomePropriedade.value) {
                const nomeSugerido = file.name.replace(/\.(kml|kmz|shp|zip|dxf|geojson|json)$/i, '');
                quickNomePropriedade.value = nomeSugerido;
            }

            console.log('‚úÖ Arquivo selecionado:', file.name);
        }

        function clearQuickFile() {
            quickSelectedFile = null;
            quickFileInput.value = '';
            quickFileInfo.style.display = 'none';
            quickImportBtn.disabled = true;
            console.log('üóëÔ∏è Arquivo removido');
        }

        async function importarPropriedadeRapido() {
            if (!quickSelectedFile) {
                alert('Selecione um arquivo primeiro!');
                return;
            }

            const nomePropriedade = quickNomePropriedade.value.trim();
            if (!nomePropriedade) {
                alert('Digite um nome para a propriedade!');
                quickNomePropriedade.focus();
                return;
            }

            // Criar FormData
            const formData = new FormData();
            formData.append('arquivo', quickSelectedFile);
            formData.append('nome_propriedade', nomePropriedade);
            formData.append('cliente_id', 1);
            formData.append('tipo', 'RURAL');

            // Mostrar loading
            mostrarLoadingOverlay('Importando propriedade...');
            quickImportBtn.disabled = true;

            try {
                console.log('üì§ Enviando arquivo para importa√ß√£o:', quickSelectedFile.name);

                const response = await fetch(`${API_BASE}/upload-geo/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                removerLoadingOverlay();

                if (data.success) {
                    console.log('‚úÖ Propriedade importada com sucesso:', data.propriedade);

                    mostrarToast(`‚úÖ ${nomePropriedade} importada com sucesso!`, 'success');

                    // Limpar formul√°rio
                    clearQuickFile();
                    quickNomePropriedade.value = '';

                    // Recarregar lista de propriedades
                    await carregarPropriedades();

                    // Selecionar a nova propriedade automaticamente
                    document.getElementById('propriedadeSelect').value = data.propriedade.id;

                    // Executar an√°lise automaticamente
                    setTimeout(() => {
                        executarAnalise();
                    }, 500);

                } else {
                    console.error('‚ùå Erro na importa√ß√£o:', data.message);
                    mostrarToast('‚ùå Erro: ' + (data.message || 'Falha ao importar'), 'error');
                    quickImportBtn.disabled = false;
                }

            } catch (error) {
                console.error('‚ùå Erro ao importar propriedade:', error);
                removerLoadingOverlay();
                mostrarToast('‚ùå Erro ao importar: ' + error.message, 'error');
                quickImportBtn.disabled = false;
            }
        }

        // =====================================================
        // CAMADAS CAR - DOWNLOAD E VISUALIZA√á√ÉO
        // =====================================================

        async function baixarCamadasCAR() {
            const propriedadeId = document.getElementById('propriedadeSelect').value;

            if (!propriedadeId) {
                mostrarToast('‚ùå Selecione uma propriedade primeiro', 'error');
                return;
            }

            const btnBaixarCAR = document.getElementById('btnBaixarCAR');
            const statusDiv = document.getElementById('carDownloadStatus');

            try {
                btnBaixarCAR.disabled = true;
                btnBaixarCAR.textContent = '‚è≥ Baixando via GeoPR...';
                statusDiv.style.display = 'block';
                statusDiv.textContent = '‚è≥ Conectando ao GeoPR (IAT-PR)...';

                console.log(`üåæ Iniciando download GeoPR para propriedade ${propriedadeId}`);

                // MUDAN√áA: Usar novo endpoint que baixa direto do GeoPR
                const response = await fetch(`${API_BASE}/car/baixar-geopr/${propriedadeId}`);
                const data = await response.json();

                if (data.success) {
                    console.log('‚úÖ Download conclu√≠do:', data);

                    if (data.imoveis_baixados > 0) {
                        mostrarToast(
                            `‚úÖ ${data.imoveis_baixados} im√≥veis CAR baixados de ${data.confrontantes_processados} confrontantes!`,
                            'success'
                        );

                        // Mostrar controles de camadas
                        document.getElementById('controlesCAR').style.display = 'block';

                        // Carregar e exibir no mapa
                        await carregarCamadasNoMapa(propriedadeId);

                        statusDiv.style.display = 'none';
                        btnBaixarCAR.textContent = '‚úÖ Camadas Baixadas';
                    } else {
                        mostrarToast('‚ö†Ô∏è Nenhum im√≥vel CAR encontrado para os confrontantes', 'warning');
                        btnBaixarCAR.textContent = 'üì• Baixar Todas as Camadas';
                        btnBaixarCAR.disabled = false;
                        statusDiv.style.display = 'none';
                    }

                } else {
                    throw new Error(data.message || 'Erro ao baixar camadas');
                }

            } catch (error) {
                console.error('‚ùå Erro ao baixar camadas CAR:', error);
                mostrarToast('‚ùå Erro: ' + error.message, 'error');
                btnBaixarCAR.disabled = false;
                btnBaixarCAR.textContent = 'üì• Baixar Todas as Camadas';
                statusDiv.style.display = 'none';
            }
        }

        async function carregarCamadasNoMapa(propriedadeId) {
            try {
                console.log('üó∫Ô∏è Carregando camadas CAR no mapa...');

                const response = await fetch(`${API_BASE}/car/camadas/${propriedadeId}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Erro ao carregar camadas');
                }

                console.log('‚úÖ Camadas carregadas:', data.totais_por_tipo);

                // Limpar camadas antigas
                Object.values(layerGroupsCAR).forEach(layer => layer.clearLayers());

                // Adicionar √Åreas de Im√≥veis CAR (Confrontantes)
                let totalImoveis = 0;

                // Buscar todas as camadas e somar AREA_IMOVEL + outras
                Object.entries(data.camadas).forEach(([tipo, featureCollection]) => {
                    if (featureCollection.features && featureCollection.features.length > 0) {
                        featureCollection.features.forEach(feature => {
                            if (feature.properties.tipo_camada === 'AREA_IMOVEL') {
                                // Adicionar im√≥vel com estilo espec√≠fico
                                L.geoJSON(feature, {
                                    style: {
                                        color: '#FFD700', // Dourado para im√≥veis CAR
                                        weight: 2,
                                        fillOpacity: 0.2,
                                        dashArray: '5, 5'
                                    },
                                    onEachFeature: (f, layer) => {
                                        layer.bindPopup(`
                                            <strong>üåæ Im√≥vel CAR</strong><br>
                                            <strong>C√≥digo CAR:</strong> ${f.properties.codigo_car}<br>
                                            <strong>Nome:</strong> ${f.properties.nome_camada || 'N/A'}<br>
                                            <strong>√Årea:</strong> ${f.properties.area_ha ? f.properties.area_ha.toFixed(2) + ' ha' : 'N/A'}<br>
                                            <strong>Fonte:</strong> ${f.properties.fonte || 'GeoPR'}
                                        `);
                                    }
                                }).addTo(layerGroupsCAR.uso_solo); // Usar grupo uso_solo para im√≥veis

                                totalImoveis++;
                            }
                        });
                    }
                });

                // Atualizar contador
                if (totalImoveis > 0) {
                    document.querySelector('#layer-uso-solo .layer-count').textContent = `(${totalImoveis})`;

                    // Ativar checkbox automaticamente
                    document.getElementById('layer-uso-solo').checked = true;
                    map.addLayer(layerGroupsCAR.uso_solo);
                }

                console.log(`‚úÖ ${totalImoveis} im√≥veis CAR adicionados ao mapa`);

                // Adicionar Uso do Solo
                if (data.camadas.uso_solo.features.length > 0) {
                    L.geoJSON(data.camadas.uso_solo, {
                        style: {
                            color: coresCAR.uso_solo,
                            weight: 2,
                            fillOpacity: 0.3
                        },
                        onEachFeature: (feature, layer) => {
                            layer.bindPopup(`
                                <strong>üü§ Uso do Solo</strong><br>
                                <strong>CAR:</strong> ${feature.properties.codigo_car}<br>
                                <strong>Nome:</strong> ${feature.properties.nome_camada || 'N/A'}<br>
                                <strong>√Årea:</strong> ${feature.properties.area_ha.toFixed(2)} ha
                            `);
                        }
                    }).addTo(layerGroupsCAR.uso_solo);
                }

                // Adicionar Hidrografia
                if (data.camadas.hidrografia.features.length > 0) {
                    L.geoJSON(data.camadas.hidrografia, {
                        style: {
                            color: coresCAR.hidrografia,
                            weight: 3,
                            fillOpacity: 0.5
                        },
                        onEachFeature: (feature, layer) => {
                            layer.bindPopup(`
                                <strong>üîµ Hidrografia</strong><br>
                                <strong>CAR:</strong> ${feature.properties.codigo_car}<br>
                                <strong>Nome:</strong> ${feature.properties.nome_camada || 'N/A'}<br>
                                <strong>√Årea:</strong> ${feature.properties.area_ha.toFixed(2)} ha
                            `);
                        }
                    }).addTo(layerGroupsCAR.hidrografia);
                }

                // Adicionar Reserva Legal
                if (data.camadas.reserva_legal.features.length > 0) {
                    L.geoJSON(data.camadas.reserva_legal, {
                        style: {
                            color: coresCAR.reserva_legal,
                            weight: 2,
                            fillOpacity: 0.4
                        },
                        onEachFeature: (feature, layer) => {
                            layer.bindPopup(`
                                <strong>üü¢ Reserva Legal</strong><br>
                                <strong>CAR:</strong> ${feature.properties.codigo_car}<br>
                                <strong>Nome:</strong> ${feature.properties.nome_camada || 'N/A'}<br>
                                <strong>√Årea:</strong> ${feature.properties.area_ha.toFixed(2)} ha
                            `);
                        }
                    }).addTo(layerGroupsCAR.reserva_legal);
                }

                // Adicionar Vegeta√ß√£o Nativa
                if (data.camadas.vegetacao_nativa.features.length > 0) {
                    L.geoJSON(data.camadas.vegetacao_nativa, {
                        style: {
                            color: coresCAR.vegetacao_nativa,
                            weight: 2,
                            fillOpacity: 0.3
                        },
                        onEachFeature: (feature, layer) => {
                            layer.bindPopup(`
                                <strong>üå≥ Vegeta√ß√£o Nativa</strong><br>
                                <strong>CAR:</strong> ${feature.properties.codigo_car}<br>
                                <strong>Nome:</strong> ${feature.properties.nome_camada || 'N/A'}<br>
                                <strong>√Årea:</strong> ${feature.properties.area_ha.toFixed(2)} ha
                            `);
                        }
                    }).addTo(layerGroupsCAR.vegetacao_nativa);
                }

                // Adicionar APP
                if (data.camadas.app.features.length > 0) {
                    L.geoJSON(data.camadas.app, {
                        style: {
                            color: coresCAR.app,
                            weight: 2,
                            fillOpacity: 0.4
                        },
                        onEachFeature: (feature, layer) => {
                            layer.bindPopup(`
                                <strong>üõ°Ô∏è APP</strong><br>
                                <strong>CAR:</strong> ${feature.properties.codigo_car}<br>
                                <strong>Nome:</strong> ${feature.properties.nome_camada || 'N/A'}<br>
                                <strong>√Årea:</strong> ${feature.properties.area_ha.toFixed(2)} ha
                            `);
                        }
                    }).addTo(layerGroupsCAR.app);
                }

                console.log('‚úÖ Todas as camadas CAR adicionadas ao mapa');

            } catch (error) {
                console.error('‚ùå Erro ao carregar camadas no mapa:', error);
                mostrarToast('‚ùå Erro ao carregar camadas: ' + error.message, 'error');
            }
        }

        // Habilitar bot√£o CAR quando propriedade for selecionada
        document.getElementById('propriedadeSelect').addEventListener('change', function() {
            const btnBaixarCAR = document.getElementById('btnBaixarCAR');
            btnBaixarCAR.disabled = !this.value;
        });

        // Inicializa√ß√£o
        initMap();
        carregarPropriedades();

        // Adicionar anima√ß√µes CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
