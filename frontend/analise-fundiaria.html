<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise Fundi√°ria - COGEP</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- styles.css REMOVIDO para evitar conflitos com fullscreen -->
    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            height: 100% !important;
            overflow: hidden !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .analise-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            width: 100vw !important;
            height: 100vh !important;
            gap: 0;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
        }

        .sidebar {
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #e0e0e0;
            height: 100%;
        }

        .sidebar h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
            color: #333;
        }

        .map-container {
            position: relative !important;
            height: 100% !important;
            width: 100% !important;
            min-height: 100vh !important;
        }

        #map {
            width: 100% !important;
            height: 100% !important;
            min-height: 100vh !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .score-badge {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 20px;
            text-align: center;
        }

        .score-badge.baixo {
            background: #d4edda;
            color: #155724;
        }

        .score-badge.medio, .score-badge.m√©dio {
            background: #fff3cd;
            color: #856404;
        }

        .score-badge.alto {
            background: #f8d7da;
            color: #721c24;
        }

        .score-badge.critico, .score-badge.cr√≠tico {
            background: #dc3545;
            color: white;
        }

        .resultado-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .resultado-section h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .confrontante-item {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-left: 4px solid #28a745;
            border-radius: 4px;
            font-size: 13px;
        }

        .sobreposicao-item {
            padding: 10px;
            margin: 8px 0;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
            font-size: 13px;
        }

        #resultados {
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .map-legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 2px solid #333;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="analise-container">
        <div class="sidebar">
            <h1>üî¨ An√°lise Fundi√°ria</h1>
            <p style="font-size: 13px; color: #666; margin-bottom: 20px;">
                Sistema de detec√ß√£o de sobreposi√ß√µes e an√°lise de viabilidade
            </p>

            <div class="form-group">
                <label>Selecionar Propriedade:</label>
                <select id="propriedadeSelect" class="form-control">
                    <option value="">Carregando...</option>
                </select>
            </div>

            <button onclick="executarAnalise()" class="btn btn-primary btn-block">
                üîç Executar An√°lise Completa
            </button>

            <div id="resultados" style="display:none;">
                <div class="resultado-section">
                    <h3>üìä Score de Viabilidade</h3>
                    <div id="scoreDisplay"></div>
                    <p id="recomendacao" style="margin-top:10px; font-size:13px;"></p>
                </div>

                <div class="resultado-section">
                    <h3>‚ö†Ô∏è Sobreposi√ß√µes</h3>
                    <div id="sobreposicoesDisplay"></div>
                </div>

                <div class="resultado-section">
                    <h3>üë• Confrontantes</h3>
                    <div id="confrontantesDisplay"></div>
                </div>

                <div class="resultado-section" style="border-left-color: #6c757d;">
                    <h3>üìÑ Gerar Relat√≥rios</h3>
                    <div style="display: grid; gap: 10px; margin-top: 10px;">
                        <button onclick="gerarRelatorioPDF()" class="btn btn-primary">
                            üìÑ An√°lise Completa (PDF)
                        </button>
                        <button onclick="gerarRelatorioConfrontantesPDF()" class="btn btn-primary">
                            üë• Confrontantes (PDF)
                        </button>
                        <button onclick="gerarRelatorioViabilidadePDF()" class="btn btn-primary">
                            ‚úÖ Viabilidade (PDF)
                        </button>
                        <button onclick="gerarRelatorioConfrontantesExcel()" class="btn btn-primary">
                            üìä Confrontantes (Excel)
                        </button>
                        <button onclick="gerarRelatorioConfrontantesCSV()" class="btn btn-primary">
                            üìã Confrontantes (CSV)
                        </button>
                        <button onclick="gerarRelatorioSobreposicoesExcel()" class="btn btn-primary">
                            ‚ö†Ô∏è Sobreposi√ß√µes (Excel)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>

            <div class="map-legend">
                <strong style="display:block; margin-bottom:10px;">üó∫Ô∏è Controle de Camadas</strong>

                <!-- Propriedade Local -->
                <div class="legend-item" style="padding: 5px 0; cursor: pointer;" onclick="toggleLayer('propriedade')">
                    <input type="checkbox" id="layer-propriedade" checked onchange="toggleLayer('propriedade')" style="margin-right: 5px;">
                    <div class="legend-color" style="background:#007bff;opacity:0.3;"></div>
                    <span>Propriedade Analisada</span>
                </div>

                <!-- Sobreposi√ß√µes -->
                <div class="legend-item" style="padding: 5px 0; cursor: pointer;" onclick="toggleLayer('sobreposicoes')">
                    <input type="checkbox" id="layer-sobreposicoes" checked onchange="toggleLayer('sobreposicoes')" style="margin-right: 5px;">
                    <div class="legend-color" style="background:#FF0000;opacity:0.4;"></div>
                    <span>Sobreposi√ß√µes (Vermelho)</span>
                </div>

                <!-- Confrontantes -->
                <div class="legend-item" style="padding: 5px 0; cursor: pointer;" onclick="toggleLayer('confrontantes')">
                    <input type="checkbox" id="layer-confrontantes" checked onchange="toggleLayer('confrontantes')" style="margin-right: 5px;">
                    <div class="legend-color" style="background:#FFD700;opacity:0.3;"></div>
                    <span>Confrontantes (Dourado)</span>
                </div>

                <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">

                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    <strong>Dica:</strong> Clique nas camadas para mostrar/ocultar
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, propriedadeLayer, sigefLayer, conflitosLayer;
        const API_BASE = 'http://localhost:3001/api';

        function initMap() {
            map = L.map('map').setView([-25.4284, -49.2733], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            propriedadeLayer = L.layerGroup().addTo(map);
            sigefLayer = L.layerGroup().addTo(map);
            conflitosLayer = L.layerGroup().addTo(map);

            // For√ßar redimensionamento ap√≥s 100ms
            setTimeout(() => {
                map.invalidateSize();
                console.log('‚úÖ Mapa redimensionado para fullscreen');
            }, 100);
        }

        // =====================================================
        // CONTROLE DE CAMADAS
        // =====================================================

        function toggleLayer(layerName) {
            const checkbox = document.getElementById(`layer-${layerName}`);

            switch(layerName) {
                case 'propriedade':
                    if (checkbox.checked) {
                        map.addLayer(propriedadeLayer);
                        console.log('‚úÖ Camada "Propriedade" ativada');
                    } else {
                        map.removeLayer(propriedadeLayer);
                        console.log('‚ùå Camada "Propriedade" desativada');
                    }
                    break;

                case 'sobreposicoes':
                    if (checkbox.checked) {
                        map.addLayer(conflitosLayer);
                        console.log('‚úÖ Camada "Sobreposi√ß√µes" ativada');
                    } else {
                        map.removeLayer(conflitosLayer);
                        console.log('‚ùå Camada "Sobreposi√ß√µes" desativada');
                    }
                    break;

                case 'confrontantes':
                    if (checkbox.checked) {
                        map.addLayer(sigefLayer);
                        console.log('‚úÖ Camada "Confrontantes" ativada');
                    } else {
                        map.removeLayer(sigefLayer);
                        console.log('‚ùå Camada "Confrontantes" desativada');
                    }
                    break;
            }
        }

        // =====================================================
        // CARREGAMENTO DE DADOS
        // =====================================================

        async function carregarPropriedades() {
            try {
                console.log('üîç Carregando propriedades...');

                const response = await fetch(`${API_BASE}/propriedades/com-score`);

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const propriedades = await response.json();

                console.log('‚úÖ Propriedades recebidas:', propriedades);

                // Verificar se √© array
                if (!Array.isArray(propriedades)) {
                    console.error('‚ùå Resposta n√£o √© array:', propriedades);
                    throw new Error('Formato de resposta inv√°lido');
                }

                const select = document.getElementById('propriedadeSelect');
                select.innerHTML = '<option value="">Selecione uma propriedade...</option>';

                if (propriedades.length === 0) {
                    select.innerHTML += '<option value="" disabled>Nenhuma propriedade cadastrada</option>';
                    return;
                }

                propriedades.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.nome_propriedade} - ${p.municipio}/${p.uf}`;
                    select.appendChild(option);
                });

                console.log(`‚úÖ ${propriedades.length} propriedades carregadas`);

            } catch (error) {
                console.error('‚ùå Erro ao carregar propriedades:', error);
                const select = document.getElementById('propriedadeSelect');
                select.innerHTML = '<option value="" disabled>Erro ao carregar propriedades</option>';
            }
        }

        async function executarAnalise() {
            const propriedadeId = document.getElementById('propriedadeSelect').value;

            if (!propriedadeId) {
                alert('Selecione uma propriedade!');
                return;
            }

            document.getElementById('resultados').style.display = 'block';

            // Mostrar loading
            document.getElementById('scoreDisplay').innerHTML = '‚è≥ Analisando...';
            document.getElementById('sobreposicoesDisplay').innerHTML = '‚è≥ Verificando...';
            document.getElementById('confrontantesDisplay').innerHTML = '‚è≥ Identificando...';

            try {
                console.log(`üî¨ Iniciando an√°lise completa: Propriedade #${propriedadeId}`);

                const response = await fetch(`${API_BASE}/analise/completa/${propriedadeId}`, {
                    method: 'POST'
                });

                const resultado = await response.json();

                console.log('Resultado da an√°lise:', resultado);

                // Exibir score
                exibirScore(resultado.score);

                // Exibir sobreposi√ß√µes
                exibirSobreposicoes(resultado.sobreposicoes);

                // Exibir confrontantes
                exibirConfrontantes(resultado.confrontantes);

                // Carregar geometrias no mapa
                await carregarNoMapa(propriedadeId, resultado);

            } catch (error) {
                console.error('Erro na an√°lise:', error);
                alert('Erro ao executar an√°lise: ' + error.message);
            }
        }

        function exibirScore(score) {
            if (!score || !score.sucesso) {
                document.getElementById('scoreDisplay').innerHTML =
                    '<p style="color:red;">Erro ao calcular score</p>';
                return;
            }

            const nivel = score.nivel_risco.toLowerCase();
            const badgeClass = nivel === 'cr√≠tico' ? 'critico' : nivel;

            document.getElementById('scoreDisplay').innerHTML = `
                <div class="score-badge ${badgeClass}">
                    ${score.score_total}/100 - ${score.nivel_risco}
                </div>
                <div style="margin-top: 15px;">
                    <strong>Detalhes:</strong>
                    <ul style="margin-top: 10px; padding-left: 20px; font-size:13px;">
                        <li>Sobreposi√ß√µes: ${score.tem_sobreposicao ? '‚ö†Ô∏è SIM' : '‚úÖ N√ÉO'}</li>
                        <li>Quantidade: ${score.qtd_sobreposicoes || 0}</li>
                        <li>√Årea sobreposta: ${parseFloat(score.area_sobreposta_m2 || 0).toFixed(2)} m¬≤</li>
                        <li>Confrontantes: ${score.qtd_confrontantes || 0}</li>
                    </ul>
                </div>
            `;

            document.getElementById('recomendacao').innerHTML = `
                <strong>üìã Recomenda√ß√£o:</strong><br>
                ${score.recomendacao}
            `;
        }

        function exibirSobreposicoes(sobreposicoes) {
            const container = document.getElementById('sobreposicoesDisplay');

            if (!sobreposicoes || !sobreposicoes.sucesso || sobreposicoes.total_sobreposicoes === 0) {
                container.innerHTML = '<p style="color:green;">‚úÖ Nenhuma sobreposi√ß√£o detectada!</p>';
                return;
            }

            let html = `<p><strong>‚ö†Ô∏è ${sobreposicoes.total_sobreposicoes} sobreposi√ß√£o(√µes) encontrada(s)</strong></p>`;

            sobreposicoes.sobreposicoes.forEach((s, idx) => {
                const percentual = parseFloat(s.percentual_propriedade || 0).toFixed(1);
                const areaSobrep = parseFloat(s.area_sobreposicao_m2 || 0).toFixed(2);
                const areaTotal = s.area_total_sigef_ha ? parseFloat(s.area_total_sigef_ha).toFixed(2) + ' ha' : 'N/A';
                const tipoTexto = s.tipo_sobreposicao ? s.tipo_sobreposicao.replace(/_/g, ' ').toUpperCase() : 'N/A';

                html += `
                    <div class="sobreposicao-item">
                        <strong>Sobreposi√ß√£o #${idx + 1}</strong><br>
                        <small><strong>Propriet√°rio SIGEF:</strong> ${s.proprietario_sigef || 'N/A'}</small><br>
                        <small><strong>Tipo:</strong> ${tipoTexto}</small><br>
                        <small><strong>Matr√≠cula:</strong> ${s.matricula_sigef || 'N/A'}</small><br>
                        <small><strong>Munic√≠pio:</strong> ${s.municipio_sigef || 'N/A'}</small><br>
                        <small><strong>√Årea Total Parcela:</strong> ${areaTotal}</small><br>
                        <small><strong>√Årea Sobreposi√ß√£o:</strong> ${areaSobrep} m¬≤ (${percentual}%)</small><br>
                        <small><strong>C√≥digo SIGEF:</strong> ${s.codigo_parcela ? s.codigo_parcela.substring(0, 13) + '...' : 'N/A'}</small>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function exibirConfrontantes(confrontantes) {
            const container = document.getElementById('confrontantesDisplay');

            if (!confrontantes || !confrontantes.sucesso || confrontantes.total_confrontantes === 0) {
                container.innerHTML = '<p>‚ÑπÔ∏è Nenhum confrontante identificado no raio de 500m</p>';
                return;
            }

            let html = `<p><strong>üë• ${confrontantes.total_confrontantes} confrontante(s) identificado(s)</strong></p>`;

            confrontantes.confrontantes.slice(0, 10).forEach((c, idx) => {
                const icon = c.tipo_contato === 'limite_comum' ? 'üîó' : 'üìç';
                const tipoTexto = c.tipo_contato === 'limite_comum' ? 'Limite Comum' : 'Pr√≥ximo';
                const area = c.area_ha ? parseFloat(c.area_ha).toFixed(2) + ' ha' : 'N/A';
                const azimute = c.azimute ? parseFloat(c.azimute).toFixed(1) + '¬∞' : 'N/A';

                html += `
                    <div class="confrontante-item">
                        ${icon} <strong>Confrontante #${idx + 1}</strong><br>
                        <small><strong>Propriet√°rio:</strong> ${c.proprietario || 'N/A'}</small><br>
                        <small><strong>Tipo:</strong> ${tipoTexto}</small><br>
                        <small><strong>Matr√≠cula:</strong> ${c.matricula || 'N/A'}</small><br>
                        <small><strong>Munic√≠pio:</strong> ${c.municipio || 'N/A'}</small><br>
                        <small><strong>√Årea:</strong> ${area}</small><br>
                        <small><strong>Dist√¢ncia:</strong> ${parseFloat(c.distancia_m || 0).toFixed(1)}m</small><br>
                        ${parseFloat(c.comprimento_contato_m || 0) > 0 ? `<small><strong>Comprimento Contato:</strong> ${parseFloat(c.comprimento_contato_m).toFixed(1)}m</small><br>` : ''}
                        ${c.azimute ? `<small><strong>Azimute:</strong> ${azimute}</small><br>` : ''}
                        <small><strong>C√≥digo SIGEF:</strong> ${c.codigo_parcela ? c.codigo_parcela.substring(0, 13) + '...' : 'N/A'}</small>
                    </div>
                `;
            });

            if (confrontantes.total_confrontantes > 10) {
                html += `<p><small>+ ${confrontantes.total_confrontantes - 10} confrontantes n√£o exibidos</small></p>`;
            }

            container.innerHTML = html;
        }

        async function carregarNoMapa(propriedadeId, resultado) {
            try {
                console.log('üó∫Ô∏è Carregando geometrias no mapa...');

                // Limpar camadas
                propriedadeLayer.clearLayers();
                sigefLayer.clearLayers();
                conflitosLayer.clearLayers();

                // Carregar propriedade local
                const propResponse = await fetch(`${API_BASE}/propriedades/${propriedadeId}`);
                const propriedade = await propResponse.json();

                let propPolygon;
                if (propriedade.geojson) {
                    const geojson = JSON.parse(propriedade.geojson);

                    propPolygon = L.geoJSON(geojson, {
                        style: {
                            color: '#007bff',      // Azul para propriedade principal
                            weight: 4,
                            fillColor: '#007bff',
                            fillOpacity: 0.15
                        }
                    }).addTo(propriedadeLayer);

                    // Calcular per√≠metro da propriedade
                    let perimetro = 0;
                    if (geojson.type === 'Polygon' && geojson.coordinates && geojson.coordinates[0]) {
                        const coords = geojson.coordinates[0];
                        for (let i = 0; i < coords.length - 1; i++) {
                            const lat1 = coords[i][1];
                            const lng1 = coords[i][0];
                            const lat2 = coords[i + 1][1];
                            const lng2 = coords[i + 1][0];
                            perimetro += calcularDistanciaHaversine(lat1, lng1, lat2, lng2);
                        }
                    }

                    const areaHa = (propriedade.area_m2 || propriedade.area_calculada || 0) / 10000;

                    propPolygon.bindPopup(`
                        <div style="min-width: 250px;">
                            <strong style="font-size: 14px; color: #007bff;">üè† PROPRIEDADE ANALISADA</strong><br>
                            <hr style="margin: 8px 0;">
                            <strong>Nome:</strong> ${propriedade.nome_propriedade}<br>
                            <strong>Matr√≠cula:</strong> ${propriedade.matricula || 'N/A'}<br>
                            <strong>Munic√≠pio:</strong> ${propriedade.municipio}<br>
                            <strong>√Årea:</strong> ${areaHa.toFixed(4)} ha<br>
                            <strong>Per√≠metro:</strong> ${perimetro.toFixed(2)} m
                        </div>
                    `);
                }

                // Carregar parcelas SIGEF sobrepostas com dados adicionais
                if (resultado.sobreposicoes?.sobreposicoes && resultado.sobreposicoes.sobreposicoes.length > 0) {
                    console.log(`‚ö†Ô∏è  Carregando ${resultado.sobreposicoes.sobreposicoes.length} sobreposi√ß√£o(√µes)...`);
                    for (const s of resultado.sobreposicoes.sobreposicoes) {
                        await carregarParcelaSIGEF(s.parcela_sigef_id, 'sobreposicao', {
                            area_sobreposicao_m2: s.area_sobreposicao_m2,
                            percentual_propriedade: s.percentual_propriedade,
                            tipo_sobreposicao: s.tipo_sobreposicao
                        });
                    }
                }

                // Carregar confrontantes com dados adicionais
                if (resultado.confrontantes?.confrontantes && resultado.confrontantes.confrontantes.length > 0) {
                    console.log(`üë• Carregando ${resultado.confrontantes.confrontantes.length} confrontante(s)...`);
                    for (const c of resultado.confrontantes.confrontantes.slice(0, 20)) {
                        await carregarParcelaSIGEF(c.parcela_sigef_id, 'confrontante', {
                            distancia_m: c.distancia_m,
                            tipo_contato: c.tipo_contato,
                            azimute: c.azimute,
                            comprimento_contato_m: c.comprimento_contato_m
                        });
                    }
                }

                // ‚úÖ CENTRALIZAR AUTOMATICAMENTE NO MAPA
                if (propPolygon) {
                    console.log('üéØ Centralizando mapa na propriedade...');
                    map.fitBounds(propPolygon.getBounds(), {
                        padding: [100, 100],  // Padding maior para visualiza√ß√£o completa
                        maxZoom: 15           // Zoom m√°ximo para n√£o ficar muito pr√≥ximo
                    });
                }

                console.log('‚úÖ Mapa carregado com sucesso!');

            } catch (error) {
                console.error('‚ùå Erro ao carregar no mapa:', error);
            }
        }

        async function carregarParcelaSIGEF(parcelaId, tipo, dadosAdicionais = {}) {
            try {
                const response = await fetch(`${API_BASE}/sigef/parcelas/${parcelaId}`);
                const parcela = await response.json();

                if (parcela.geometry) {
                    const geojson = typeof parcela.geometry === 'string'
                        ? JSON.parse(parcela.geometry)
                        : parcela.geometry;

                    // Cores espec√≠ficas: Vermelho para sobreposi√ß√µes, Dourado para confrontantes
                    const cor = tipo === 'sobreposicao' ? '#FF0000' : '#FFD700';
                    const fillOpacity = tipo === 'sobreposicao' ? 0.4 : 0.2;
                    const weight = tipo === 'sobreposicao' ? 4 : 3;
                    const dashArray = tipo === 'sobreposicao' ? '10, 5' : null; // Tracejado para sobreposi√ß√µes

                    const polygon = L.geoJSON(geojson, {
                        style: {
                            color: cor,
                            weight: weight,
                            fillColor: cor,
                            fillOpacity: fillOpacity,
                            dashArray: dashArray
                        }
                    }).addTo(tipo === 'sobreposicao' ? conflitosLayer : sigefLayer);

                    // Calcular per√≠metro da geometria
                    let perimetro = 0;
                    if (geojson.type === 'Polygon' && geojson.coordinates && geojson.coordinates[0]) {
                        const coords = geojson.coordinates[0];
                        for (let i = 0; i < coords.length - 1; i++) {
                            const lat1 = coords[i][1];
                            const lng1 = coords[i][0];
                            const lat2 = coords[i + 1][1];
                            const lng2 = coords[i + 1][0];
                            perimetro += calcularDistanciaHaversine(lat1, lng1, lat2, lng2);
                        }
                    }

                    // Popup melhorado com per√≠metro e dados adicionais
                    const area = parseFloat(parcela.area_hectares || 0).toFixed(2);
                    const perimetroFormatado = perimetro > 0 ? perimetro.toFixed(2) : 'N/A';

                    let popupContent = `
                        <div style="min-width: 250px;">
                            <strong style="font-size: 14px;">${tipo === 'sobreposicao' ? '‚ö†Ô∏è SOBREPOSI√á√ÉO' : 'üë• CONFRONTANTE'}</strong><br>
                            <hr style="margin: 8px 0;">
                            <strong>Propriet√°rio:</strong> ${parcela.proprietario || 'N/A'}<br>
                            <strong>Munic√≠pio:</strong> ${parcela.municipio || 'N/A'}<br>
                            <strong>√Årea:</strong> ${area} ha<br>
                            <strong>Per√≠metro:</strong> ${perimetroFormatado} m<br>
                            <strong>Matr√≠cula:</strong> ${parcela.matricula || 'N/A'}<br>
                    `;

                    // Adicionar dados espec√≠ficos de sobreposi√ß√£o
                    if (tipo === 'sobreposicao' && dadosAdicionais) {
                        if (dadosAdicionais.area_sobreposicao_m2) {
                            popupContent += `<hr style="margin: 8px 0;">
                                <strong>√Årea Sobreposta:</strong> ${parseFloat(dadosAdicionais.area_sobreposicao_m2).toFixed(2)} m¬≤<br>
                                <strong>Percentual:</strong> ${parseFloat(dadosAdicionais.percentual_propriedade || 0).toFixed(1)}%<br>
                                <strong>Tipo:</strong> ${dadosAdicionais.tipo_sobreposicao || 'N/A'}<br>
                            `;
                        }
                    }

                    // Adicionar dados espec√≠ficos de confrontante
                    if (tipo === 'confrontante' && dadosAdicionais) {
                        if (dadosAdicionais.distancia_m !== undefined) {
                            popupContent += `<hr style="margin: 8px 0;">
                                <strong>Dist√¢ncia:</strong> ${parseFloat(dadosAdicionais.distancia_m).toFixed(2)} m<br>
                                <strong>Tipo Contato:</strong> ${dadosAdicionais.tipo_contato === 'limite_comum' ? 'üîó Limite Comum' : 'üìç Pr√≥ximo'}<br>
                            `;
                            if (dadosAdicionais.azimute) {
                                popupContent += `<strong>Azimute:</strong> ${parseFloat(dadosAdicionais.azimute).toFixed(1)}¬∞<br>`;
                            }
                        }
                    }

                    popupContent += `<strong>C√≥digo SIGEF:</strong> <small>${parcela.codigo_parcela || 'N/A'}</small>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                }

            } catch (error) {
                console.error(`Erro ao carregar parcela ${parcelaId}:`, error);
            }
        }

        // Fun√ß√£o auxiliar para calcular dist√¢ncia Haversine
        function calcularDistanciaHaversine(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Raio da Terra em metros
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // =====================================================
        // FUN√á√ïES DE GERA√á√ÉO DE RELAT√ìRIOS
        // =====================================================

        function obterPropriedadeIdAtual() {
            const propriedadeId = document.getElementById('propriedadeSelect').value;
            if (!propriedadeId) {
                alert('Selecione uma propriedade primeiro!');
                return null;
            }
            return propriedadeId;
        }

        function mostrarLoadingOverlay(mensagem) {
            const overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                color: white;
                font-size: 18px;
                font-weight: bold;
            `;
            overlay.innerHTML = `
                <div style="text-align: center;">
                    <div>‚è≥ ${mensagem}</div>
                    <div style="margin-top: 10px; font-size: 14px; font-weight: normal;">Aguarde...</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function removerLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function mostrarToast(mensagem, tipo = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                padding: 15px 25px;
                background: ${tipo === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = mensagem;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function downloadRelatorio(url, nomeArquivo, mensagemLoading) {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            mostrarLoadingOverlay(mensagemLoading);

            try {
                const response = await fetch(url, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = nomeArquivo.replace('{id}', propriedadeId);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);

                removerLoadingOverlay();
                mostrarToast('‚úÖ Relat√≥rio gerado com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao gerar relat√≥rio:', error);
                removerLoadingOverlay();
                mostrarToast('‚ùå Erro ao gerar relat√≥rio: ' + error.message, 'error');
            }
        }

        // Fun√ß√µes espec√≠ficas para cada tipo de relat√≥rio

        function gerarRelatorioPDF() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadRelatorio(
                `${API_BASE}/relatorios/analise-completa/${propriedadeId}`,
                `analise_completa_{id}.pdf`,
                'Gerando Relat√≥rio de An√°lise Completa...'
            );
        }

        function gerarRelatorioConfrontantesPDF() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadRelatorio(
                `${API_BASE}/relatorios/confrontantes/${propriedadeId}`,
                `confrontantes_{id}.pdf`,
                'Gerando Relat√≥rio de Confrontantes (PDF)...'
            );
        }

        function gerarRelatorioViabilidadePDF() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadRelatorio(
                `${API_BASE}/relatorios/viabilidade/${propriedadeId}`,
                `viabilidade_{id}.pdf`,
                'Gerando Relat√≥rio de Viabilidade...'
            );
        }

        function gerarRelatorioConfrontantesExcel() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadRelatorio(
                `${API_BASE}/relatorios/confrontantes-excel/${propriedadeId}`,
                `confrontantes_{id}.xlsx`,
                'Exportando Confrontantes para Excel...'
            );
        }

        function gerarRelatorioConfrontantesCSV() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadRelatorio(
                `${API_BASE}/relatorios/confrontantes-csv/${propriedadeId}`,
                `confrontantes_{id}.csv`,
                'Exportando Confrontantes para CSV...'
            );
        }

        function gerarRelatorioSobreposicoesExcel() {
            const propriedadeId = obterPropriedadeIdAtual();
            if (!propriedadeId) return;

            downloadRelatorio(
                `${API_BASE}/relatorios/sobreposicoes-excel/${propriedadeId}`,
                `sobreposicoes_{id}.xlsx`,
                'Exportando Sobreposi√ß√µes para Excel...'
            );
        }

        // Inicializa√ß√£o
        initMap();
        carregarPropriedades();

        // Adicionar anima√ß√µes CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
