<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COGEP - Sistema de Marcos Geodésicos</title>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Design System Premium -->
    <link rel="stylesheet" href="styles/design-system.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/animations.css">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.2/dist/proj4.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <!-- Supercluster -->
    <script src="https://unpkg.com/supercluster@8.0.1/dist/supercluster.min.js"></script>

    <style>
        /* Layout Premium */
        .app-container {
            display: flex;
            min-height: 100vh;
            background-color: var(--bg-primary);
        }

        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
        }

        .content-header {
            padding: var(--space-6);
            border-bottom: var(--border-width) solid var(--border-primary);
            background-color: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .content-body {
            flex: 1;
            overflow: hidden;
        }

        /* Tabs Premium */
        .tabs-container {
            border-bottom: var(--border-width) solid var(--border-primary);
            background-color: var(--bg-primary);
            padding: 0 var(--space-6);
        }

        .tabs-list {
            display: flex;
            gap: var(--space-6);
            overflow-x: auto;
        }

        .tab-button {
            padding: var(--space-4) 0;
            font-size: var(--text-base);
            font-weight: var(--weight-medium);
            color: var(--text-secondary);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .tab-button:hover {
            color: var(--text-primary);
        }

        .tab-button.active {
            color: var(--cogep-green);
            border-bottom-color: var(--cogep-green);
            font-weight: var(--weight-bold);
        }

        .tab-content {
            display: none;
            height: 100%;
        }

        .tab-content.active {
            display: block;
        }

        /* Mapa Premium */
        #map {
            width: 100%;
            height: calc(100vh - 120px);
            z-index: 1;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            padding: var(--space-6);
        }

        .stat-card {
            background-color: var(--bg-primary);
            border: var(--border-width) solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            transition: all var(--transition-base);
        }

        .stat-card:hover {
            border-color: var(--border-secondary);
            transform: translateY(-2px);
        }

        .stat-label {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .stat-value {
            font-size: var(--text-3xl);
            font-weight: var(--weight-heavy);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--cogep-green);
            color: white;
            border-radius: var(--radius-md);
        }

        /* Search Header */
        .search-header {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            flex: 1;
            max-width: 600px;
        }

        /* Modal Premium */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-primary);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: var(--space-6);
            border-bottom: var(--border-width) solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: var(--text-2xl);
            font-weight: var(--weight-heavy);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            padding: var(--space-6);
            border-top: var(--border-width) solid var(--border-primary);
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
        }
    </style>
</head>
<body>

    <div class="app-container">

        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-logo">
                    <i data-lucide="map-pin"></i>
                    <span class="sidebar-logo-text">COGEP</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <a href="#" class="nav-link active" data-tab="mapa">
                    <i data-lucide="map"></i>
                    <span>Mapa</span>
                </a>
                <a href="#" class="nav-link" data-tab="marcos">
                    <i data-lucide="map-pin"></i>
                    <span>Marcos</span>
                </a>
                <a href="#" class="nav-link" data-tab="importar">
                    <i data-lucide="upload"></i>
                    <span>Importar</span>
                </a>
                <a href="#" class="nav-link" data-tab="propriedades">
                    <i data-lucide="building-2"></i>
                    <span>Propriedades</span>
                </a>
                <a href="#" class="nav-link" data-tab="clientes">
                    <i data-lucide="users"></i>
                    <span>Clientes</span>
                </a>
                <a href="#" class="nav-link" data-tab="historico">
                    <i data-lucide="clock"></i>
                    <span>Histórico</span>
                </a>
            </nav>

            <div style="padding: var(--space-4); border-top: 1px solid var(--border-primary);">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i data-lucide="moon" id="theme-icon"></i>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">

            <!-- HEADER -->
            <header class="content-header">
                <div class="search-header">
                    <h1 style="font-size: var(--text-2xl); font-weight: var(--weight-heavy); color: var(--text-primary); letter-spacing: -0.5px;">
                        Sistema de Marcos Geodésicos
                    </h1>
                </div>
                <div style="display: flex; gap: var(--space-3); align-items: center;">
                    <div class="search-wrapper" style="width: 300px;">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" class="input input-search" placeholder="Buscar...">
                    </div>
                    <button class="btn btn-primary" onclick="abrirModalNovoMarco()">
                        <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
                        Novo Marco
                    </button>
                </div>
            </header>

            <!-- STATS -->
            <div class="stats-grid">
                <div class="stat-card animate-fade-in-up">
                    <div class="stat-label">Total de Marcos</div>
                    <div class="stat-value">
                        <div class="stat-icon">
                            <i data-lucide="map-pin" style="width: 24px; height: 24px;"></i>
                        </div>
                        <span id="stat-marcos">218</span>
                    </div>
                </div>
                <div class="stat-card animate-fade-in-up" style="animation-delay: 0.05s;">
                    <div class="stat-label">Marcos Levantados</div>
                    <div class="stat-value">
                        <div class="stat-icon" style="background-color: #10B981;">
                            <i data-lucide="check-circle" style="width: 24px; height: 24px;"></i>
                        </div>
                        <span id="stat-levantados">218</span>
                    </div>
                </div>
                <div class="stat-card animate-fade-in-up" style="animation-delay: 0.1s;">
                    <div class="stat-label">Propriedades</div>
                    <div class="stat-value">
                        <div class="stat-icon" style="background-color: #3B82F6;">
                            <i data-lucide="building-2" style="width: 24px; height: 24px;"></i>
                        </div>
                        <span id="stat-propriedades">0</span>
                    </div>
                </div>
                <div class="stat-card animate-fade-in-up" style="animation-delay: 0.15s;">
                    <div class="stat-label">Clientes</div>
                    <div class="stat-value">
                        <div class="stat-icon" style="background-color: #F59E0B;">
                            <i data-lucide="users" style="width: 24px; height: 24px;"></i>
                        </div>
                        <span id="stat-clientes">0</span>
                    </div>
                </div>
            </div>

            <!-- TABS -->
            <div class="tabs-container">
                <div class="tabs-list">
                    <button class="tab-button active" data-tab="mapa">
                        <i data-lucide="map" style="width: 18px; height: 18px;"></i>
                        Mapa
                    </button>
                    <button class="tab-button" data-tab="marcos">
                        <i data-lucide="map-pin" style="width: 18px; height: 18px;"></i>
                        Buscar Marcos
                    </button>
                    <button class="tab-button" data-tab="importar">
                        <i data-lucide="upload" style="width: 18px; height: 18px;"></i>
                        Importar Memorial
                    </button>
                    <button class="tab-button" data-tab="propriedades">
                        <i data-lucide="building-2" style="width: 18px; height: 18px;"></i>
                        Propriedades
                    </button>
                    <button class="tab-button" data-tab="clientes">
                        <i data-lucide="users" style="width: 18px; height: 18px;"></i>
                        Clientes
                    </button>
                    <button class="tab-button" data-tab="historico">
                        <i data-lucide="clock" style="width: 18px; height: 18px;"></i>
                        Histórico
                    </button>
                </div>
            </div>

            <!-- TAB CONTENT -->
            <div class="content-body">

                <!-- ABA MAPA -->
                <div id="tab-mapa" class="tab-content active">
                    <div id="map"></div>
                </div>

                <!-- ABA MARCOS -->
                <div id="tab-marcos" class="tab-content">
                    <div style="padding: var(--space-6);">

                        <!-- Filtros -->
                        <div style="display: flex; gap: var(--space-4); margin-bottom: var(--space-6); flex-wrap: wrap;">
                            <div class="input-group" style="flex: 1; min-width: 300px;">
                                <input
                                    type="text"
                                    id="busca-marcos"
                                    class="input input-search"
                                    placeholder="Buscar por ID, localização ou município..."
                                >
                            </div>

                            <select id="filtro-tipo" class="input" style="width: 150px;">
                                <option value="todos">Todos os Tipos</option>
                                <option value="V">Vértice</option>
                                <option value="M">RN</option>
                                <option value="P">Auxiliar</option>
                            </select>

                            <select id="filtro-status" class="input" style="width: 150px;">
                                <option value="todos">Todos Status</option>
                                <option value="validado">Validado</option>
                                <option value="pendente">Pendente</option>
                            </select>

                            <button class="btn btn-secondary" onclick="abrirModalImportarCSV()">
                                <i data-lucide="file-spreadsheet" style="width: 18px; height: 18px;"></i>
                                Importar CSV
                            </button>

                            <button class="btn btn-primary" onclick="buscarMarcos()">
                                <i data-lucide="search" style="width: 18px; height: 18px;"></i>
                                Buscar
                            </button>
                        </div>

                        <!-- Grid de Cards -->
                        <div id="marcos-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: var(--space-4);">
                            <!-- Cards serão inseridos aqui via JavaScript -->
                            <div style="grid-column: 1 / -1; text-align: center; padding: var(--space-16);">
                                <i data-lucide="loader-2" class="animate-spin" style="width: 48px; height: 48px; color: var(--text-tertiary); margin: 0 auto var(--space-4);"></i>
                                <p style="color: var(--text-secondary);">Carregando marcos...</p>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- ABA IMPORTAR MEMORIAL (DOCX) -->
                <div id="tab-importar" class="tab-content">
                    <div style="padding: var(--space-6);">
                        <div style="max-width: 800px; margin: 0 auto;">

                            <!-- Header -->
                            <div style="margin-bottom: var(--space-8);">
                                <h2 style="font-size: var(--text-2xl); font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-2);">
                                    Importar Memorial Descritivo
                                </h2>
                                <p style="color: var(--text-secondary); font-size: var(--text-base); margin-bottom: var(--space-4);">
                                    Faça upload de memoriais descritivos em formato Word (.docx) para extrair automaticamente os marcos geodésicos
                                </p>

                                <div class="alert" style="background-color: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);">
                                    <i data-lucide="info" style="color: #3B82F6;"></i>
                                    <div>
                                        <strong style="color: #3B82F6;">Importação de CSV</strong>
                                        <p style="font-size: var(--text-sm); color: var(--text-secondary); margin: 0;">
                                            Para importar arquivos CSV ou TXT com coordenadas, use o botão
                                            <strong>"Importar CSV"</strong> na aba "Buscar Marcos".
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload Area -->
                            <div id="upload-area-docx" class="upload-area" onclick="document.getElementById('file-input-docx').click()">
                                <input type="file" id="file-input-docx" accept=".docx,.doc" style="display: none;" onchange="handleFileSelectDOCX(event)">

                                <div class="upload-content">
                                    <i data-lucide="file-text" style="width: 64px; height: 64px; color: var(--cogep-green); margin-bottom: var(--space-4);"></i>

                                    <h3 style="font-size: var(--text-xl); font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-2);">
                                        Arraste seu memorial descritivo aqui
                                    </h3>

                                    <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">
                                        ou clique para selecionar
                                    </p>

                                    <button type="button" class="btn btn-primary" onclick="event.stopPropagation(); document.getElementById('file-input-docx').click()">
                                        <i data-lucide="file-plus"></i>
                                        Selecionar Arquivo DOCX
                                    </button>

                                    <p style="color: var(--text-tertiary); font-size: var(--text-sm); margin-top: var(--space-4);">
                                        Formatos aceitos: DOCX, DOC (máx. 10MB)
                                    </p>
                                </div>
                            </div>

                            <!-- Preview Area DOCX (inicialmente oculta) -->
                            <div id="preview-area-docx" style="display: none; margin-top: var(--space-6);">

                                <!-- Info do Arquivo -->
                                <div class="card" style="padding: var(--space-4); margin-bottom: var(--space-4);">
                                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                                        <i data-lucide="file-text" style="width: 24px; height: 24px; color: var(--cogep-green);"></i>
                                        <div style="flex: 1;">
                                            <strong id="file-name-docx" style="color: var(--text-primary); display: block;"></strong>
                                            <span id="file-info-docx" style="color: var(--text-secondary); font-size: var(--text-sm);"></span>
                                        </div>
                                        <button type="button" class="btn-icon" onclick="cancelarImportacaoDOCX()">
                                            <i data-lucide="x"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Status de Processamento -->
                                <div class="card" style="padding: var(--space-6); margin-bottom: var(--space-4);">
                                    <h3 style="font-size: var(--text-lg); font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-4);">
                                        Processamento do Memorial
                                    </h3>

                                    <div id="docx-status" style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                        <i data-lucide="loader-2" class="animate-spin" style="width: 24px; height: 24px; color: var(--cogep-green);"></i>
                                        <span style="color: var(--text-primary);">Extraindo marcos do documento...</span>
                                    </div>
                                </div>

                                <!-- Preview dos Marcos Extraídos -->
                                <div id="docx-marcos-preview" style="display: none;">
                                    <div class="card" style="padding: var(--space-6); margin-bottom: var(--space-4);">
                                        <h3 style="font-size: var(--text-lg); font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-4);">
                                            Marcos Encontrados
                                        </h3>

                                        <div id="docx-preview-stats" style="display: flex; gap: var(--space-4); margin-bottom: var(--space-4); flex-wrap: wrap;">
                                            <div style="padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                                <span style="color: var(--text-tertiary); font-size: var(--text-sm);">Total Extraídos</span>
                                                <strong id="docx-preview-total" style="display: block; font-size: var(--text-xl); color: var(--text-primary);">0</strong>
                                            </div>
                                            <div style="padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                                <span style="color: var(--text-tertiary); font-size: var(--text-sm);">Válidos</span>
                                                <strong id="docx-preview-validos" style="display: block; font-size: var(--text-xl); color: #10B981;">0</strong>
                                            </div>
                                        </div>

                                        <div id="docx-preview-table-container" style="overflow-x: auto; border: 1px solid var(--border-primary); border-radius: var(--radius-md);">
                                            <table id="docx-preview-table" style="width: 100%; border-collapse: collapse;">
                                                <!-- Preenchido via JavaScript -->
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Botões de Ação -->
                                    <div style="display: flex; gap: var(--space-3); justify-content: flex-end;">
                                        <button type="button" class="btn btn-secondary" onclick="cancelarImportacaoDOCX()">
                                            Cancelar
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="importarMarcosDOCX()" id="btn-importar-docx">
                                            <i data-lucide="upload"></i>
                                            Importar <span id="docx-import-count"></span> Marcos
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Funcionalidade ainda não implementada -->
                            <div style="margin-top: var(--space-8); padding: var(--space-6); background: var(--bg-secondary); border-radius: var(--radius-lg); text-align: center;">
                                <i data-lucide="wrench" style="width: 48px; height: 48px; color: var(--text-tertiary); margin-bottom: var(--space-3);"></i>
                                <h3 style="font-size: var(--text-lg); font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-2);">
                                    Em Desenvolvimento
                                </h3>
                                <p style="color: var(--text-secondary); max-width: 500px; margin: 0 auto;">
                                    A extração automática de marcos de memoriais descritivos (.docx) está em desenvolvimento.
                                    Por enquanto, use a importação de CSV na aba "Buscar Marcos".
                                </p>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- ABA PROPRIEDADES -->
                <div id="tab-propriedades" class="tab-content">
                    <div style="max-width: 1200px; margin: 0 auto;">

                        <!-- Header -->
                        <div style="margin-bottom: var(--space-6);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                                <div>
                                    <h2 style="font-size: var(--text-3xl); font-weight: var(--weight-heavy); color: var(--text-primary); margin-bottom: var(--space-2);">
                                        Propriedades
                                    </h2>
                                    <p style="color: var(--text-secondary); font-size: var(--text-base);">
                                        Gerencie propriedades rurais e urbanas cadastradas no sistema
                                    </p>
                                </div>
                                <button class="btn btn-primary" onclick="abrirModalNovaPropriedade()">
                                    <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
                                    Nova Propriedade
                                </button>
                            </div>

                            <!-- Filtros e Busca -->
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: var(--space-3); margin-top: var(--space-4);">
                                <!-- Busca -->
                                <div class="search-wrapper">
                                    <i data-lucide="search" class="search-icon"></i>
                                    <input
                                        type="text"
                                        id="busca-propriedade"
                                        class="input input-search"
                                        placeholder="Buscar por nome, matrícula ou município..."
                                        onkeyup="filtrarPropriedades()"
                                    >
                                </div>

                                <!-- Filtro Tipo -->
                                <div class="input-group">
                                    <select class="input" id="filtro-tipo-propriedade" onchange="filtrarPropriedades()">
                                        <option value="">Todos os tipos</option>
                                        <option value="RURAL">Rural</option>
                                        <option value="URBANA">Urbana</option>
                                    </select>
                                </div>

                                <!-- Filtro Município -->
                                <div class="input-group">
                                    <select class="input" id="filtro-municipio-propriedade" onchange="filtrarPropriedades()">
                                        <option value="">Todos municípios</option>
                                        <!-- Será preenchido dinamicamente -->
                                    </select>
                                </div>

                                <!-- Botão Limpar -->
                                <button class="btn btn-secondary" onclick="limparFiltrosPropriedades()" title="Limpar filtros">
                                    <i data-lucide="x" style="width: 18px; height: 18px;"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Grid de Cards -->
                        <div id="propriedades-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: var(--space-4);">
                            <!-- Cards serão inseridos aqui via JavaScript -->
                        </div>

                        <!-- Loading State -->
                        <div id="propriedades-loading" style="display: none; text-align: center; padding: var(--space-12); color: var(--text-secondary);">
                            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-primary); border-top-color: var(--cogep-green); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: var(--space-4); font-size: var(--text-lg);">Carregando propriedades...</p>
                        </div>

                        <!-- Empty State -->
                        <div id="propriedades-empty" style="display: none; text-align: center; padding: var(--space-12); color: var(--text-secondary);">
                            <i data-lucide="building-2" style="width: 64px; height: 64px; margin-bottom: var(--space-4); opacity: 0.3;"></i>
                            <h3 style="font-size: var(--text-xl); font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-2);">
                                Nenhuma propriedade encontrada
                            </h3>
                            <p style="margin-bottom: var(--space-6);">
                                Comece cadastrando a primeira propriedade do sistema
                            </p>
                            <button class="btn btn-primary" onclick="abrirModalNovaPropriedade()">
                                <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
                                Cadastrar Primeira Propriedade
                            </button>
                        </div>

                    </div>
                </div>

                <!-- ABA CLIENTES -->
                <div id="tab-clientes" class="tab-content">
                    <div style="padding: var(--space-6);">

                        <!-- Header -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6);">
                            <div>
                                <h2 style="font-size: var(--text-3xl); font-weight: var(--weight-heavy); color: var(--text-primary); margin-bottom: var(--space-2);">
                                    Clientes
                                </h2>
                                <p style="color: var(--text-secondary);">
                                    Gerencie sua carteira de clientes
                                </p>
                            </div>
                            <button class="btn btn-primary" onclick="abrirModalNovoCliente()">
                                <i data-lucide="user-plus" style="width: 18px; height: 18px;"></i>
                                Novo Cliente
                            </button>
                        </div>

                        <!-- Barra de Busca -->
                        <div style="display: flex; gap: var(--space-4); margin-bottom: var(--space-6);">
                            <div class="search-wrapper" style="flex: 1;">
                                <i data-lucide="search" class="search-icon"></i>
                                <input type="text" class="input input-search" placeholder="Buscar cliente por nome, CPF/CNPJ...">
                            </div>
                            <button class="btn btn-secondary">
                                <i data-lucide="filter" style="width: 18px; height: 18px;"></i>
                                Filtros
                            </button>
                        </div>

                        <!-- Lista de Clientes -->
                        <div id="clientes-lista" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: var(--space-4);">

                            <!-- Card de Cliente Exemplo -->
                            <div class="card" style="padding: var(--space-5);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-4);">
                                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                                        <div style="width: 48px; height: 48px; border-radius: var(--radius-full); background-color: var(--cogep-green); color: white; display: flex; align-items: center; justify-content: center; font-size: var(--text-xl); font-weight: var(--weight-heavy);">
                                            JS
                                        </div>
                                        <div>
                                            <h3 style="font-size: var(--text-lg); font-weight: var(--weight-bold); color: var(--text-primary);">
                                                João Silva
                                            </h3>
                                            <p style="font-size: var(--text-sm); color: var(--text-secondary);">
                                                CPF: 123.456.789-00
                                            </p>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: var(--space-2);">
                                        <button class="btn btn-icon btn-ghost">
                                            <i data-lucide="edit" style="width: 18px; height: 18px;"></i>
                                        </button>
                                    </div>
                                </div>

                                <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                    <div class="marco-info-row">
                                        <i data-lucide="mail"></i>
                                        <span>joao.silva@email.com</span>
                                    </div>
                                    <div class="marco-info-row">
                                        <i data-lucide="phone"></i>
                                        <span>(41) 99999-9999</span>
                                    </div>
                                    <div class="marco-info-row">
                                        <i data-lucide="building-2"></i>
                                        <span>3 propriedades</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Placeholder vazio -->
                            <div style="grid-column: 1 / -1; text-align: center; padding: var(--space-8); color: var(--text-secondary);">
                                <i data-lucide="users" style="width: 48px; height: 48px; margin-bottom: var(--space-4); opacity: 0.5;"></i>
                                <p>Nenhum cliente cadastrado ainda</p>
                                <button class="btn btn-primary" style="margin-top: var(--space-4);" onclick="abrirModalNovoCliente()">
                                    <i data-lucide="user-plus" style="width: 18px; height: 18px;"></i>
                                    Cadastrar primeiro cliente
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- ABA HISTÓRICO -->
                <div id="tab-historico" class="tab-content">
                    <div style="padding: var(--space-6);">

                        <!-- Header -->
                        <div style="margin-bottom: var(--space-6);">
                            <h2 style="font-size: var(--text-3xl); font-weight: var(--weight-heavy); color: var(--text-primary); margin-bottom: var(--space-2);">
                                Histórico de Atividades
                            </h2>
                            <p style="color: var(--text-secondary);">
                                Acompanhe todas as importações e alterações do sistema
                            </p>
                        </div>

                        <!-- Filtros -->
                        <div style="display: flex; gap: var(--space-4); margin-bottom: var(--space-6);">
                            <div class="search-wrapper" style="flex: 1;">
                                <i data-lucide="search" class="search-icon"></i>
                                <input type="text" class="input input-search" placeholder="Buscar no histórico...">
                            </div>
                            <select class="input" style="width: 200px;">
                                <option value="">Todas as ações</option>
                                <option value="importacao">Importações</option>
                                <option value="criacao">Criações</option>
                                <option value="edicao">Edições</option>
                                <option value="exclusao">Exclusões</option>
                            </select>
                            <input type="date" class="input" style="width: 180px;">
                        </div>

                        <!-- Timeline de Histórico -->
                        <div id="historico-timeline" style="position: relative;">

                            <!-- Item de Histórico -->
                            <div style="display: flex; gap: var(--space-4); padding: var(--space-5); border-bottom: 1px solid var(--border-primary);">
                                <div style="width: 48px; height: 48px; border-radius: var(--radius-full); background-color: rgba(0, 168, 89, 0.1); color: var(--cogep-green); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i data-lucide="upload" style="width: 24px; height: 24px;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-2);">
                                        <div>
                                            <h3 style="font-size: var(--text-base); font-weight: var(--weight-bold); color: var(--text-primary);">
                                                Importação de Memorial Descritivo
                                            </h3>
                                            <p style="font-size: var(--text-sm); color: var(--text-secondary); margin-top: var(--space-1);">
                                                218 marcos importados com sucesso
                                            </p>
                                        </div>
                                        <span style="font-size: var(--text-sm); color: var(--text-tertiary); white-space: nowrap;">
                                            Há 2 horas
                                        </span>
                                    </div>
                                    <div style="display: flex; gap: var(--space-2); margin-top: var(--space-3);">
                                        <span class="marco-badge badge-sucesso">
                                            <i data-lucide="check" style="width: 12px; height: 12px;"></i>
                                            Sucesso
                                        </span>
                                        <span class="marco-badge">
                                            arquivo_memorial_2024.csv
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Item de Histórico -->
                            <div style="display: flex; gap: var(--space-4); padding: var(--space-5); border-bottom: 1px solid var(--border-primary);">
                                <div style="width: 48px; height: 48px; border-radius: var(--radius-full); background-color: rgba(59, 130, 246, 0.1); color: #3B82F6; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i data-lucide="edit" style="width: 24px; height: 24px;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-2);">
                                        <div>
                                            <h3 style="font-size: var(--text-base); font-weight: var(--weight-bold); color: var(--text-primary);">
                                                Marco V-042 atualizado
                                            </h3>
                                            <p style="font-size: var(--text-sm); color: var(--text-secondary); margin-top: var(--space-1);">
                                                Coordenadas corrigidas manualmente
                                            </p>
                                        </div>
                                        <span style="font-size: var(--text-sm); color: var(--text-tertiary); white-space: nowrap;">
                                            Ontem
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Item de Histórico -->
                            <div style="display: flex; gap: var(--space-4); padding: var(--space-5); border-bottom: 1px solid var(--border-primary);">
                                <div style="width: 48px; height: 48px; border-radius: var(--radius-full); background-color: rgba(245, 158, 11, 0.1); color: #F59E0B; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i data-lucide="plus-circle" style="width: 24px; height: 24px;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-2);">
                                        <div>
                                            <h3 style="font-size: var(--text-base); font-weight: var(--weight-bold); color: var(--text-primary);">
                                                Nova propriedade cadastrada
                                            </h3>
                                            <p style="font-size: var(--text-sm); color: var(--text-secondary); margin-top: var(--space-1);">
                                                Fazenda Santa Rita - Matrícula 12.345
                                            </p>
                                        </div>
                                        <span style="font-size: var(--text-sm); color: var(--text-tertiary); white-space: nowrap;">
                                            3 dias atrás
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Placeholder vazio -->
                            <div style="text-align: center; padding: var(--space-8); color: var(--text-secondary);">
                                <i data-lucide="clock" style="width: 48px; height: 48px; margin-bottom: var(--space-4); opacity: 0.5;"></i>
                                <p>Nenhuma atividade registrada ainda</p>
                            </div>

                        </div>

                    </div>
                </div>

            </div>

        </main>

    </div>

    <!-- SCRIPTS -->
    <script src="script.js"></script>
    <script>
        // Inicializar Lucide Icons
        lucide.createIcons();

        // Toggle Theme
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Update icon
            const icon = document.getElementById('theme-icon');
            icon.setAttribute('data-lucide', newTheme === 'light' ? 'moon' : 'sun');
            lucide.createIcons();
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Update icon on load
        const themeIcon = document.getElementById('theme-icon');
        themeIcon.setAttribute('data-lucide', savedTheme === 'light' ? 'moon' : 'sun');

        // Tab Navigation
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');

                // Update buttons
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');

                // Update content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById('tab-' + tabName).classList.add('active');

                // Update sidebar
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                document.querySelector('.nav-link[data-tab="' + tabName + '"]').classList.add('active');
            });
        });

        // Sidebar Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = link.getAttribute('data-tab');

                // Trigger tab button click
                document.querySelector('.tab-button[data-tab="' + tabName + '"]').click();
            });
        });

        // ========================================
        // ESTADO GLOBAL DA APLICAÇÃO
        // ========================================

        const AppState = {
            marcos: [],
            marcosLoaded: false,
            currentFilter: {
                tipo: 'todos',
                status: 'todos',
                busca: ''
            }
        };

        // ========================================
        // CARREGAR MARCOS DO BACKEND
        // ========================================

        async function carregarMarcosLista() {
            try {
                console.log('🔄 Carregando marcos da API...');

                const response = await fetch('http://localhost:3001/api/marcos?levantados=true&limite=1000');

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status}`);
                }

                const data = await response.json();
                AppState.marcos = data.data || [];
                AppState.marcosLoaded = true;

                console.log(`✅ ${AppState.marcos.length} marcos carregados`);

                // Atualizar estatísticas
                atualizarEstatisticas();

                // Renderizar cards
                renderizarCardsMarcos();

            } catch (error) {
                console.error('❌ Erro ao carregar marcos:', error);
                mostrarErro('Não foi possível carregar os marcos. Verifique se o backend está rodando.');
            }
        }

        // ========================================
        // ATUALIZAR ESTATÍSTICAS
        // ========================================

        function atualizarEstatisticas() {
            const total = AppState.marcos.length;
            const levantados = AppState.marcos.filter(m => m.levantado).length;

            // Atualizar cards de estatísticas
            const statElements = document.querySelectorAll('.stat-value span');
            if (statElements[0]) statElements[0].textContent = total;
            if (statElements[1]) statElements[1].textContent = levantados;
        }

        // ========================================
        // RENDERIZAR CARDS DE MARCOS
        // ========================================

        function renderizarCardsMarcos() {
            const container = document.getElementById('marcos-grid');

            if (!container) {
                console.warn('Container marcos-grid não encontrado');
                return;
            }

            // Filtrar marcos
            const marcosFiltrados = filtrarMarcos();

            if (marcosFiltrados.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: var(--space-16);">
                        <i data-lucide="search-x" style="width: 64px; height: 64px; color: var(--text-tertiary); margin: 0 auto var(--space-4);"></i>
                        <p style="color: var(--text-secondary); font-size: var(--text-lg);">Nenhum marco encontrado</p>
                        <p style="color: var(--text-tertiary); font-size: var(--text-sm); margin-top: var(--space-2);">
                            Tente ajustar os filtros ou buscar por outro termo
                        </p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = marcosFiltrados.map(marco => criarCardMarco(marco)).join('');

            // Reinicializar ícones Lucide
            lucide.createIcons();

            // Adicionar event listeners aos cards
            adicionarEventListenersCards();
        }

        // ========================================
        // CRIAR HTML DO CARD DE MARCO
        // ========================================

        function criarCardMarco(marco) {
            const tipo = determinarTipo(marco.tipo);
            const status = determinarStatus(marco);
            const coordenadas = formatarCoordenadas(marco);

            return `
                <div class="marco-card animate-fade-in-up" data-marco-id="${marco.id}" onclick="centralizarMarcoNoMapa(${marco.id})">
                    <div class="marco-card-header">
                        <div class="marco-card-id">
                            <i data-lucide="${tipo.icon}"></i>
                            ${marco.identificador || marco.id}
                        </div>
                        <span class="marco-badge badge-${tipo.classe}">
                            <i data-lucide="${tipo.icon}"></i>
                            ${tipo.nome}
                        </span>
                    </div>

                    <div class="marco-card-body">
                        ${marco.localizacao ? `
                            <div class="marco-info-row">
                                <i data-lucide="building-2"></i>
                                <span>${marco.localizacao}</span>
                            </div>
                        ` : ''}

                        ${marco.municipio ? `
                            <div class="marco-info-row">
                                <i data-lucide="map-pin"></i>
                                <span>${marco.municipio} - ${marco.estado || 'PR'}</span>
                            </div>
                        ` : ''}

                        ${marco.altitude ? `
                            <div class="marco-info-row">
                                <i data-lucide="mountain"></i>
                                <span>Altitude: <strong>${marco.altitude}m</strong></span>
                            </div>
                        ` : ''}

                        <div class="marco-info-row">
                            <i data-lucide="${status.icon}"></i>
                            <span class="marco-status status-${status.classe}">
                                <strong>${status.texto}</strong>
                            </span>
                        </div>

                        ${coordenadas ? `
                            <div class="marco-coordinates">
                                <div>
                                    <span><strong>E:</strong> ${coordenadas.e}</span>
                                </div>
                                <div>
                                    <span><strong>N:</strong> ${coordenadas.n}</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ========================================
        // FUNÇÕES AUXILIARES
        // ========================================

        function determinarTipo(tipo) {
            const tipos = {
                'V': { nome: 'Vértice', icon: 'triangle', classe: 'vertice' },
                'M': { nome: 'RN', icon: 'milestone', classe: 'rn' },
                'P': { nome: 'Auxiliar', icon: 'circle-dot', classe: 'auxiliar' }
            };

            return tipos[tipo] || tipos['V'];
        }

        function determinarStatus(marco) {
            if (marco.validado) {
                return { texto: 'Validado', icon: 'check-circle', classe: 'validado' };
            } else if (marco.levantado) {
                return { texto: 'Pendente Revisão', icon: 'alert-circle', classe: 'pendente' };
            } else {
                return { texto: 'Não Levantado', icon: 'clock', classe: 'pendente' };
            }
        }

        function formatarCoordenadas(marco) {
            if (!marco.coord_utm_e || !marco.coord_utm_n) {
                return null;
            }

            return {
                e: Number(marco.coord_utm_e).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }) + ' m',
                n: Number(marco.coord_utm_n).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }) + ' m'
            };
        }

        // ========================================
        // FILTRAR MARCOS
        // ========================================

        function filtrarMarcos() {
            return AppState.marcos.filter(marco => {
                // Filtro de tipo
                if (AppState.currentFilter.tipo !== 'todos' && marco.tipo !== AppState.currentFilter.tipo) {
                    return false;
                }

                // Filtro de status
                if (AppState.currentFilter.status === 'validado' && !marco.validado) {
                    return false;
                }
                if (AppState.currentFilter.status === 'pendente' && marco.validado) {
                    return false;
                }

                // Filtro de busca
                if (AppState.currentFilter.busca) {
                    const busca = AppState.currentFilter.busca.toLowerCase();
                    const identificador = (marco.identificador || '').toLowerCase();
                    const localizacao = (marco.localizacao || '').toLowerCase();
                    const municipio = (marco.municipio || '').toLowerCase();

                    return identificador.includes(busca) ||
                           localizacao.includes(busca) ||
                           municipio.includes(busca);
                }

                return true;
            });
        }

        // ========================================
        // APLICAR FILTROS
        // ========================================

        function aplicarFiltros() {
            // Pegar valores dos filtros
            const tipoSelect = document.getElementById('filtro-tipo');
            const statusSelect = document.getElementById('filtro-status');
            const buscaInput = document.getElementById('busca-marcos');

            if (tipoSelect) {
                AppState.currentFilter.tipo = tipoSelect.value;
            }

            if (statusSelect) {
                AppState.currentFilter.status = statusSelect.value;
            }

            if (buscaInput) {
                AppState.currentFilter.busca = buscaInput.value;
            }

            // Renderizar novamente
            renderizarCardsMarcos();
        }

        // ========================================
        // BUSCAR MARCOS (FUNÇÃO PÚBLICA)
        // ========================================

        function buscarMarcos() {
            aplicarFiltros();
        }

        // ========================================
        // CENTRALIZAR MARCO NO MAPA
        // ========================================

        function centralizarMarcoNoMapa(marcoId) {
            const marco = AppState.marcos.find(m => m.id === marcoId);

            if (!marco || !marco.latitude || !marco.longitude) {
                console.warn('Marco sem coordenadas:', marcoId);
                return;
            }

            // Mudar para aba do mapa
            const tabButton = document.querySelector('.tab-button[data-tab="mapa"]');
            if (tabButton) {
                tabButton.click();
            }

            // Aguardar transição e centralizar
            setTimeout(() => {
                if (window.mapa) {
                    window.mapa.setView([marco.latitude, marco.longitude], 18);
                    console.log('🎯 Mapa centralizado no marco:', marco.identificador || marco.id);
                }
            }, 300);
        }

        // ========================================
        // ADICIONAR EVENT LISTENERS AOS CARDS
        // ========================================

        function adicionarEventListenersCards() {
            document.querySelectorAll('.marco-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    const marcoId = this.dataset.marcoId;
                    // Futuramente: destacar marcador no mapa
                });

                card.addEventListener('mouseleave', function() {
                    // Futuramente: remover destaque do marcador
                });
            });
        }

        // ========================================
        // MOSTRAR ERRO
        // ========================================

        function mostrarErro(mensagem) {
            const container = document.getElementById('marcos-grid');
            if (container) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: var(--space-16);">
                        <i data-lucide="alert-triangle" style="width: 64px; height: 64px; color: #EF4444; margin: 0 auto var(--space-4);"></i>
                        <p style="color: #EF4444; font-size: var(--text-lg); font-weight: var(--weight-bold);">Erro ao carregar dados</p>
                        <p style="color: var(--text-secondary); font-size: var(--text-sm); margin-top: var(--space-2);">
                            ${mensagem}
                        </p>
                        <button class="btn btn-primary" onclick="carregarMarcosLista()" style="margin-top: var(--space-4);">
                            <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                            Tentar Novamente
                        </button>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // ========================================
        // PLACEHOLDER FUNCTIONS (outras abas)
        // ========================================

        function abrirModalNovoMarco() {
            console.log('🔧 Modal de Novo Marco - Em desenvolvimento');
            alert('Funcionalidade em desenvolvimento\nModal de Novo Marco será implementado em breve.');
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                console.log('📄 Arquivo selecionado:', file.name);
                alert(`Arquivo selecionado: ${file.name}\n\nFuncionalidade de importação será implementada em breve.`);
            }
        }

        function iniciarImportacao() {
            const sistemaCoords = document.getElementById('sistema-coords').value;
            const fusoUtm = document.getElementById('fuso-utm').value;
            const nomeProjeto = document.getElementById('nome-projeto').value;

            console.log('📤 Iniciando importação...', { sistemaCoords, fusoUtm, nomeProjeto });
            alert('Funcionalidade em desenvolvimento\nImportação de memorial será implementada em breve.');
        }

        function abrirModalNovaPropriedade() {
            console.log('🏢 Modal de Nova Propriedade - Em desenvolvimento');
            alert('Funcionalidade em desenvolvimento\nModal de Nova Propriedade será implementado em breve.');
        }

        function abrirModalNovoCliente() {
            console.log('👤 Modal de Novo Cliente - Em desenvolvimento');
            alert('Funcionalidade em desenvolvimento\nModal de Novo Cliente será implementado em breve.');
        }

        // ========================================
        // INICIALIZAÇÃO
        // ========================================

        // Carregar marcos quando a aba "Buscar Marcos" for aberta
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Sistema Premium COGEP inicializado');

            // Adicionar event listeners aos filtros
            const tipoSelect = document.getElementById('filtro-tipo');
            const statusSelect = document.getElementById('filtro-status');
            const buscaInput = document.getElementById('busca-marcos');

            if (tipoSelect) tipoSelect.addEventListener('change', aplicarFiltros);
            if (statusSelect) statusSelect.addEventListener('change', aplicarFiltros);
            if (buscaInput) {
                buscaInput.addEventListener('input', () => {
                    clearTimeout(window.buscaTimeout);
                    window.buscaTimeout = setTimeout(aplicarFiltros, 300);
                });
            }

            // Observar mudanças de aba
            observarMudancasDeAba();
        });

        // Observar mudanças de aba para carregar dados quando necessário
        function observarMudancasDeAba() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');

                    // Se mudou para aba "Buscar Marcos" e ainda não carregou
                    if (tabName === 'marcos' && !AppState.marcosLoaded) {
                        setTimeout(() => {
                            carregarMarcosLista();
                        }, 100);
                    }
                });
            });
        }
    </script>

    <!-- ========================================
         MODALS DO SISTEMA
         ======================================== -->

    <!-- Modal: Novo Marco -->
    <div id="modal-novo-marco" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="fecharModal('modal-novo-marco')"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-lucide="plus-circle"></i>
                    Novo Marco Geodésico
                </h2>
                <button class="btn-icon" onclick="fecharModal('modal-novo-marco')">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <form id="form-novo-marco" onsubmit="return false;">
                <div class="modal-body">

                    <!-- Tipo de Marco -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Tipo de Marco *
                                <span class="form-hint">Vértice, RN ou Auxiliar</span>
                            </label>
                            <select name="tipo" class="input" required>
                                <option value="">Selecione o tipo</option>
                                <option value="V">Vértice</option>
                                <option value="M">Referência de Nível (RN)</option>
                                <option value="P">Ponto Auxiliar</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                Identificador *
                                <span class="form-hint">Ex: FHV-M-0001</span>
                            </label>
                            <input type="text" name="identificador" class="input"
                                   placeholder="FHV-M-0001" required>
                        </div>
                    </div>

                    <!-- Localização -->
                    <div class="form-group">
                        <label class="form-label">
                            Localização *
                            <span class="form-hint">Descrição do local onde está o marco</span>
                        </label>
                        <input type="text" name="localizacao" class="input"
                               placeholder="Ex: Edifício Central - Sala 105" required>
                    </div>

                    <!-- Município e Estado -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Município *</label>
                            <input type="text" name="municipio" class="input"
                                   placeholder="Ex: Curitiba" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Estado *</label>
                            <select name="estado" class="input" required>
                                <option value="PR" selected>Paraná</option>
                                <option value="SP">São Paulo</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="RJ">Rio de Janeiro</option>
                            </select>
                        </div>
                    </div>

                    <!-- Sistema de Coordenadas -->
                    <div class="form-group">
                        <label class="form-label">
                            Sistema de Coordenadas *
                        </label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="sistema_coord" value="utm" checked onchange="toggleCoordSystem()">
                                <span>UTM (SIRGAS2000)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="sistema_coord" value="geo" onchange="toggleCoordSystem()">
                                <span>Lat/Long (Decimal)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Coordenadas UTM -->
                    <div id="coords-utm" class="coords-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    Coordenada E (m) *
                                    <span class="form-hint">Este/Leste</span>
                                </label>
                                <input type="number" name="coord_utm_e" class="input"
                                       placeholder="687234.56" step="0.01">
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Coordenada N (m) *
                                    <span class="form-hint">Norte</span>
                                </label>
                                <input type="number" name="coord_utm_n" class="input"
                                       placeholder="7123456.78" step="0.01">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Fuso UTM</label>
                            <select name="fuso_utm" class="input">
                                <option value="22" selected>22S (SIRGAS2000)</option>
                                <option value="21">21S (SIRGAS2000)</option>
                                <option value="23">23S (SIRGAS2000)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Coordenadas Geográficas -->
                    <div id="coords-geo" class="coords-section" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    Latitude *
                                    <span class="form-hint">Decimal (-90 a 90)</span>
                                </label>
                                <input type="number" name="latitude" class="input"
                                       placeholder="-25.4284" step="0.000001">
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Longitude *
                                    <span class="form-hint">Decimal (-180 a 180)</span>
                                </label>
                                <input type="number" name="longitude" class="input"
                                       placeholder="-49.2733" step="0.000001">
                            </div>
                        </div>
                    </div>

                    <!-- Altitude -->
                    <div class="form-group">
                        <label class="form-label">
                            Altitude (m)
                            <span class="form-hint">Opcional</span>
                        </label>
                        <input type="number" name="altitude" class="input"
                               placeholder="830.430" step="0.001">
                    </div>

                    <!-- Observações -->
                    <div class="form-group">
                        <label class="form-label">
                            Observações
                            <span class="form-hint">Informações adicionais</span>
                        </label>
                        <textarea name="observacoes" class="input" rows="3"
                                  placeholder="Informações adicionais sobre o marco..."></textarea>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            onclick="fecharModal('modal-novo-marco')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary"
                            onclick="salvarNovoMarco(event)">
                        <i data-lucide="check"></i>
                        Criar Marco
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Editar Marco -->
    <div id="modal-editar-marco" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="fecharModal('modal-editar-marco')"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-lucide="edit"></i>
                    Editar Marco Geodésico
                </h2>
                <button class="btn-icon" onclick="fecharModal('modal-editar-marco')">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <form id="form-editar-marco" onsubmit="return false;">
                <input type="hidden" name="id" id="edit-marco-id">

                <div class="modal-body">
                    <!-- Conteúdo será preenchido dinamicamente -->
                    <div id="form-editar-content"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            onclick="fecharModal('modal-editar-marco')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary"
                            onclick="salvarEdicaoMarco(event)">
                        <i data-lucide="save"></i>
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Confirmar Exclusão -->
    <div id="modal-excluir-marco" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="fecharModal('modal-excluir-marco')"></div>
        <div class="modal-container modal-sm">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-lucide="alert-triangle" style="color: #EF4444;"></i>
                    Confirmar Exclusão
                </h2>
                <button class="btn-icon" onclick="fecharModal('modal-excluir-marco')">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">
                    Tem certeza que deseja excluir o marco:
                </p>
                <div class="alert alert-warning">
                    <i data-lucide="map-pin"></i>
                    <div>
                        <strong id="excluir-marco-id"></strong>
                        <p id="excluir-marco-localizacao"></p>
                    </div>
                </div>
                <p style="color: #EF4444; font-size: var(--text-sm); margin-top: var(--space-4);">
                    ⚠️ Esta ação não pode ser desfeita.
                </p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                        onclick="fecharModal('modal-excluir-marco')">
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger"
                        onclick="confirmarExclusaoMarco()">
                    <i data-lucide="trash-2"></i>
                    Sim, Excluir
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Importar CSV -->
    <div id="modal-importar-csv" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="fecharModal('modal-importar-csv')"></div>
        <div class="modal-container" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-lucide="file-spreadsheet"></i>
                    Importar Marcos (CSV/TXT)
                </h2>
                <button class="btn-icon" onclick="fecharModal('modal-importar-csv')">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <div class="modal-body" style="overflow-y: auto; padding: 0;">
                <!-- Sistema de Importação CSV -->
                <div id="csv-import-content" style="padding: var(--space-6);">

                    <!-- Header -->
                    <div style="margin-bottom: var(--space-6);">
                        <p style="color: var(--text-secondary); font-size: var(--text-base);">
                            Importe arquivos CSV ou TXT com as coordenadas dos marcos geodésicos
                        </p>
                    </div>

                    <!-- Upload Area -->
                    <div id="upload-area" class="upload-area">
                        <input type="file" id="file-input-importar" accept=".csv,.txt" style="display: none;" onchange="handleFileSelect(event)">

                        <div class="upload-content">
                            <i data-lucide="upload-cloud" style="width: 64px; height: 64px; color: var(--cogep-green); margin-bottom: var(--space-4);"></i>

                            <h3 style="font-size: var(--text-xl); font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-2);">
                                Arraste seu arquivo aqui
                            </h3>

                            <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">
                                ou clique para selecionar
                            </p>

                            <button type="button" class="btn btn-primary" onclick="document.getElementById('file-input-importar').click()">
                                <i data-lucide="file-plus"></i>
                                Selecionar Arquivo
                            </button>

                            <p style="color: var(--text-tertiary); font-size: var(--text-sm); margin-top: var(--space-4);">
                                Formatos aceitos: CSV, TXT (máx. 10MB)
                            </p>
                        </div>
                    </div>

                    <!-- Preview Area (inicialmente oculta) -->
                    <div id="preview-area" style="display: none; margin-top: var(--space-6);">

                        <!-- Info do Arquivo -->
                        <div class="card" style="padding: var(--space-4); margin-bottom: var(--space-4);">
                            <div style="display: flex; align-items: center; gap: var(--space-3);">
                                <i data-lucide="file-text" style="width: 24px; height: 24px; color: var(--cogep-green);"></i>
                                <div style="flex: 1;">
                                    <strong id="file-name" style="color: var(--text-primary); display: block;"></strong>
                                    <span id="file-info" style="color: var(--text-secondary); font-size: var(--text-sm);"></span>
                                </div>
                                <button type="button" class="btn-icon" onclick="cancelarImportacao()">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Configurações de Importação -->
                        <div class="card" style="padding: var(--space-6); margin-bottom: var(--space-4);">
                            <h3 style="font-size: var(--text-lg); font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-4);">
                                Configurações de Importação
                            </h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Sistema de Coordenadas</label>
                                    <select id="import-coord-system" class="input">
                                        <option value="utm">UTM (E, N)</option>
                                        <option value="geo">Lat/Long (Decimal)</option>
                                        <option value="geo-dms">Lat/Long (Graus, Min, Seg)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Fuso UTM</label>
                                    <select id="import-fuso" class="input">
                                        <option value="22" selected>22S (SIRGAS2000)</option>
                                        <option value="21">21S (SIRGAS2000)</option>
                                        <option value="23">23S (SIRGAS2000)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Separador de Colunas</label>
                                    <select id="import-separator" class="input">
                                        <option value="," selected>Vírgula (,)</option>
                                        <option value=";">Ponto e vírgula (;)</option>
                                        <option value="	">Tab</option>
                                        <option value="|">Pipe (|)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="checkbox" id="import-has-header" checked>
                                        Primeira linha é cabeçalho
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Preview da Tabela -->
                        <div class="card" style="padding: var(--space-6); margin-bottom: var(--space-4);">
                            <h3 style="font-size: var(--text-lg); font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-4);">
                                Preview dos Dados
                            </h3>

                            <div id="preview-stats" style="display: flex; gap: var(--space-4); margin-bottom: var(--space-4); flex-wrap: wrap;">
                                <div style="padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                    <span style="color: var(--text-tertiary); font-size: var(--text-sm);">Total de Linhas</span>
                                    <strong id="preview-total" style="display: block; font-size: var(--text-xl); color: var(--text-primary);">0</strong>
                                </div>
                                <div style="padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                    <span style="color: var(--text-tertiary); font-size: var(--text-sm);">Válidos</span>
                                    <strong id="preview-validos" style="display: block; font-size: var(--text-xl); color: #10B981;">0</strong>
                                </div>
                                <div style="padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
                                    <span style="color: var(--text-tertiary); font-size: var(--text-sm);">Com Erros</span>
                                    <strong id="preview-erros" style="display: block; font-size: var(--text-xl); color: #EF4444;">0</strong>
                                </div>
                            </div>

                            <div style="overflow-x: auto; border: 1px solid var(--border-primary); border-radius: var(--radius-md);">
                                <table id="preview-table" style="width: 100%; border-collapse: collapse;">
                                    <!-- Preenchido via JavaScript -->
                                </table>
                            </div>
                        </div>

                        <!-- Progress Bar (inicialmente oculta) -->
                        <div id="import-progress" style="display: none; margin-bottom: var(--space-4);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-2);">
                                <span style="color: var(--text-primary); font-weight: var(--weight-medium);">Importando marcos...</span>
                                <span id="progress-text" style="color: var(--text-secondary);">0%</span>
                            </div>
                            <div style="height: 8px; background: var(--bg-tertiary); border-radius: var(--radius-full); overflow: hidden;">
                                <div id="progress-bar" style="height: 100%; background: var(--cogep-green); width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        <!-- Botões de Ação -->
                        <div style="display: flex; gap: var(--space-3); justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="cancelarImportacao()">
                                Cancelar
                            </button>
                            <button type="button" class="btn btn-primary" onclick="iniciarImportacao()" id="btn-importar">
                                <i data-lucide="upload"></i>
                                Importar <span id="import-count"></span> Marcos
                            </button>
                        </div>
                    </div>

                    <!-- Resultado da Importação (inicialmente oculto) -->
                    <div id="import-resultado" style="display: none; margin-top: var(--space-6);">
                        <div class="card" style="padding: var(--space-6);">
                            <div style="text-align: center;">
                                <i data-lucide="check-circle" style="width: 64px; height: 64px; color: #10B981; margin-bottom: var(--space-4);"></i>
                                <h3 style="font-size: var(--text-2xl); font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-2);">
                                    Importação Concluída!
                                </h3>
                                <p id="resultado-mensagem" style="color: var(--text-secondary); font-size: var(--text-lg); margin-bottom: var(--space-6);"></p>

                                <div id="resultado-detalhes" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-4); margin-bottom: var(--space-6);"></div>

                                <button type="button" class="btn btn-primary" onclick="novaImportacao()">
                                    <i data-lucide="upload"></i>
                                    Nova Importação
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: NOVA PROPRIEDADE -->
    <div id="modal-nova-propriedade" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="fecharModal('modal-nova-propriedade')"></div>
        <div class="modal-container" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-lucide="building-2"></i>
                    Nova Propriedade
                </h2>
                <button class="btn-icon" onclick="fecharModal('modal-nova-propriedade')">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <form id="form-nova-propriedade" onsubmit="salvarNovaPropriedade(event)">
                <div class="modal-body">

                    <!-- Cliente (se houver sistema de clientes) -->
                    <div class="input-group">
                        <label class="label">Cliente</label>
                        <select class="input" id="nova-prop-cliente" name="cliente_id">
                            <option value="">Selecione o cliente (opcional)</option>
                            <!-- Será preenchido dinamicamente -->
                        </select>
                    </div>

                    <!-- Nome da Propriedade -->
                    <div class="input-group">
                        <label class="label">Nome da Propriedade *</label>
                        <input
                            type="text"
                            class="input"
                            id="nova-prop-nome"
                            name="nome_propriedade"
                            placeholder="Ex: Fazenda Santa Rita, Lote 15, etc."
                            required
                        >
                    </div>

                    <!-- Matrícula -->
                    <div class="input-group">
                        <label class="label">Matrícula *</label>
                        <input
                            type="text"
                            class="input"
                            id="nova-prop-matricula"
                            name="matricula"
                            placeholder="Ex: 12.345, MAT-2024-001"
                            required
                        >
                    </div>

                    <!-- Tipo -->
                    <div class="input-group">
                        <label class="label">Tipo de Propriedade *</label>
                        <select class="input" id="nova-prop-tipo" name="tipo" required>
                            <option value="">Selecione...</option>
                            <option value="RURAL">Rural</option>
                            <option value="URBANA">Urbana</option>
                        </select>
                    </div>

                    <!-- Grid: Município / Comarca / UF -->
                    <div style="display: grid; grid-template-columns: 2fr 2fr 1fr; gap: var(--space-3);">
                        <div class="input-group">
                            <label class="label">Município *</label>
                            <input
                                type="text"
                                class="input"
                                id="nova-prop-municipio"
                                name="municipio"
                                placeholder="Ex: Campo Largo"
                                required
                            >
                        </div>

                        <div class="input-group">
                            <label class="label">Comarca *</label>
                            <input
                                type="text"
                                class="input"
                                id="nova-prop-comarca"
                                name="comarca"
                                placeholder="Ex: Campo Largo"
                                required
                            >
                        </div>

                        <div class="input-group">
                            <label class="label">UF *</label>
                            <select class="input" id="nova-prop-uf" name="uf" required>
                                <option value="">UF</option>
                                <option value="PR" selected>PR</option>
                                <option value="SC">SC</option>
                                <option value="RS">RS</option>
                                <option value="SP">SP</option>
                                <option value="RJ">RJ</option>
                                <option value="MG">MG</option>
                                <option value="ES">ES</option>
                                <!-- Adicionar outros estados conforme necessário -->
                            </select>
                        </div>
                    </div>

                    <!-- Grid: Área / Perímetro -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                        <div class="input-group">
                            <label class="label">Área (m²)</label>
                            <input
                                type="number"
                                step="0.01"
                                class="input"
                                id="nova-prop-area"
                                name="area_m2"
                                placeholder="Ex: 50000.00"
                            >
                        </div>

                        <div class="input-group">
                            <label class="label">Perímetro (m)</label>
                            <input
                                type="number"
                                step="0.01"
                                class="input"
                                id="nova-prop-perimetro"
                                name="perimetro_m"
                                placeholder="Ex: 900.50"
                            >
                        </div>
                    </div>

                    <!-- Observações -->
                    <div class="input-group">
                        <label class="label">Observações</label>
                        <textarea
                            class="input"
                            id="nova-prop-observacoes"
                            name="observacoes"
                            rows="3"
                            placeholder="Informações adicionais sobre a propriedade..."
                        ></textarea>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal('modal-nova-propriedade')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="check" style="width: 18px; height: 18px;"></i>
                        Cadastrar Propriedade
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: EDITAR PROPRIEDADE -->
    <div id="modal-editar-propriedade" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="fecharModal('modal-editar-propriedade')"></div>
        <div class="modal-container" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-lucide="edit"></i>
                    Editar Propriedade
                </h2>
                <button class="btn-icon" onclick="fecharModal('modal-editar-propriedade')">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <form id="form-editar-propriedade" onsubmit="salvarEdicaoPropriedade(event)">
                <input type="hidden" id="editar-prop-id" name="id">

                <div class="modal-body">

                    <!-- Cliente -->
                    <div class="input-group">
                        <label class="label">Cliente</label>
                        <select class="input" id="editar-prop-cliente" name="cliente_id">
                            <option value="">Selecione o cliente (opcional)</option>
                            <!-- Será preenchido dinamicamente -->
                        </select>
                    </div>

                    <!-- Nome da Propriedade -->
                    <div class="input-group">
                        <label class="label">Nome da Propriedade *</label>
                        <input
                            type="text"
                            class="input"
                            id="editar-prop-nome"
                            name="nome_propriedade"
                            placeholder="Ex: Fazenda Santa Rita, Lote 15, etc."
                            required
                        >
                    </div>

                    <!-- Matrícula -->
                    <div class="input-group">
                        <label class="label">Matrícula *</label>
                        <input
                            type="text"
                            class="input"
                            id="editar-prop-matricula"
                            name="matricula"
                            placeholder="Ex: 12.345, MAT-2024-001"
                            required
                        >
                    </div>

                    <!-- Tipo -->
                    <div class="input-group">
                        <label class="label">Tipo de Propriedade *</label>
                        <select class="input" id="editar-prop-tipo" name="tipo" required>
                            <option value="">Selecione...</option>
                            <option value="RURAL">Rural</option>
                            <option value="URBANA">Urbana</option>
                        </select>
                    </div>

                    <!-- Grid: Município / Comarca / UF -->
                    <div style="display: grid; grid-template-columns: 2fr 2fr 1fr; gap: var(--space-3);">
                        <div class="input-group">
                            <label class="label">Município *</label>
                            <input
                                type="text"
                                class="input"
                                id="editar-prop-municipio"
                                name="municipio"
                                placeholder="Ex: Campo Largo"
                                required
                            >
                        </div>

                        <div class="input-group">
                            <label class="label">Comarca *</label>
                            <input
                                type="text"
                                class="input"
                                id="editar-prop-comarca"
                                name="comarca"
                                placeholder="Ex: Campo Largo"
                                required
                            >
                        </div>

                        <div class="input-group">
                            <label class="label">UF *</label>
                            <select class="input" id="editar-prop-uf" name="uf" required>
                                <option value="">UF</option>
                                <option value="PR">PR</option>
                                <option value="SC">SC</option>
                                <option value="RS">RS</option>
                                <option value="SP">SP</option>
                                <option value="RJ">RJ</option>
                                <option value="MG">MG</option>
                                <option value="ES">ES</option>
                            </select>
                        </div>
                    </div>

                    <!-- Grid: Área / Perímetro -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                        <div class="input-group">
                            <label class="label">Área (m²)</label>
                            <input
                                type="number"
                                step="0.01"
                                class="input"
                                id="editar-prop-area"
                                name="area_m2"
                                placeholder="Ex: 50000.00"
                            >
                        </div>

                        <div class="input-group">
                            <label class="label">Perímetro (m)</label>
                            <input
                                type="number"
                                step="0.01"
                                class="input"
                                id="editar-prop-perimetro"
                                name="perimetro_m"
                                placeholder="Ex: 900.50"
                            >
                        </div>
                    </div>

                    <!-- Observações -->
                    <div class="input-group">
                        <label class="label">Observações</label>
                        <textarea
                            class="input"
                            id="editar-prop-observacoes"
                            name="observacoes"
                            rows="3"
                            placeholder="Informações adicionais sobre a propriedade..."
                        ></textarea>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal('modal-editar-propriedade')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="check" style="width: 18px; height: 18px;"></i>
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: EXCLUIR PROPRIEDADE -->
    <div id="modal-excluir-propriedade" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="fecharModal('modal-excluir-propriedade')"></div>
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-lucide="alert-triangle"></i>
                    Confirmar Exclusão
                </h2>
                <button class="btn-icon" onclick="fecharModal('modal-excluir-propriedade')">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="alert" style="background-color: rgba(239, 68, 68, 0.1); border-left: 4px solid #EF4444;">
                    <i data-lucide="alert-triangle" style="color: #EF4444;"></i>
                    <div>
                        <strong style="color: #EF4444;">Atenção!</strong>
                        <p>Esta ação não pode ser desfeita. A propriedade será permanentemente removida do sistema.</p>
                    </div>
                </div>

                <div style="margin-top: var(--space-4); padding: var(--space-4); background-color: var(--bg-secondary); border-radius: var(--radius-md);">
                    <p style="margin-bottom: var(--space-2); color: var(--text-secondary); font-size: var(--text-sm);">
                        Você está prestes a excluir:
                    </p>
                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                        <i data-lucide="building-2" style="width: 24px; height: 24px; color: var(--cogep-green);"></i>
                        <div>
                            <p id="excluir-prop-nome" style="font-weight: var(--weight-bold); color: var(--text-primary); font-size: var(--text-lg);">
                                <!-- Nome será inserido aqui -->
                            </p>
                            <p id="excluir-prop-info" style="color: var(--text-secondary); font-size: var(--text-sm);">
                                <!-- Informações adicionais -->
                            </p>
                        </div>
                    </div>
                </div>

                <input type="hidden" id="excluir-prop-id">
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="fecharModal('modal-excluir-propriedade')">
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmarExclusaoPropriedade()">
                    <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                    Sim, Excluir Propriedade
                </button>
            </div>
        </div>
    </div>

    <!-- Toast de Notificações -->
    <div id="toast-container"></div>

    <script>
    /* ========================================
       SISTEMA CRUD - MARCOS GEODÉSICOS
       ======================================== */

    // Estado do modal de edição
    let marcoEmEdicao = null;
    let marcoParaExcluir = null;

    // ========================================
    // FUNÇÕES DE MODAL
    // ========================================

    function abrirModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            // Reinicializar ícones Lucide
            setTimeout(() => lucide.createIcons(), 50);
        }
    }

    function fecharModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';

            // Limpar formulários
            if (modalId === 'modal-novo-marco') {
                document.getElementById('form-novo-marco').reset();
            }
            if (modalId === 'modal-editar-marco') {
                marcoEmEdicao = null;
            }
            if (modalId === 'modal-excluir-marco') {
                marcoParaExcluir = null;
            }
        }
    }

    // Fechar modal ao clicar ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            fecharModal('modal-novo-marco');
            fecharModal('modal-editar-marco');
            fecharModal('modal-excluir-marco');
        }
    });

    // ========================================
    // TOGGLE DE SISTEMA DE COORDENADAS
    // ========================================

    function toggleCoordSystem() {
        const form = document.getElementById('form-novo-marco');
        const sistemaCoord = form.querySelector('input[name="sistema_coord"]:checked').value;
        const coordsUtm = document.getElementById('coords-utm');
        const coordsGeo = document.getElementById('coords-geo');

        if (sistemaCoord === 'utm') {
            coordsUtm.style.display = 'block';
            coordsGeo.style.display = 'none';

            // Tornar campos UTM obrigatórios
            form.querySelector('[name="coord_utm_e"]').required = true;
            form.querySelector('[name="coord_utm_n"]').required = true;
            form.querySelector('[name="latitude"]').required = false;
            form.querySelector('[name="longitude"]').required = false;
        } else {
            coordsUtm.style.display = 'none';
            coordsGeo.style.display = 'block';

            // Tornar campos Geo obrigatórios
            form.querySelector('[name="coord_utm_e"]').required = false;
            form.querySelector('[name="coord_utm_n"]').required = false;
            form.querySelector('[name="latitude"]').required = true;
            form.querySelector('[name="longitude"]').required = true;
        }
    }

    // ========================================
    // FUNÇÕES PÚBLICAS DO BOTÃO
    // ========================================

    function abrirModalNovoMarco() {
        abrirModal('modal-novo-marco');
    }

    // ========================================
    // TOAST NOTIFICATIONS
    // ========================================

    function mostrarToast(tipo, titulo, mensagem) {
        const container = document.getElementById('toast-container');

        const toast = document.createElement('div');
        toast.className = `toast toast-${tipo}`;

        const icon = tipo === 'success' ? 'check-circle' : 'alert-circle';

        toast.innerHTML = `
            <i data-lucide="${icon}"></i>
            <div class="toast-content">
                <div class="toast-title">${titulo}</div>
                <div class="toast-message">${mensagem}</div>
            </div>
        `;

        container.appendChild(toast);
        lucide.createIcons();

        // Auto-remover após 5 segundos
        setTimeout(() => {
            toast.style.animation = 'toastSlideOut 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    // Animação de saída do toast
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
        @keyframes toastSlideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
    `;
    document.head.appendChild(toastStyle);

    // ========================================
    // CRIAR NOVO MARCO
    // ========================================

    async function salvarNovoMarco(event) {
        event.preventDefault();

        const form = document.getElementById('form-novo-marco');
        const formData = new FormData(form);

        // Validar formulário
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // Construir objeto do marco
        const marco = {
            tipo: formData.get('tipo'),
            identificador: formData.get('identificador'),
            localizacao: formData.get('localizacao'),
            municipio: formData.get('municipio'),
            estado: formData.get('estado'),
            altitude: formData.get('altitude') ? parseFloat(formData.get('altitude')) : null,
            observacoes: formData.get('observacoes') || null,
            levantado: true
        };

        // Adicionar coordenadas baseado no sistema escolhido
        const sistemaCoord = formData.get('sistema_coord');

        if (sistemaCoord === 'utm') {
            marco.coord_utm_e = parseFloat(formData.get('coord_utm_e'));
            marco.coord_utm_n = parseFloat(formData.get('coord_utm_n'));
            marco.fuso_utm = parseInt(formData.get('fuso_utm'));

            // Converter para Lat/Long
            const coords = converterUTMparaLatLong(
                marco.coord_utm_e,
                marco.coord_utm_n,
                marco.fuso_utm
            );
            marco.latitude = coords.latitude;
            marco.longitude = coords.longitude;
        } else {
            marco.latitude = parseFloat(formData.get('latitude'));
            marco.longitude = parseFloat(formData.get('longitude'));

            // Converter para UTM
            const coords = converterLatLongParaUTM(
                marco.latitude,
                marco.longitude,
                22 // Fuso padrão
            );
            marco.coord_utm_e = coords.e;
            marco.coord_utm_n = coords.n;
            marco.fuso_utm = 22;
        }

        console.log('📤 Enviando novo marco:', marco);

        // Desabilitar botão durante envio
        const btn = event.target;
        const btnOriginalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Salvando...';
        lucide.createIcons();

        try {
            const response = await fetch('http://localhost:3001/api/marcos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(marco)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Erro ao criar marco');
            }

            const resultado = await response.json();
            console.log('✅ Marco criado:', resultado);

            // Sucesso!
            mostrarToast('success', 'Marco criado!', `Marco ${marco.identificador} foi adicionado com sucesso.`);

            // Fechar modal
            fecharModal('modal-novo-marco');

            // Recarregar lista de marcos
            AppState.marcosLoaded = false;
            await carregarMarcosLista();

            // Se estiver na aba mapa, recarregar marcadores
            if (window.carregarMarcos) {
                await window.carregarMarcos();
            }

        } catch (error) {
            console.error('❌ Erro ao criar marco:', error);
            mostrarToast('error', 'Erro ao criar marco', error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = btnOriginalHTML;
            lucide.createIcons();
        }
    }

    // ========================================
    // EDITAR MARCO
    // ========================================

    function abrirModalEditarMarco(marcoId) {
        // Buscar marco nos dados carregados
        const marco = AppState.marcos.find(m => m.id === marcoId);

        if (!marco) {
            mostrarToast('error', 'Erro', 'Marco não encontrado');
            return;
        }

        marcoEmEdicao = marco;

        // Preencher formulário de edição
        const content = document.getElementById('form-editar-content');
        content.innerHTML = document.getElementById('form-novo-marco').querySelector('.modal-body').innerHTML;

        // Preencher valores
        const form = document.getElementById('form-editar-marco');
        form.querySelector('[name="tipo"]').value = marco.tipo || 'V';
        form.querySelector('[name="identificador"]').value = marco.identificador || '';
        form.querySelector('[name="localizacao"]').value = marco.localizacao || '';
        form.querySelector('[name="municipio"]').value = marco.municipio || '';
        form.querySelector('[name="estado"]').value = marco.estado || 'PR';
        form.querySelector('[name="altitude"]').value = marco.altitude || '';
        form.querySelector('[name="observacoes"]').value = marco.observacoes || '';

        // Coordenadas
        if (marco.coord_utm_e && marco.coord_utm_n) {
            form.querySelector('[name="sistema_coord"][value="utm"]').checked = true;
            form.querySelector('[name="coord_utm_e"]').value = marco.coord_utm_e;
            form.querySelector('[name="coord_utm_n"]').value = marco.coord_utm_n;
            form.querySelector('[name="fuso_utm"]').value = marco.fuso_utm || 22;
        } else {
            form.querySelector('[name="sistema_coord"][value="geo"]').checked = true;
            form.querySelector('[name="latitude"]').value = marco.latitude;
            form.querySelector('[name="longitude"]').value = marco.longitude;
        }

        // Configurar toggle de coordenadas no modal de edição
        const radios = form.querySelectorAll('input[name="sistema_coord"]');
        radios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const coordsUtm = form.querySelector('#coords-utm');
                const coordsGeo = form.querySelector('#coords-geo');

                if (e.target.value === 'utm') {
                    coordsUtm.style.display = 'block';
                    coordsGeo.style.display = 'none';
                } else {
                    coordsUtm.style.display = 'none';
                    coordsGeo.style.display = 'block';
                }
            });
        });

        // Disparar evento para mostrar campos corretos
        const checkedRadio = form.querySelector('input[name="sistema_coord"]:checked');
        if (checkedRadio) {
            checkedRadio.dispatchEvent(new Event('change'));
        }

        document.getElementById('edit-marco-id').value = marco.id;

        abrirModal('modal-editar-marco');
    }

    async function salvarEdicaoMarco(event) {
        event.preventDefault();

        const form = document.getElementById('form-editar-marco');
        const formData = new FormData(form);
        const marcoId = document.getElementById('edit-marco-id').value;

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // Construir objeto atualizado
        const marcoAtualizado = {
            tipo: formData.get('tipo'),
            identificador: formData.get('identificador'),
            localizacao: formData.get('localizacao'),
            municipio: formData.get('municipio'),
            estado: formData.get('estado'),
            altitude: formData.get('altitude') ? parseFloat(formData.get('altitude')) : null,
            observacoes: formData.get('observacoes') || null
        };

        // Coordenadas
        const sistemaCoord = form.querySelector('input[name="sistema_coord"]:checked').value;

        if (sistemaCoord === 'utm') {
            marcoAtualizado.coord_utm_e = parseFloat(formData.get('coord_utm_e'));
            marcoAtualizado.coord_utm_n = parseFloat(formData.get('coord_utm_n'));
            marcoAtualizado.fuso_utm = parseInt(formData.get('fuso_utm'));

            const coords = converterUTMparaLatLong(
                marcoAtualizado.coord_utm_e,
                marcoAtualizado.coord_utm_n,
                marcoAtualizado.fuso_utm
            );
            marcoAtualizado.latitude = coords.latitude;
            marcoAtualizado.longitude = coords.longitude;
        } else {
            marcoAtualizado.latitude = parseFloat(formData.get('latitude'));
            marcoAtualizado.longitude = parseFloat(formData.get('longitude'));

            const coords = converterLatLongParaUTM(
                marcoAtualizado.latitude,
                marcoAtualizado.longitude,
                22
            );
            marcoAtualizado.coord_utm_e = coords.e;
            marcoAtualizado.coord_utm_n = coords.n;
            marcoAtualizado.fuso_utm = 22;
        }

        console.log('📤 Atualizando marco:', marcoAtualizado);

        const btn = event.target;
        const btnOriginalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Salvando...';
        lucide.createIcons();

        try {
            const response = await fetch(`http://localhost:3001/api/marcos/${marcoId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(marcoAtualizado)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Erro ao atualizar marco');
            }

            const resultado = await response.json();
            console.log('✅ Marco atualizado:', resultado);

            mostrarToast('success', 'Marco atualizado!', `Alterações salvas com sucesso.`);

            fecharModal('modal-editar-marco');

            AppState.marcosLoaded = false;
            await carregarMarcosLista();

            if (window.carregarMarcos) {
                await window.carregarMarcos();
            }

        } catch (error) {
            console.error('❌ Erro ao atualizar marco:', error);
            mostrarToast('error', 'Erro ao atualizar', error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = btnOriginalHTML;
            lucide.createIcons();
        }
    }

    // ========================================
    // EXCLUIR MARCO
    // ========================================

    function abrirModalExcluirMarco(marcoId) {
        const marco = AppState.marcos.find(m => m.id === marcoId);

        if (!marco) {
            mostrarToast('error', 'Erro', 'Marco não encontrado');
            return;
        }

        marcoParaExcluir = marco;

        document.getElementById('excluir-marco-id').textContent = marco.identificador || `Marco #${marco.id}`;
        document.getElementById('excluir-marco-localizacao').textContent = marco.localizacao || 'Sem localização';

        abrirModal('modal-excluir-marco');
    }

    async function confirmarExclusaoMarco() {
        if (!marcoParaExcluir) {
            return;
        }

        const marcoId = marcoParaExcluir.id;
        const marcoNome = marcoParaExcluir.identificador || `#${marcoId}`;

        console.log('🗑️ Excluindo marco:', marcoId);

        try {
            const response = await fetch(`http://localhost:3001/api/marcos/${marcoId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Erro ao excluir marco');
            }

            console.log('✅ Marco excluído');

            mostrarToast('success', 'Marco excluído', `Marco ${marcoNome} foi removido com sucesso.`);

            fecharModal('modal-excluir-marco');

            AppState.marcosLoaded = false;
            await carregarMarcosLista();

            if (window.carregarMarcos) {
                await window.carregarMarcos();
            }

        } catch (error) {
            console.error('❌ Erro ao excluir marco:', error);
            mostrarToast('error', 'Erro ao excluir', error.message);
        }
    }

    // ========================================
    // CONVERSÃO DE COORDENADAS
    // ========================================

    function converterUTMparaLatLong(e, n, fuso) {
        // Usar proj4 se disponível, senão conversão aproximada
        if (typeof proj4 !== 'undefined') {
            const utm = `+proj=utm +zone=${fuso} +south +datum=WGS84`;
            const wgs84 = '+proj=longlat +datum=WGS84';

            const [longitude, latitude] = proj4(utm, wgs84, [e, n]);
            return { latitude, longitude };
        }

        // Conversão aproximada (fallback)
        console.warn('⚠️ proj4 não disponível, usando conversão aproximada');

        const latitude = (n - 10000000) / 111320;
        const longitude = (e - 500000) / (111320 * Math.cos(latitude * Math.PI / 180)) + (fuso * 6 - 183);

        return { latitude, longitude };
    }

    function converterLatLongParaUTM(latitude, longitude, fuso) {
        if (typeof proj4 !== 'undefined') {
            const wgs84 = '+proj=longlat +datum=WGS84';
            const utm = `+proj=utm +zone=${fuso} +south +datum=WGS84`;

            const [e, n] = proj4(wgs84, utm, [longitude, latitude]);
            return { e, n };
        }

        // Conversão aproximada (fallback)
        console.warn('⚠️ proj4 não disponível, usando conversão aproximada');

        const e = (longitude - (fuso * 6 - 183)) * 111320 * Math.cos(latitude * Math.PI / 180) + 500000;
        const n = latitude * 111320 + 10000000;

        return { e, n };
    }

    // ========================================
    // MODIFICAR FUNÇÃO criarCardMarco
    // ========================================

    // Salvar referência original
    const originalCriarCardMarco = criarCardMarco;

    // Sobrescrever com nova versão que inclui botões
    criarCardMarco = function(marco) {
        const tipo = determinarTipo(marco.tipo);
        const status = determinarStatus(marco);
        const coordenadas = formatarCoordenadas(marco);

        return `
            <div class="marco-card animate-fade-in-up" data-marco-id="${marco.id}" onclick="centralizarMarcoNoMapa(${marco.id})">
                <div class="marco-card-header">
                    <div class="marco-card-id">
                        <i data-lucide="${tipo.icon}"></i>
                        ${marco.identificador || marco.id}
                    </div>
                    <span class="marco-badge badge-${tipo.classe}">
                        <i data-lucide="${tipo.icon}"></i>
                        ${tipo.nome}
                    </span>
                </div>

                <div class="marco-card-body">
                    ${marco.localizacao ? `
                        <div class="marco-info-row">
                            <i data-lucide="building-2"></i>
                            <span>${marco.localizacao}</span>
                        </div>
                    ` : ''}

                    ${marco.municipio ? `
                        <div class="marco-info-row">
                            <i data-lucide="map-pin"></i>
                            <span>${marco.municipio} - ${marco.estado || 'PR'}</span>
                        </div>
                    ` : ''}

                    ${marco.altitude ? `
                        <div class="marco-info-row">
                            <i data-lucide="mountain"></i>
                            <span>Altitude: <strong>${marco.altitude}m</strong></span>
                        </div>
                    ` : ''}

                    <div class="marco-info-row">
                        <i data-lucide="${status.icon}"></i>
                        <span class="marco-status status-${status.classe}">
                            <strong>${status.texto}</strong>
                        </span>
                    </div>

                    ${coordenadas ? `
                        <div class="marco-coordinates">
                            <div>
                                <span><strong>E:</strong> ${coordenadas.e}</span>
                            </div>
                            <div>
                                <span><strong>N:</strong> ${coordenadas.n}</span>
                            </div>
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: var(--space-2); margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-primary);">
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); abrirModalEditarMarco(${marco.id})" style="flex: 1;">
                            <i data-lucide="edit" style="width: 14px; height: 14px;"></i>
                            Editar
                        </button>
                        <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); abrirModalExcluirMarco(${marco.id})" style="flex: 1; color: #EF4444;">
                            <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                            Excluir
                        </button>
                    </div>
                </div>
            </div>
        `;
    };

    console.log('✅ Sistema CRUD inicializado');

    </script>

    <script>
    /* ========================================
       SISTEMA DE IMPORTAÇÃO CSV/TXT
       ======================================== */

    // Estado da importação
    const ImportState = {
        arquivo: null,
        conteudo: null,
        dados: [],
        dadosValidados: [],
        configuracao: {
            separador: ',',
            temCabecalho: true,
            sistemaCoord: 'utm',
            fuso: 22
        },
        estatisticas: {
            total: 0,
            validos: 0,
            erros: 0
        }
    };

    // ========================================
    // ABRIR MODAL DE IMPORTAÇÃO CSV
    // ========================================

    function abrirModalImportarCSV() {
        abrirModal('modal-importar-csv');
        // Reinicializar ícones após abrir modal
        setTimeout(() => {
            lucide.createIcons();
        }, 100);
    }

    // ========================================
    // IMPORTAÇÃO DE MEMORIAL DOCX (PLACEHOLDER)
    // ========================================

    function handleFileSelectDOCX(event) {
        const arquivo = event.target.files[0];
        if (arquivo) {
            processarArquivoDOCX(arquivo);
        }
    }

    async function processarArquivoDOCX(arquivo) {
        console.log('📄 Processando memorial DOCX:', arquivo.name);

        // Validar tipo
        const extensao = arquivo.name.split('.').pop().toLowerCase();
        if (!['docx', 'doc'].includes(extensao)) {
            mostrarToast('error', 'Formato inválido', 'Apenas arquivos DOCX e DOC são aceitos.');
            return;
        }

        // Validar tamanho (máx 10MB)
        if (arquivo.size > 10 * 1024 * 1024) {
            mostrarToast('error', 'Arquivo muito grande', 'O arquivo deve ter no máximo 10MB.');
            return;
        }

        // Mostrar preview
        document.getElementById('upload-area-docx').style.display = 'none';
        document.getElementById('preview-area-docx').style.display = 'block';

        document.getElementById('file-name-docx').textContent = arquivo.name;
        document.getElementById('file-info-docx').textContent = `${(arquivo.size / 1024).toFixed(2)} KB`;

        // Reinicializar ícones
        lucide.createIcons();

        // Simular processamento
        setTimeout(() => {
            mostrarToast('error', 'Funcionalidade em desenvolvimento', 'A extração de memoriais DOCX será implementada na próxima fase.');

            // Voltar ao estado inicial
            setTimeout(() => {
                cancelarImportacaoDOCX();
            }, 3000);
        }, 2000);
    }

    function cancelarImportacaoDOCX() {
        document.getElementById('upload-area-docx').style.display = 'block';
        document.getElementById('preview-area-docx').style.display = 'none';
        document.getElementById('file-input-docx').value = '';
    }

    function importarMarcosDOCX() {
        mostrarToast('error', 'Funcionalidade em desenvolvimento', 'Esta funcionalidade será implementada na próxima fase.');
    }

    console.log('✅ Sistema de importação DOCX (placeholder) inicializado');

    // ========================================
    // DRAG & DROP
    // ========================================

    function setupDragAndDrop() {
        const uploadArea = document.getElementById('upload-area');

        if (!uploadArea) return;

        // Prevenir comportamento padrão
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Destacar área ao arrastar arquivo
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('drag-over');
            }, false);
        });

        // Handle drop
        uploadArea.addEventListener('drop', handleDrop, false);

        // Click na área para abrir seletor
        uploadArea.addEventListener('click', () => {
            document.getElementById('file-input-importar').click();
        });
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
            processarArquivo(files[0]);
        }
    }

    // Inicializar drag & drop
    document.addEventListener('DOMContentLoaded', setupDragAndDrop);

    // ========================================
    // SELEÇÃO DE ARQUIVO
    // ========================================

    function handleFileSelect(event) {
        const arquivo = event.target.files[0];
        if (arquivo) {
            processarArquivo(arquivo);
        }
    }

    // Adicionar event listener ao input de arquivo
    document.addEventListener('DOMContentLoaded', () => {
        const fileInput = document.getElementById('file-input-importar');
        if (fileInput) {
            fileInput.addEventListener('change', handleFileSelect);
        }
    });

    // ========================================
    // PROCESSAMENTO DO ARQUIVO
    // ========================================

    async function processarArquivo(arquivo) {
        console.log('📄 Processando arquivo:', arquivo.name);

        // Validar tipo
        const extensao = arquivo.name.split('.').pop().toLowerCase();
        if (!['csv', 'txt'].includes(extensao)) {
            mostrarToast('error', 'Formato inválido', 'Apenas arquivos CSV e TXT são aceitos.');
            return;
        }

        // Validar tamanho (máx 10MB)
        if (arquivo.size > 10 * 1024 * 1024) {
            mostrarToast('error', 'Arquivo muito grande', 'O arquivo deve ter no máximo 10MB.');
            return;
        }

        ImportState.arquivo = arquivo;

        try {
            // Ler conteúdo do arquivo
            const conteudo = await lerArquivo(arquivo);
            ImportState.conteudo = conteudo;

            console.log('✅ Arquivo lido com sucesso');

            // Mostrar área de preview
            document.getElementById('upload-area').style.display = 'none';
            document.getElementById('preview-area').style.display = 'block';
            document.getElementById('import-resultado').style.display = 'none';

            // Atualizar info do arquivo
            document.getElementById('file-name').textContent = arquivo.name;
            document.getElementById('file-info').textContent = `${(arquivo.size / 1024).toFixed(2)} KB`;

            // Fazer parsing inicial
            atualizarPreview();

        } catch (error) {
            console.error('❌ Erro ao ler arquivo:', error);
            mostrarToast('error', 'Erro ao ler arquivo', error.message);
        }
    }

    function lerArquivo(arquivo) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();

            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(new Error('Erro ao ler arquivo'));

            reader.readAsText(arquivo);
        });
    }

    // ========================================
    // PARSER DE CSV/TXT
    // ========================================

    function parsearArquivo() {
        const conteudo = ImportState.conteudo;
        const config = ImportState.configuracao;

        // Atualizar config baseado nos selects
        config.separador = document.getElementById('import-separator').value;
        config.temCabecalho = document.getElementById('import-has-header').checked;
        config.sistemaCoord = document.getElementById('import-coord-system').value;
        config.fuso = parseInt(document.getElementById('import-fuso').value);

        console.log('🔍 Parseando arquivo com config:', config);

        // Quebrar em linhas
        const linhas = conteudo.split('\n').filter(linha => linha.trim() !== '');

        let cabecalho = null;
        let dadosLinhas = linhas;

        if (config.temCabecalho && linhas.length > 0) {
            cabecalho = linhas[0].split(config.separador).map(col => col.trim());
            dadosLinhas = linhas.slice(1);
        }

        // Parsear cada linha
        const dados = dadosLinhas.map((linha, index) => {
            const colunas = linha.split(config.separador).map(col => col.trim());

            return {
                linha: index + (config.temCabecalho ? 2 : 1),
                colunas: colunas,
                raw: linha
            };
        });

        ImportState.dados = dados;

        console.log(`✅ ${dados.length} linhas parseadas`);

        return { cabecalho, dados };
    }

    // ========================================
    // VALIDAÇÃO DOS DADOS
    // ========================================

    function validarDados(dados) {
        const config = ImportState.configuracao;
        const dadosValidados = [];

        console.log('🔍 Validando dados...');

        dados.forEach(item => {
            const resultado = {
                ...item,
                valido: true,
                erros: [],
                marco: {}
            };

            // Tentar extrair dados baseado no sistema de coordenadas
            try {
                if (config.sistemaCoord === 'utm') {
                    // Espera: ID, Tipo, E, N, Altitude (opcional), Localização (opcional)
                    if (item.colunas.length < 4) {
                        throw new Error('Mínimo de 4 colunas necessárias: ID, Tipo, E, N');
                    }

                    resultado.marco = {
                        identificador: item.colunas[0],
                        tipo: item.colunas[1]?.toUpperCase() || 'V',
                        coord_utm_e: parseFloat(item.colunas[2]),
                        coord_utm_n: parseFloat(item.colunas[3]),
                        fuso_utm: config.fuso,
                        altitude: item.colunas[4] ? parseFloat(item.colunas[4]) : null,
                        localizacao: item.colunas[5] || null,
                        municipio: item.colunas[6] || null,
                        estado: item.colunas[7] || 'PR',
                        levantado: true
                    };

                    // Validar coordenadas UTM
                    if (isNaN(resultado.marco.coord_utm_e) || isNaN(resultado.marco.coord_utm_n)) {
                        throw new Error('Coordenadas UTM inválidas');
                    }

                    if (resultado.marco.coord_utm_e < 0 || resultado.marco.coord_utm_n < 0) {
                        throw new Error('Coordenadas UTM devem ser positivas');
                    }

                    // Converter para Lat/Long
                    const coords = converterUTMparaLatLong(
                        resultado.marco.coord_utm_e,
                        resultado.marco.coord_utm_n,
                        config.fuso
                    );
                    resultado.marco.latitude = coords.latitude;
                    resultado.marco.longitude = coords.longitude;

                } else if (config.sistemaCoord === 'geo') {
                    // Espera: ID, Tipo, Lat, Long, Altitude (opcional), Localização (opcional)
                    if (item.colunas.length < 4) {
                        throw new Error('Mínimo de 4 colunas necessárias: ID, Tipo, Lat, Long');
                    }

                    resultado.marco = {
                        identificador: item.colunas[0],
                        tipo: item.colunas[1]?.toUpperCase() || 'V',
                        latitude: parseFloat(item.colunas[2]),
                        longitude: parseFloat(item.colunas[3]),
                        altitude: item.colunas[4] ? parseFloat(item.colunas[4]) : null,
                        localizacao: item.colunas[5] || null,
                        municipio: item.colunas[6] || null,
                        estado: item.colunas[7] || 'PR',
                        levantado: true
                    };

                    // Validar coordenadas geográficas
                    if (isNaN(resultado.marco.latitude) || isNaN(resultado.marco.longitude)) {
                        throw new Error('Coordenadas geográficas inválidas');
                    }

                    if (resultado.marco.latitude < -90 || resultado.marco.latitude > 90) {
                        throw new Error('Latitude deve estar entre -90 e 90');
                    }

                    if (resultado.marco.longitude < -180 || resultado.marco.longitude > 180) {
                        throw new Error('Longitude deve estar entre -180 e 180');
                    }

                    // Converter para UTM
                    const coords = converterLatLongParaUTM(
                        resultado.marco.latitude,
                        resultado.marco.longitude,
                        config.fuso
                    );
                    resultado.marco.coord_utm_e = coords.e;
                    resultado.marco.coord_utm_n = coords.n;
                    resultado.marco.fuso_utm = config.fuso;
                }

                // Validar tipo
                if (!['V', 'M', 'P'].includes(resultado.marco.tipo)) {
                    resultado.marco.tipo = 'V';
                    resultado.erros.push('Tipo inválido, usando "V" (Vértice)');
                }

            } catch (error) {
                resultado.valido = false;
                resultado.erros.push(error.message);
            }

            dadosValidados.push(resultado);
        });

        // Atualizar estatísticas
        ImportState.estatisticas.total = dadosValidados.length;
        ImportState.estatisticas.validos = dadosValidados.filter(d => d.valido).length;
        ImportState.estatisticas.erros = dadosValidados.filter(d => !d.valido).length;

        ImportState.dadosValidados = dadosValidados;

        console.log('✅ Validação completa:', ImportState.estatisticas);

        return dadosValidados;
    }

    // ========================================
    // ATUALIZAR PREVIEW
    // ========================================

    function atualizarPreview() {
        // Parsear arquivo
        const { cabecalho, dados } = parsearArquivo();

        // Validar dados
        const dadosValidados = validarDados(dados);

        // Atualizar estatísticas
        document.getElementById('preview-total').textContent = ImportState.estatisticas.total;
        document.getElementById('preview-validos').textContent = ImportState.estatisticas.validos;
        document.getElementById('preview-erros').textContent = ImportState.estatisticas.erros;

        // Atualizar texto do botão
        document.getElementById('import-count').textContent = ImportState.estatisticas.validos;

        // Desabilitar botão se não houver dados válidos
        const btnImportar = document.getElementById('btn-importar');
        btnImportar.disabled = ImportState.estatisticas.validos === 0;

        // Renderizar tabela
        renderizarTabelaPreview(cabecalho, dadosValidados);

        // Reinicializar ícones
        lucide.createIcons();
    }

    // ========================================
    // RENDERIZAR TABELA DE PREVIEW
    // ========================================

    function renderizarTabelaPreview(cabecalho, dados) {
        const tabela = document.getElementById('preview-table');

        // Limpar tabela
        tabela.innerHTML = '';

        // Criar cabeçalho
        const thead = document.createElement('thead');
        const trHead = document.createElement('tr');

        const colunasPadrao = ['Linha', 'ID', 'Tipo', 'Coordenadas', 'Status'];

        colunasPadrao.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            trHead.appendChild(th);
        });

        thead.appendChild(trHead);
        tabela.appendChild(thead);

        // Criar corpo (mostrar apenas primeiras 50 linhas)
        const tbody = document.createElement('tbody');
        const dadosLimitados = dados.slice(0, 50);

        dadosLimitados.forEach(item => {
            const tr = document.createElement('tr');
            tr.className = item.valido ? 'row-valid' : 'row-error';

            // Linha
            const tdLinha = document.createElement('td');
            tdLinha.textContent = item.linha;
            tr.appendChild(tdLinha);

            // ID
            const tdId = document.createElement('td');
            tdId.textContent = item.marco.identificador || '-';
            if (!item.valido) tdId.className = 'cell-error';
            tr.appendChild(tdId);

            // Tipo
            const tdTipo = document.createElement('td');
            tdTipo.textContent = item.marco.tipo || '-';
            tr.appendChild(tdTipo);

            // Coordenadas
            const tdCoords = document.createElement('td');
            if (item.marco.coord_utm_e && item.marco.coord_utm_n) {
                tdCoords.textContent = `E: ${item.marco.coord_utm_e.toFixed(2)}, N: ${item.marco.coord_utm_n.toFixed(2)}`;
            } else {
                tdCoords.textContent = '-';
                if (!item.valido) tdCoords.className = 'cell-error';
            }
            tr.appendChild(tdCoords);

            // Status
            const tdStatus = document.createElement('td');
            if (item.valido) {
                tdStatus.innerHTML = '<span style="color: #10B981;">✓ Válido</span>';
            } else {
                tdStatus.innerHTML = `<span style="color: #EF4444;">✗ ${item.erros[0]}</span>`;
            }
            tr.appendChild(tdStatus);

            tbody.appendChild(tr);
        });

        tabela.appendChild(tbody);

        // Mostrar mensagem se houver mais linhas
        if (dados.length > 50) {
            const trMais = document.createElement('tr');
            const tdMais = document.createElement('td');
            tdMais.colSpan = 5;
            tdMais.style.textAlign = 'center';
            tdMais.style.color = 'var(--text-tertiary)';
            tdMais.style.padding = 'var(--space-4)';
            tdMais.textContent = `... e mais ${dados.length - 50} linhas`;
            trMais.appendChild(tdMais);
            tbody.appendChild(trMais);
        }
    }

    // ========================================
    // CANCELAR IMPORTAÇÃO
    // ========================================

    function cancelarImportacao() {
        ImportState.arquivo = null;
        ImportState.conteudo = null;
        ImportState.dados = [];
        ImportState.dadosValidados = [];

        document.getElementById('upload-area').style.display = 'block';
        document.getElementById('preview-area').style.display = 'none';
        document.getElementById('import-resultado').style.display = 'none';

        document.getElementById('file-input-importar').value = '';
    }

    // Adicionar event listeners aos selects de configuração
    document.addEventListener('DOMContentLoaded', () => {
        const separator = document.getElementById('import-separator');
        const hasHeader = document.getElementById('import-has-header');
        const coordSystem = document.getElementById('import-coord-system');
        const fuso = document.getElementById('import-fuso');

        if (separator) {
            separator.addEventListener('change', () => {
                if (ImportState.conteudo) atualizarPreview();
            });
        }

        if (hasHeader) {
            hasHeader.addEventListener('change', () => {
                if (ImportState.conteudo) atualizarPreview();
            });
        }

        if (coordSystem) {
            coordSystem.addEventListener('change', () => {
                if (ImportState.conteudo) atualizarPreview();
            });
        }

        if (fuso) {
            fuso.addEventListener('change', () => {
                if (ImportState.conteudo) atualizarPreview();
            });
        }
    });

    console.log('✅ Sistema de importação - Drag & Drop e Parser inicializados');

    </script>

    <script>
    /* ========================================
       IMPORTAÇÃO EM LOTE - PARTE 3
       ======================================== */

    // ========================================
    // INICIAR IMPORTAÇÃO
    // ========================================

    async function iniciarImportacao() {
        console.log('🚀 Iniciando importação em lote...');

        const dadosValidos = ImportState.dadosValidados.filter(d => d.valido);

        if (dadosValidos.length === 0) {
            mostrarToast('error', 'Nenhum dado válido', 'Não há marcos válidos para importar.');
            return;
        }

        // Esconder botões e mostrar progress bar
        document.getElementById('btn-importar').style.display = 'none';
        document.getElementById('import-progress').style.display = 'block';

        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        // Estatísticas da importação
        const resultado = {
            total: dadosValidos.length,
            sucesso: 0,
            erros: 0,
            detalhes: []
        };

        // Importar um por um com delay para não sobrecarregar
        for (let i = 0; i < dadosValidos.length; i++) {
            const item = dadosValidos[i];

            // Atualizar progress bar
            const progresso = Math.round(((i + 1) / dadosValidos.length) * 100);
            progressBar.style.width = `${progresso}%`;
            progressText.textContent = `${progresso}% (${i + 1}/${dadosValidos.length})`;

            try {
                await importarMarco(item.marco);
                resultado.sucesso++;

                console.log(`✅ Marco ${i + 1}/${dadosValidos.length} importado`);

            } catch (error) {
                resultado.erros++;
                resultado.detalhes.push({
                    linha: item.linha,
                    identificador: item.marco.identificador,
                    erro: error.message
                });

                console.error(`❌ Erro ao importar linha ${item.linha}:`, error);
            }

            // Pequeno delay entre requisições (50ms)
            await new Promise(resolve => setTimeout(resolve, 50));
        }

        console.log('✅ Importação concluída:', resultado);

        // Mostrar resultado
        mostrarResultadoImportacao(resultado);

        // Recarregar lista de marcos
        if (window.carregarMarcosLista) {
            await carregarMarcosLista();
        }

        // Recarregar mapa
        if (window.carregarMarcos) {
            await carregarMarcos();
        }
    }

    // ========================================
    // IMPORTAR UM MARCO
    // ========================================

    async function importarMarco(marco) {
        const response = await fetch('http://localhost:3001/api/marcos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(marco)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Erro ao importar marco');
        }

        return await response.json();
    }

    // ========================================
    // MOSTRAR RESULTADO DA IMPORTAÇÃO
    // ========================================

    function mostrarResultadoImportacao(resultado) {
        console.log('📊 Mostrando resultado:', resultado);

        // Esconder preview
        document.getElementById('preview-area').style.display = 'none';

        // Mostrar resultado
        const resultadoDiv = document.getElementById('import-resultado');
        resultadoDiv.style.display = 'block';

        // Mensagem principal
        const mensagem = document.getElementById('resultado-mensagem');
        if (resultado.erros === 0) {
            mensagem.textContent = `${resultado.sucesso} marcos foram importados com sucesso!`;
            mensagem.style.color = '#10B981';
        } else {
            mensagem.textContent = `${resultado.sucesso} marcos importados, ${resultado.erros} com erro.`;
            mensagem.style.color = 'var(--text-secondary)';
        }

        // Detalhes em cards
        const detalhesDiv = document.getElementById('resultado-detalhes');
        detalhesDiv.innerHTML = `
            <div style="padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: var(--text-xs); color: var(--text-tertiary); text-transform: uppercase; margin-bottom: var(--space-1);">
                    Total Processados
                </div>
                <div style="font-size: var(--text-3xl); font-weight: var(--weight-heavy); color: var(--text-primary);">
                    ${resultado.total}
                </div>
            </div>

            <div style="padding: var(--space-4); background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: var(--text-xs); color: var(--text-tertiary); text-transform: uppercase; margin-bottom: var(--space-1);">
                    Importados
                </div>
                <div style="font-size: var(--text-3xl); font-weight: var(--weight-heavy); color: #10B981;">
                    ${resultado.sucesso}
                </div>
            </div>

            <div style="padding: var(--space-4); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: var(--text-xs); color: var(--text-tertiary); text-transform: uppercase; margin-bottom: var(--space-1);">
                    Com Erros
                </div>
                <div style="font-size: var(--text-3xl); font-weight: var(--weight-heavy); color: #EF4444;">
                    ${resultado.erros}
                </div>
            </div>
        `;

        // Mostrar lista de erros se houver
        if (resultado.detalhes.length > 0) {
            detalhesDiv.innerHTML += `
                <div style="grid-column: 1 / -1; padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-md);">
                    <details>
                        <summary style="cursor: pointer; font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-3);">
                            Ver detalhes dos erros (${resultado.detalhes.length})
                        </summary>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${resultado.detalhes.map(erro => `
                                <div style="padding: var(--space-3); border-left: 3px solid #EF4444; margin-bottom: var(--space-2); background: var(--bg-primary); border-radius: var(--radius-sm);">
                                    <div style="font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-1);">
                                        Linha ${erro.linha}: ${erro.identificador}
                                    </div>
                                    <div style="font-size: var(--text-sm); color: #EF4444;">
                                        ${erro.erro}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                </div>
            `;
        }

        // Toast de sucesso geral
        if (resultado.erros === 0) {
            mostrarToast('success', 'Importação concluída!', `${resultado.sucesso} marcos foram adicionados ao sistema.`);
        } else {
            mostrarToast('success', 'Importação parcial', `${resultado.sucesso} marcos importados, ${resultado.erros} falharam.`);
        }

        // Reinicializar ícones
        lucide.createIcons();
    }

    // ========================================
    // NOVA IMPORTAÇÃO
    // ========================================

    function novaImportacao() {
        // Resetar estado
        ImportState.arquivo = null;
        ImportState.conteudo = null;
        ImportState.dados = [];
        ImportState.dadosValidados = [];
        ImportState.estatisticas = { total: 0, validos: 0, erros: 0 };

        // Resetar UI
        document.getElementById('upload-area').style.display = 'block';
        document.getElementById('preview-area').style.display = 'none';
        document.getElementById('import-resultado').style.display = 'none';
        document.getElementById('import-progress').style.display = 'none';

        document.getElementById('file-input-importar').value = '';
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('progress-text').textContent = '0%';
        document.getElementById('btn-importar').style.display = 'inline-flex';

        console.log('🔄 Pronto para nova importação');
    }

    // ========================================
    // ATALHOS DE TECLADO
    // ========================================

    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + I para abrir importação
        if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
            e.preventDefault();
            const abaImportar = document.querySelector('[onclick*="importar"]');
            if (abaImportar) abaImportar.click();
        }
    });

    console.log('✅ Sistema de importação em lote inicializado');
    console.log('💡 Dica: Use Ctrl+I para abrir a aba de importação rapidamente');

    </script>

    <script>
    /* ========================================
       SISTEMA DE PROPRIEDADES
       ======================================== */

    // Estado das propriedades
    const PropriedadesState = {
        propriedades: [],
        propriedadesLoaded: false,
        propriedadeEmEdicao: null,
        propriedadeParaExcluir: null,
        filtros: {
            busca: '',
            tipo: '',
            municipio: ''
        }
    };

    // ========================================
    // CARREGAR PROPRIEDADES
    // ========================================

    async function carregarPropriedades() {
        try {
            console.log('🏢 Carregando propriedades...');

            // Mostrar loading
            const container = document.getElementById('propriedades-grid');
            const loading = document.getElementById('propriedades-loading');
            const empty = document.getElementById('propriedades-empty');

            if (loading) loading.style.display = 'block';
            if (container) container.style.display = 'none';
            if (empty) empty.style.display = 'none';

            const response = await fetch('http://localhost:3001/api/propriedades');

            if (!response.ok) {
                throw new Error(`Erro na API: ${response.status}`);
            }

            const data = await response.json();
            PropriedadesState.propriedades = data.data || [];
            PropriedadesState.propriedadesLoaded = true;

            console.log(`✅ ${PropriedadesState.propriedades.length} propriedades carregadas`);

            // Esconder loading
            if (loading) loading.style.display = 'none';
            if (container) container.style.display = 'grid';

            // Atualizar estatísticas
            atualizarEstatisticasPropriedades();

            // Renderizar cards
            renderizarPropriedades();

            // Preencher filtro de municípios
            preencherFiltroMunicipios();

        } catch (error) {
            console.error('❌ Erro ao carregar propriedades:', error);

            const loading = document.getElementById('propriedades-loading');
            if (loading) loading.style.display = 'none';

            mostrarErroPropriedades('Não foi possível carregar as propriedades.');
        }
    }

    // ========================================
    // ATUALIZAR ESTATÍSTICAS
    // ========================================

    function atualizarEstatisticasPropriedades() {
        const total = PropriedadesState.propriedades.length;

        // Atualizar card de estatísticas no dashboard (se existir)
        const statsCards = document.querySelectorAll('.stat-value');
        if (statsCards[2]) {
            statsCards[2].textContent = total;
        }
    }

    // ========================================
    // RENDERIZAR PROPRIEDADES
    // ========================================

    function renderizarPropriedades() {
        const container = document.getElementById('propriedades-grid');
        const emptyState = document.getElementById('propriedades-empty');

        if (!container) return;

        // Filtrar propriedades
        const propriedadesFiltradas = filtrarPropriedadesLista();

        if (propriedadesFiltradas.length === 0) {
            container.innerHTML = '';
            container.style.display = 'none';

            if (PropriedadesState.propriedades.length === 0) {
                emptyState.style.display = 'block';
            } else {
                container.style.display = 'grid';
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: var(--space-16);">
                        <i data-lucide="search-x" style="width: 64px; height: 64px; color: var(--text-tertiary); margin: 0 auto var(--space-4);"></i>
                        <p style="color: var(--text-secondary); font-size: var(--text-lg);">Nenhuma propriedade encontrada</p>
                        <p style="color: var(--text-tertiary); font-size: var(--text-sm); margin-top: var(--space-2);">
                            Tente ajustar os filtros
                        </p>
                    </div>
                `;
            }
            lucide.createIcons();
            return;
        }

        emptyState.style.display = 'none';
        container.style.display = 'grid';
        container.innerHTML = propriedadesFiltradas.map(prop => criarCardPropriedade(prop)).join('');

        lucide.createIcons();
    }

    // ========================================
    // CRIAR CARD DE PROPRIEDADE
    // ========================================

    function criarCardPropriedade(propriedade) {
        const tipoInfo = {
            'RURAL': { nome: 'Rural', icon: 'tractor', cor: '#10B981' },
            'URBANA': { nome: 'Urbana', icon: 'building-2', cor: '#3B82F6' }
        };

        const tipo = tipoInfo[propriedade.tipo] || tipoInfo['RURAL'];

        return `
            <div class="card" style="padding: var(--space-5); transition: all var(--transition-base); cursor: pointer;"
                 onclick="verDetalhesPropriedade(${propriedade.id})">

                <!-- Header do Card -->
                <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: var(--space-4);">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                            <i data-lucide="${tipo.icon}" style="width: 20px; height: 20px; color: ${tipo.cor};"></i>
                            <span style="font-size: var(--text-xs); font-weight: var(--weight-bold); text-transform: uppercase; color: ${tipo.cor};">
                                ${tipo.nome}
                            </span>
                        </div>
                        <h3 style="font-size: var(--text-lg); font-weight: var(--weight-bold); color: var(--text-primary); margin-bottom: var(--space-1);">
                            ${propriedade.nome_propriedade || 'Sem nome'}
                        </h3>
                        ${propriedade.matricula ? `
                            <p style="font-size: var(--text-sm); color: var(--text-tertiary);">
                                Matrícula: ${propriedade.matricula}
                            </p>
                        ` : ''}
                    </div>
                </div>

                <!-- Informações -->
                <div style="display: flex; flex-direction: column; gap: var(--space-2); margin-bottom: var(--space-4);">
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <i data-lucide="map-pin" style="width: 16px; height: 16px; color: var(--text-tertiary);"></i>
                        <span style="font-size: var(--text-sm); color: var(--text-secondary);">
                            ${propriedade.municipio} - ${propriedade.uf || 'PR'}
                        </span>
                    </div>

                    ${propriedade.area_m2 ? `
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <i data-lucide="maximize-2" style="width: 16px; height: 16px; color: var(--text-tertiary);"></i>
                            <span style="font-size: var(--text-sm); color: var(--text-secondary);">
                                Área: ${parseFloat(propriedade.area_m2).toLocaleString('pt-BR')} m²
                            </span>
                        </div>
                    ` : ''}

                    ${propriedade.cliente_nome ? `
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <i data-lucide="user" style="width: 16px; height: 16px; color: var(--text-tertiary);"></i>
                            <span style="font-size: var(--text-sm); color: var(--text-secondary);">
                                ${propriedade.cliente_nome}
                            </span>
                        </div>
                    ` : ''}
                </div>

                <!-- Contador de Marcos -->
                <div style="padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span style="font-size: var(--text-sm); color: var(--text-secondary);">Marcos Geodésicos</span>
                        <strong style="font-size: var(--text-lg); color: var(--cogep-green);">
                            ${propriedade.total_marcos || 0}
                        </strong>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div style="display: flex; gap: var(--space-2);">
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); abrirModalEditarPropriedade(${propriedade.id})" style="flex: 1;">
                        <i data-lucide="edit" style="width: 14px; height: 14px;"></i>
                        Editar
                    </button>
                    <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); abrirModalExcluirPropriedade(${propriedade.id})" style="color: #EF4444;">
                        <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                    </button>
                </div>
            </div>
        `;
    }

    // ========================================
    // FILTRAR PROPRIEDADES
    // ========================================

    function filtrarPropriedadesLista() {
        return PropriedadesState.propriedades.filter(prop => {
            // Filtro de tipo
            if (PropriedadesState.filtros.tipo && prop.tipo !== PropriedadesState.filtros.tipo) {
                return false;
            }

            // Filtro de município
            if (PropriedadesState.filtros.municipio && prop.municipio !== PropriedadesState.filtros.municipio) {
                return false;
            }

            // Filtro de busca
            if (PropriedadesState.filtros.busca) {
                const busca = PropriedadesState.filtros.busca.toLowerCase();
                const nome = (prop.nome_propriedade || '').toLowerCase();
                const municipio = (prop.municipio || '').toLowerCase();
                const matricula = (prop.matricula || '').toLowerCase();

                return nome.includes(busca) || municipio.includes(busca) || matricula.includes(busca);
            }

            return true;
        });
    }

    // ========================================
    // PREENCHER FILTRO DE MUNICÍPIOS
    // ========================================

    function preencherFiltroMunicipios() {
        const select = document.getElementById('filtro-municipio-propriedade');
        if (!select) return;

        // Obter municípios únicos
        const municipios = [...new Set(PropriedadesState.propriedades.map(p => p.municipio).filter(m => m))];
        municipios.sort();

        // Limpar e preencher
        select.innerHTML = '<option value="">Todos municípios</option>';
        municipios.forEach(municipio => {
            const option = document.createElement('option');
            option.value = municipio;
            option.textContent = municipio;
            select.appendChild(option);
        });
    }

    // ========================================
    // ATUALIZAR FILTROS
    // ========================================

    function filtrarPropriedades() {
        const inputBusca = document.getElementById('busca-propriedade');
        const selectTipo = document.getElementById('filtro-tipo-propriedade');
        const selectMunicipio = document.getElementById('filtro-municipio-propriedade');

        PropriedadesState.filtros.busca = inputBusca ? inputBusca.value : '';
        PropriedadesState.filtros.tipo = selectTipo ? selectTipo.value : '';
        PropriedadesState.filtros.municipio = selectMunicipio ? selectMunicipio.value : '';

        renderizarPropriedades();
    }

    function limparFiltrosPropriedades() {
        PropriedadesState.filtros = { busca: '', tipo: '', municipio: '' };

        const inputBusca = document.getElementById('busca-propriedade');
        const selectTipo = document.getElementById('filtro-tipo-propriedade');
        const selectMunicipio = document.getElementById('filtro-municipio-propriedade');

        if (inputBusca) inputBusca.value = '';
        if (selectTipo) selectTipo.value = '';
        if (selectMunicipio) selectMunicipio.value = '';

        renderizarPropriedades();
    }

    // ========================================
    // CRIAR PROPRIEDADE
    // ========================================

    function abrirModalNovaPropriedade() {
        // Resetar formulário
        const form = document.getElementById('form-nova-propriedade');
        if (form) form.reset();

        // Carregar clientes no select (se existir API de clientes)
        carregarClientesSelectProp('nova-prop-cliente');

        abrirModal('modal-nova-propriedade');
    }

    async function salvarNovaPropriedade(event) {
        event.preventDefault();

        const form = document.getElementById('form-nova-propriedade');
        const formData = new FormData(form);

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const propriedade = {
            cliente_id: formData.get('cliente_id') || null,
            nome_propriedade: formData.get('nome_propriedade'),
            matricula: formData.get('matricula') || null,
            tipo: formData.get('tipo'),
            municipio: formData.get('municipio'),
            comarca: formData.get('comarca') || null,
            uf: formData.get('uf'),
            area_m2: formData.get('area_m2') ? parseFloat(formData.get('area_m2')) : null,
            perimetro_m: formData.get('perimetro_m') ? parseFloat(formData.get('perimetro_m')) : null,
            observacoes: formData.get('observacoes') || null
        };

        console.log('📤 Criando propriedade:', propriedade);

        const btn = form.querySelector('button[type="submit"]');
        const btnOriginalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin" style="width: 18px; height: 18px;"></i> Salvando...';
        lucide.createIcons();

        try {
            const response = await fetch('http://localhost:3001/api/propriedades', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(propriedade)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Erro ao criar propriedade');
            }

            console.log('✅ Propriedade criada');

            mostrarToast('success', 'Propriedade criada!', `${propriedade.nome_propriedade} foi adicionada com sucesso.`);

            fecharModal('modal-nova-propriedade');
            form.reset();

            await carregarPropriedades();

        } catch (error) {
            console.error('❌ Erro ao criar propriedade:', error);
            mostrarToast('error', 'Erro ao criar', error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = btnOriginalHTML;
            lucide.createIcons();
        }
    }

    // ========================================
    // EDITAR PROPRIEDADE
    // ========================================

    function abrirModalEditarPropriedade(propriedadeId) {
        const propriedade = PropriedadesState.propriedades.find(p => p.id === propriedadeId);

        if (!propriedade) {
            mostrarToast('error', 'Erro', 'Propriedade não encontrada');
            return;
        }

        PropriedadesState.propriedadeEmEdicao = propriedade;

        // Preencher formulário
        const form = document.getElementById('form-editar-propriedade');
        document.getElementById('editar-prop-id').value = propriedade.id;
        document.getElementById('editar-prop-nome').value = propriedade.nome_propriedade || '';
        document.getElementById('editar-prop-matricula').value = propriedade.matricula || '';
        document.getElementById('editar-prop-tipo').value = propriedade.tipo || '';
        document.getElementById('editar-prop-municipio').value = propriedade.municipio || '';
        document.getElementById('editar-prop-comarca').value = propriedade.comarca || '';
        document.getElementById('editar-prop-uf').value = propriedade.uf || 'PR';
        document.getElementById('editar-prop-area').value = propriedade.area_m2 || '';
        document.getElementById('editar-prop-perimetro').value = propriedade.perimetro_m || '';
        document.getElementById('editar-prop-observacoes').value = propriedade.observacoes || '';

        // Carregar clientes no select
        carregarClientesSelectProp('editar-prop-cliente', propriedade.cliente_id);

        abrirModal('modal-editar-propriedade');
    }

    async function salvarEdicaoPropriedade(event) {
        event.preventDefault();

        const form = document.getElementById('form-editar-propriedade');
        const formData = new FormData(form);
        const propriedadeId = document.getElementById('editar-prop-id').value;

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const propriedade = {
            cliente_id: formData.get('cliente_id') || null,
            nome_propriedade: formData.get('nome_propriedade'),
            matricula: formData.get('matricula') || null,
            tipo: formData.get('tipo'),
            municipio: formData.get('municipio'),
            comarca: formData.get('comarca') || null,
            uf: formData.get('uf'),
            area_m2: formData.get('area_m2') ? parseFloat(formData.get('area_m2')) : null,
            perimetro_m: formData.get('perimetro_m') ? parseFloat(formData.get('perimetro_m')) : null,
            observacoes: formData.get('observacoes') || null
        };

        console.log('📝 Atualizando propriedade:', propriedade);

        const btn = form.querySelector('button[type="submit"]');
        const btnOriginalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin" style="width: 18px; height: 18px;"></i> Salvando...';
        lucide.createIcons();

        try {
            const response = await fetch(`http://localhost:3001/api/propriedades/${propriedadeId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(propriedade)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Erro ao atualizar propriedade');
            }

            console.log('✅ Propriedade atualizada');

            mostrarToast('success', 'Propriedade atualizada!', 'Alterações salvas com sucesso.');

            fecharModal('modal-editar-propriedade');

            await carregarPropriedades();

        } catch (error) {
            console.error('❌ Erro ao atualizar propriedade:', error);
            mostrarToast('error', 'Erro ao atualizar', error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = btnOriginalHTML;
            lucide.createIcons();
        }
    }

    // ========================================
    // EXCLUIR PROPRIEDADE
    // ========================================

    function abrirModalExcluirPropriedade(propriedadeId) {
        const propriedade = PropriedadesState.propriedades.find(p => p.id === propriedadeId);

        if (!propriedade) {
            mostrarToast('error', 'Erro', 'Propriedade não encontrada');
            return;
        }

        PropriedadesState.propriedadeParaExcluir = propriedade;

        document.getElementById('excluir-prop-nome').textContent = propriedade.nome_propriedade || 'Sem nome';
        document.getElementById('excluir-prop-info').textContent =
            `Matrícula: ${propriedade.matricula || 'N/A'} • ${propriedade.municipio} - ${propriedade.uf || 'PR'}`;
        document.getElementById('excluir-prop-id').value = propriedade.id;

        abrirModal('modal-excluir-propriedade');
    }

    async function confirmarExclusaoPropriedade() {
        if (!PropriedadesState.propriedadeParaExcluir) return;

        const propriedadeId = PropriedadesState.propriedadeParaExcluir.id;
        const propriedadeNome = PropriedadesState.propriedadeParaExcluir.nome_propriedade;

        console.log('🗑️ Excluindo propriedade:', propriedadeId);

        try {
            const response = await fetch(`http://localhost:3001/api/propriedades/${propriedadeId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Erro ao excluir propriedade');
            }

            console.log('✅ Propriedade excluída');

            mostrarToast('success', 'Propriedade excluída', `${propriedadeNome} foi removida.`);

            fecharModal('modal-excluir-propriedade');

            await carregarPropriedades();

        } catch (error) {
            console.error('❌ Erro ao excluir propriedade:', error);
            mostrarToast('error', 'Erro ao excluir', error.message);
        }
    }

    // ========================================
    // VER DETALHES
    // ========================================

    function verDetalhesPropriedade(propriedadeId) {
        console.log('👁️ Ver detalhes da propriedade:', propriedadeId);
        // TODO: Implementar modal de detalhes ou navegar para página específica
        mostrarToast('info', 'Em breve', 'Visualização detalhada será implementada em breve.');
    }

    // ========================================
    // MOSTRAR ERRO
    // ========================================

    function mostrarErroPropriedades(mensagem) {
        const container = document.getElementById('propriedades-grid');
        if (container) {
            container.style.display = 'grid';
            container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: var(--space-16);">
                    <i data-lucide="alert-triangle" style="width: 64px; height: 64px; color: #EF4444; margin: 0 auto var(--space-4);"></i>
                    <p style="color: #EF4444; font-size: var(--text-lg); font-weight: var(--weight-bold);">Erro ao carregar dados</p>
                    <p style="color: var(--text-secondary); font-size: var(--text-sm); margin-top: var(--space-2);">
                        ${mensagem}
                    </p>
                    <button class="btn btn-primary" onclick="carregarPropriedades()" style="margin-top: var(--space-4);">
                        <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                        Tentar Novamente
                    </button>
                </div>
            `;
            lucide.createIcons();
        }
    }

    // ========================================
    // CARREGAR CLIENTES NO SELECT
    // ========================================

    async function carregarClientesSelectProp(selectId, selectedId = null) {
        const select = document.getElementById(selectId);
        if (!select) return;

        try {
            const response = await fetch('http://localhost:3001/api/clientes');
            if (response.ok) {
                const data = await response.json();
                const clientes = data.data || [];

                select.innerHTML = '<option value="">Selecione o cliente (opcional)</option>';
                clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    if (selectedId && cliente.id == selectedId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.warn('⚠️ API de clientes não disponível:', error);
            select.innerHTML = '<option value="">Nenhum cliente</option>';
        }
    }

    // ========================================
    // CARREGAR QUANDO MUDAR PARA ABA
    // ========================================

    // Interceptar mudança de aba para carregar propriedades
    const originalMostrarAba = window.mostrarAba;
    if (originalMostrarAba) {
        window.mostrarAba = function(aba) {
            originalMostrarAba(aba);

            if (aba === 'propriedades' && !PropriedadesState.propriedadesLoaded) {
                carregarPropriedades();
            }
        };
    }

    console.log('✅ Sistema de Propriedades inicializado');

    </script>

    <!-- Adicionar CSS adicional para detalhes dos erros -->
    <style>
    details summary {
        list-style: none;
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    details summary::before {
        content: '▶';
        display: inline-block;
        transition: transform var(--transition-fast);
    }

    details[open] summary::before {
        transform: rotate(90deg);
    }

    details summary:hover {
        color: var(--cogep-green);
    }

    /* Scrollbar para lista de erros */
    details div::-webkit-scrollbar {
        width: 6px;
    }

    details div::-webkit-scrollbar-track {
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
    }

    details div::-webkit-scrollbar-thumb {
        background: var(--border-secondary);
        border-radius: var(--radius-sm);
    }

    details div::-webkit-scrollbar-thumb:hover {
        background: var(--text-tertiary);
    }
    </style>

</body>
</html>
