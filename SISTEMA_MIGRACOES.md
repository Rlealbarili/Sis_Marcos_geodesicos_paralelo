# üöÄ Sistema de Migra√ß√µes - Documenta√ß√£o Completa

## üì¶ O Que Foi Criado

### 1. **Script Principal de Migra√ß√£o**
üìÑ `backend/migrate.js`
- Sistema completo de controle de vers√£o do banco
- Suporte a transa√ß√µes autom√°ticas
- Registro de hist√≥rico em `schema_migrations`
- Comandos: migrate, status, verify

### 2. **Migra√ß√£o Inicial**
üìÑ `backend/migrations/001_create_integrated_schema.sql`
- 4 novas tabelas (clientes, propriedades, vertices, memoriais_importados)
- 3 views √∫teis para consultas
- 4 triggers para automa√ß√£o
- √çndices para performance
- Dados de teste inclu√≠dos

### 3. **Scripts NPM**
üìÑ `package.json` (atualizado)
```bash
npm run migrate          # Aplicar migra√ß√µes
npm run migrate:status   # Ver status
npm run migrate:verify   # Verificar banco
```

### 4. **Documenta√ß√£o Completa**
- üìÑ `backend/migrations/README.md` - Guia completo de migra√ß√µes
- üìÑ `backend/migrations/QUICK_START.md` - Guia r√°pido
- üìÑ `backend/migrations/EXAMPLES.sql` - 50+ exemplos de queries
- üìÑ `backend/MIGRATE_GUIDE.md` - Guia detalhado do script
- üìÑ `SISTEMA_MIGRACOES.md` - Este documento

### 5. **Scripts Auxiliares**
- üìÑ `backend/migrations/run-migration.js` - Executar migra√ß√£o com backup
- üìÑ `backend/test-migrate.js` - Testar sistema de migra√ß√µes

### 6. **Configura√ß√£o**
- üìÑ `.gitignore` (atualizado) - Ignora backups e arquivos tempor√°rios

---

## üéØ Estrutura do Banco de Dados

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    BANCO DE DADOS                        ‚îÇ
‚îÇ                 sistema-marcos-geodesicos                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    clientes     ‚îÇ  üë• Propriet√°rios
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id              ‚îÇ
‚îÇ nome            ‚îÇ
‚îÇ cpf_cnpj        ‚îÇ
‚îÇ telefone        ‚îÇ
‚îÇ email           ‚îÇ
‚îÇ endereco        ‚îÇ
‚îÇ cidade          ‚îÇ
‚îÇ estado          ‚îÇ
‚îÇ observacoes     ‚îÇ
‚îÇ created_at      ‚îÇ
‚îÇ updated_at      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚îÇ 1:N
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  propriedades   ‚îÇ  üèòÔ∏è Terrenos/Im√≥veis
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id              ‚îÇ
‚îÇ cliente_id      ‚îÇ ‚îÄ‚îÄ‚îê
‚îÇ nome_propriedade‚îÇ   ‚îÇ
‚îÇ matricula       ‚îÇ   ‚îÇ
‚îÇ tipo            ‚îÇ   ‚îÇ
‚îÇ municipio       ‚îÇ   ‚îÇ
‚îÇ comarca         ‚îÇ   ‚îÇ
‚îÇ uf              ‚îÇ   ‚îÇ
‚îÇ area_m2         ‚îÇ   ‚îÇ
‚îÇ area_hectares   ‚îÇ   ‚îÇ (calculado automaticamente)
‚îÇ perimetro_m     ‚îÇ   ‚îÇ
‚îÇ memorial_json   ‚îÇ   ‚îÇ
‚îÇ status          ‚îÇ   ‚îÇ
‚îÇ created_at      ‚îÇ   ‚îÇ
‚îÇ updated_at      ‚îÇ   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
        ‚îÇ             ‚îÇ
        ‚îÇ 1:N         ‚îÇ 1:N
        ‚ñº             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    vertices     ‚îÇ ‚îÇ memoriais_importados  ‚îÇ üìù Hist√≥rico
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id              ‚îÇ ‚îÇ id                    ‚îÇ
‚îÇ propriedade_id  ‚îÇ ‚îÇ propriedade_id        ‚îÇ
‚îÇ nome            ‚îÇ ‚îÇ arquivo_nome          ‚îÇ
‚îÇ ordem           ‚îÇ ‚îÇ arquivo_tamanho       ‚îÇ
‚îÇ latitude        ‚îÇ ‚îÇ vertices_extraidos    ‚îÇ
‚îÇ longitude       ‚îÇ ‚îÇ metadados_extraidos   ‚îÇ
‚îÇ utm_e           ‚îÇ ‚îÇ taxa_sucesso          ‚îÇ
‚îÇ utm_n           ‚îÇ ‚îÇ status                ‚îÇ
‚îÇ utm_zona        ‚îÇ ‚îÇ resultado_json        ‚îÇ
‚îÇ datum           ‚îÇ ‚îÇ usuario               ‚îÇ
‚îÇ azimute         ‚îÇ ‚îÇ data_importacao       ‚îÇ
‚îÇ distancia_m     ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ confrontante    ‚îÇ
‚îÇ tipo            ‚îÇ
‚îÇ created_at      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     marcos      ‚îÇ  üó∫Ô∏è Base geod√©sica (existente)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id              ‚îÇ
‚îÇ codigo          ‚îÇ
‚îÇ tipo            ‚îÇ
‚îÇ localizacao     ‚îÇ
‚îÇ coordenada_e    ‚îÇ
‚îÇ coordenada_n    ‚îÇ
‚îÇ ...             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ schema_migrations   ‚îÇ  üìã Controle de migra√ß√µes
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id                  ‚îÇ
‚îÇ version             ‚îÇ
‚îÇ name                ‚îÇ
‚îÇ applied_at          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üöÄ Como Usar

### Primeira Vez (Setup Inicial)

```bash
# 1. Instalar depend√™ncias (se ainda n√£o fez)
npm install

# 2. Verificar migra√ß√µes pendentes
npm run migrate:status

# 3. Aplicar migra√ß√µes
npm run migrate

# 4. Verificar resultado
npm run migrate:verify
```

### Comandos Dispon√≠veis

```bash
# Via NPM (recomendado)
npm run migrate          # Aplicar migra√ß√µes pendentes
npm run migrate:status   # Ver status das migra√ß√µes
npm run migrate:verify   # Verificar estrutura do banco

# Via Node diretamente
node backend/migrate.js migrate
node backend/migrate.js status
node backend/migrate.js verify

# Script com backup autom√°tico
node backend/migrations/run-migration.js

# Testar sistema
node backend/test-migrate.js
```

---

## üìä Views Dispon√≠veis

### 1. vw_propriedades_completas
Propriedades com todos os dados do cliente e contagem de v√©rtices.

```sql
SELECT * FROM vw_propriedades_completas WHERE municipio = 'Curitiba';
```

### 2. vw_estatisticas_clientes
Estat√≠sticas agregadas por cliente.

```sql
SELECT * FROM vw_estatisticas_clientes ORDER BY area_total_hectares DESC;
```

### 3. vw_historico_importacoes
Hist√≥rico completo de importa√ß√µes de memoriais.

```sql
SELECT * FROM vw_historico_importacoes WHERE status = 'PROCESSADO' LIMIT 10;
```

---

## ‚öôÔ∏è Triggers Autom√°ticos

### 1. update_clientes_timestamp
Atualiza `updated_at` automaticamente ao modificar cliente.

### 2. update_propriedades_timestamp
Atualiza `updated_at` automaticamente ao modificar propriedade.

### 3. calc_area_hectares_insert / calc_area_hectares_update
Calcula √°rea em hectares automaticamente quando √°rea em m¬≤ √© informada.

**Exemplo:**
```sql
INSERT INTO propriedades (cliente_id, matricula, area_m2, ...)
VALUES (1, 'MAT-123', 50000, ...);
-- area_hectares ser√° automaticamente 5.0 ha
```

---

## üß™ Valida√ß√£o

### Verificar tabelas criadas:
```bash
sqlite3 database/marcos.db "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;"
```

**Resultado esperado:**
```
clientes
log_correcoes
marcos
memoriais_importados
poligono_marcos
poligonos
propriedades
schema_migrations
vertices
```

### Verificar migra√ß√µes aplicadas:
```sql
SELECT * FROM schema_migrations;
```

### Contar registros de teste:
```sql
SELECT 'Clientes' as tabela, COUNT(*) as total FROM clientes
UNION ALL
SELECT 'Propriedades', COUNT(*) FROM propriedades
UNION ALL
SELECT 'V√©rtices', COUNT(*) FROM vertices
UNION ALL
SELECT 'Memoriais', COUNT(*) FROM memoriais_importados;
```

---

## üîß Integra√ß√£o com Backend

### Pr√≥ximos passos para integrar:

1. **Atualizar endpoint de importa√ß√£o**
```javascript
// Em backend/server.js
app.post('/api/importar-memorial-v2', async (req, res) => {
    // ... processamento existente ...

    // Salvar em memoriais_importados
    const memorial = db.prepare(`
        INSERT INTO memoriais_importados (
            propriedade_id, arquivo_nome, vertices_extraidos,
            resultado_json, usuario
        ) VALUES (?, ?, ?, ?, ?)
    `).run(
        propriedadeId,
        req.file.originalname,
        parsedData.vertices.length,
        JSON.stringify(parsedData),
        req.body.usuario
    );
});
```

2. **Criar endpoints REST para novas tabelas**
```javascript
// Listar propriedades
app.get('/api/propriedades', (req, res) => { ... });

// Detalhes de propriedade
app.get('/api/propriedades/:id', (req, res) => { ... });

// V√©rtices de uma propriedade
app.get('/api/propriedades/:id/vertices', (req, res) => { ... });

// Hist√≥rico de importa√ß√µes
app.get('/api/memoriais', (req, res) => { ... });
```

3. **Atualizar frontend**
- Adicionar tela de gest√£o de propriedades
- Visualizar v√©rtices no mapa
- Consultar hist√≥rico de importa√ß√µes

---

## üìö Documenta√ß√£o de Refer√™ncia

### Arquivos principais:
- `backend/MIGRATE_GUIDE.md` - Guia completo do sistema
- `backend/migrations/README.md` - Documenta√ß√£o das migra√ß√µes
- `backend/migrations/QUICK_START.md` - In√≠cio r√°pido
- `backend/migrations/EXAMPLES.sql` - Exemplos pr√°ticos

### Comandos √∫teis:
```bash
# Inspecionar banco manualmente
sqlite3 database/marcos.db

# Comandos SQLite √∫teis
.tables                  # Listar tabelas
.schema propriedades     # Ver estrutura de tabela
.exit                    # Sair
```

---

## üêõ Troubleshooting

### Problema: "UNIQUE constraint failed: schema_migrations.version"
**Solu√ß√£o:** Migra√ß√£o j√° foi aplicada, n√£o precisa reaplicar.

### Problema: Erro ao aplicar migra√ß√£o SQL
**Solu√ß√£o:** A transa√ß√£o faz rollback autom√°tico. Corrija o SQL e execute novamente.

### Problema: Migra√ß√µes fora de ordem
**Solu√ß√£o:** Renomear arquivos seguindo padr√£o `001_`, `002_`, etc.

---

## ‚úÖ Checklist de Valida√ß√£o

Ap√≥s executar as migra√ß√µes, verificar:

- [ ] Script executou sem erros
- [ ] Tabela `schema_migrations` foi criada
- [ ] 4 novas tabelas foram criadas
- [ ] 3 views foram criadas
- [ ] 4 triggers foram criados
- [ ] Dados de teste est√£o presentes
- [ ] Consultas nas views funcionam
- [ ] Triggers calculam automaticamente
- [ ] Sistema Node.js inicia sem erros

---

## üéâ Resultado Final

Voc√™ agora tem:

‚úÖ **Sistema de migra√ß√µes completo** com controle de vers√£o
‚úÖ **4 novas tabelas** integradas ao sistema
‚úÖ **3 views** para consultas simplificadas
‚úÖ **4 triggers** para automa√ß√£o
‚úÖ **Documenta√ß√£o completa** em m√∫ltiplos n√≠veis
‚úÖ **Scripts NPM** para facilitar uso
‚úÖ **Backup autom√°tico** em cada migra√ß√£o
‚úÖ **Exemplos pr√°ticos** de 50+ queries SQL

**Sistema pronto para evolu√ß√£o! üöÄ**

---

## üìû Pr√≥ximos Passos

1. ‚úÖ Executar primeira migra√ß√£o
2. ‚è≥ Criar endpoints REST para novas tabelas
3. ‚è≥ Atualizar frontend para usar novas features
4. ‚è≥ Implementar tela de gest√£o de propriedades
5. ‚è≥ Integrar importa√ß√£o de memorial com novas tabelas
6. ‚è≥ Criar relat√≥rios usando as views

---

**Documenta√ß√£o criada em:** 2025-10-13
**Vers√£o:** 1.0.0
**Sistema:** Marcos Geod√©sicos - COGEP
